<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.139.4"><title>Linux-Image auf Basis von i.MX6 RISC Prozessor für den Tagebau &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title>
<link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel=alternate type=application/rss+xml title="Holger Schurig's Computer Calisthenics & Orthodontia" href=../../index.xml><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beiträge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../categories/><i class='fa fa-folder fa-fw'></i>Categories</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div></div><div id=main><div class=header><h1>Linux-Image auf Basis von i.MX6 RISC Prozessor für den Tagebau</h1><h2></h2></div><div class=content><p>Wie man sich das zeitaufwändige Cross-Compilieren mit OpenEmbedded spart.</p><p>Oder: Implementierung eines Linux-Images für eine RISC-Platform für einen sehr
rauen Anwendungsfall.</p><div class="ox-hugo-toc toc"><div class=heading>Table of Contents</div><ul><li><a href=#projekt-info>Projekt-Info</a></li><li><a href=#projekt-background>Projekt-Background</a></li><li><a href=#komponentenauswahl>Komponentenauswahl</a></li><li><a href=#board-bringup>Board-Bringup</a></li><li><a href=#images>Images</a><ul><li><a href=#basis-image-multistrap-statt-debootstrap>Basis-Image: multistrap statt Debootstrap</a></li><li><a href=#wie-man--nicht--cross-compiliert>Wie man (nicht) cross-compiliert</a></li><li><a href=#kunden-images>Kunden-Images</a></li></ul></li><li><a href=#linux-kernel>Linux-Kernel</a></li><li><a href=#kleinere-tools>Kleinere Tools</a></li><li><a href=#projekt-tracking>Projekt-Tracking</a></li><li><a href=#verwandte-projekte>Verwandte Projekte</a></li></ul></div><div class=job><p>In Beiträgen der Kategorie <a href=../../categories/job/>Job</a> trage ich Projekte zusammen, die ich im Rahmen
meiner beruflichen Karriere federführend durchgeführt habe. Ich gehe dabei mit
Absicht nicht allzu sehr auf Details an: die Interessen meiner Arbeitgeber sollen
ja nicht berührt werden.</p></div><h2 id=projekt-info>Projekt-Info</h2><p>Idee: Kundenanforderung</p><p>Umsetzung: Barebox, Linux und Image: ich</p><p>Nutzung: US-amerikanischer Minenausrüster</p><p>Implementierung: Make, Bash, Python, Meson, C, C++, Qt, Git, Emacs, qemu-user-static</p><h2 id=projekt-background>Projekt-Background</h2><p>Ein US-amerikanischer Ausrüster von Minen (in Deutschland z.B. bei Kali & Salz)
hat spezielle Terminals von uns genutzt &mdash; diese Terminals sind besonders
Robust und halten auch starken und dauerhaften Erschütterungen stand.</p><figure><img src=./ahs.jpg></figure><p>Auf dem Foto sieht der Truck ganz klein aus &mdash; tatsächlich ist aber ein Rad
schon höher als ein Mensch. In diesem Video wird das Projekt vorgestellt:
<a href=https://youtu.be/6Nw7q0t2A9o>https://youtu.be/6Nw7q0t2A9o</a>. Wer aufpasst, kann zum Zeitstempel 0.37 einmal
kurz das Device sehen.</p><p>Der Kunde hatte auf ein Vorgängergerät WinCE eingesetzt &mdash; aber aufgrund massiver
Fehler in Windows CE, die Microsoft nie behob, war er mit der Software sehr unzufrieden.</p><p>Nun sollte auf Linux umgestellt werden, wobei ich den Kunden half. Allerdings
wurde auch eine neue Gerätegeneration entwickelt, um den geänderten
Anforderungen entsprechen zu können. Es wurde ein Gerät auf Basis des Freescale
(jetzt NXP) i.MX6Q erstellt, ein Quadcore ARM.</p><h2 id=komponentenauswahl>Komponentenauswahl</h2><p>Viele Hersteller von ICs behaupten &ldquo;Wir haben Linux-Support&rdquo;. Doch vor allem bei
asiatischen Lieferanten haben die dann einmalig vor 4 Jahren von irgendwem einen
Treiber entwickeln lassen, der dann auch nur mit einem seit 4 Jahren veralteten
Linux-Kernel funktioniert.</p><p>Deswegen habe ich schon beim Projektdesign die Hardware-Entwicklung beraten,
welche Chips oder Hersteller (Marvell und Broadcomm rücken kaum mit Infos raus!)
man meiden sollte.</p><h2 id=board-bringup>Board-Bringup</h2><p>Nachdem die ersten Prototypen PCBs da waren, ging es um den Board-Bringup.</p><p>Zunächst habe ich mit einem Freescale / NXP - Tool die Timing-Parameter des DRAM
herausgefunden. Der leitende Elektronikingenieur tat dasselbe &mdash; und wir hatten
komplett verschiedene Werte, die jeweils beim anderen nicht funktionierten. Dies
stellte sich als Fertigungsprobleme heraus, die dann behoben werden.</p><p>Als Bootloader hatte ich diesmal nicht u-boot, sondern <a href=https://www.barebox.org>Barebox</a> genommen. Der war
viel moderner programmiert, ähnlich wie der Linux-Kernel. Er hat sogar wie der
Linux-Kernel ein &ldquo;Kconfig&rdquo; System, das damals bei u-boot noch nicht existierte.
Auch hat er denselben Device-Tree genutzt, den ich dann auch für den
Linux-Kernel genommen habe.</p><h2 id=images>Images</h2><p>Das Image wurde mit einem ähnlichen System erstellt wie im Artikel
<a href=../../de/combined-linux/>Combined-Linux: ein Image für viele Geräte </a>beschrieben. Also <strong>nicht</strong> mit <a href=../../de/openembedded/>OpenEmbedded </a>. Das
führte zu einer erheblichen Zeitersparnis.</p><p>Das lag daran, das es keinerlei Cross-Compilation gab.</p><p>Doch wie geht das, wenn der Entwicklerrechner &ldquo;i386&rdquo; als Architektur hat, das
Zielsystem aber &ldquo;armhf&rdquo;?</p><p>Ganz einfach: mit der Hilfe von QEMU. Viele Leute kennen dieses Tool, normal
simuliert es komplette Rechner, also CPU, RAM, Flash, Devices. Aber es gibt auch
<a href=https://www.qemu.org/docs/master/user/main.html>qemu-user-static</a>. Dieses simuliert nur die CPU. Keinerlei Hardware &mldr; sämtliche
Aufrufe von Linux-Kernel-Funktionen wie &ldquo;<code>open()</code>&rdquo;, &ldquo;<code>read()</code>&rdquo; etc werden
stattdessen einfach an den Host-Kernel (also mein i386/amd64 -Kernel) übergeben.
Der führt das dann ganz normal aus.</p><p>Damit das klappt, nutzt man &ldquo;<code>binfmt-misc</code>&rdquo;. Das ist ein Subsystem des Kernels.
Wenn ein Executable ausgeführt wird, schaut er sich die ersten Bytes an,
vergleicht diese mit ihm vorher bekannt gemachten Signaturen und startet dann
das Binary halt nicht direkt, sondern über ein Hilfsprogramm.</p><h3 id=basis-image-multistrap-statt-debootstrap>Basis-Image: multistrap statt Debootstrap</h3><p>&mldr; oder besser: multistrap. Das war damals besser für fremde Architekturen
geeignet als debootstrap. Debootstrap selbst habe ich ja bereits
<a href=../../de/mkimage/#debootstrap>hier </a>beschrieben.</p><p>Also geht&rsquo;s hier mal um Multistap.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-9><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-10><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-11><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-12><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-13><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-14><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-15><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-16><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-17><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-18><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-19><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-20><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-21><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-22><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-23><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-24><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-25><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--f87743-26><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--f87743-26>26</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>image.base:
</span></span><span style=display:flex><span>    @test `id -u` = 0 || { echo &#34;\n---&gt; You need to run this as root\n&#34;; exit 1; }
</span></span><span style=display:flex><span>    @# Make ARM binaries runnable with the help of qemu-user-static
</span></span><span style=display:flex><span>    update-binfmts --enable
</span></span><span style=display:flex><span>    @# create new base image
</span></span><span style=display:flex><span>    rm -rf image.base
</span></span><span style=display:flex><span>    multistrap --dir image.base -f conf/multistrap.conf
</span></span><span style=display:flex><span>    @# Create device nodes
</span></span><span style=display:flex><span>    bin/device-table.pl -f $(PWD)/conf/multistrap.devices -d image.base
</span></span><span style=display:flex><span>    @# Somehow the dash postinst script doesnt run because of debconf trouble
</span></span><span style=display:flex><span>    rm -f image.base/var/lib/dpkg/info/dash.postinst
</span></span><span style=display:flex><span>    echo /bin/dash &gt;&gt;image.base/etc/shell
</span></span><span style=display:flex><span>    @# We dont want to have services run automatically
</span></span><span style=display:flex><span>    ln -sf /bin/true image.base/usr/sbin/invoke-rc.d
</span></span><span style=display:flex><span>    @# This makes the armhf dpkg binary be executable in the following chroot command
</span></span><span style=display:flex><span>    cp /usr/bin/qemu-arm-static image.base/usr/bin
</span></span><span style=display:flex><span>    @# Mount needed system directory
</span></span><span style=display:flex><span>    mount -o bind /proc image.base/proc
</span></span><span style=display:flex><span>    mount -o bind /sys image.base/sys
</span></span><span style=display:flex><span>    mount -o bind /dev/pts image.base/dev/pts
</span></span><span style=display:flex><span>    DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true \
</span></span><span style=display:flex><span>        LC_ALL=C LANGUAGE=C LANG=C \
</span></span><span style=display:flex><span>        chroot image.base dpkg --configure -a
</span></span><span style=display:flex><span>    umount image.base/proc
</span></span><span style=display:flex><span>    umount image.base/sys
</span></span><span style=display:flex><span>    umount image.base/dev/pts
</span></span></code></pre></td></tr></table></div></div><p>Die Zeilen <a href=#org-coderef--f87743-4>4</a> und <a href=#org-coderef--f87743-16>16</a> sind hier die &ldquo;Secret Sauce&rdquo;. Zunächst müssen wir
ja dafür sorgen, das der Kernel &ldquo;armhf&rdquo; Binaries überhaupt ausführen kann &mdash; bei heutigen
Debian-Versionen wird &ldquo;<code>update-binfmts</code>&rdquo; übrigens schon beim Booten ausgeführt.</p><p>Dann müssen wir natürlich noch das &ldquo;<code>qemu-arm-static</code>&rdquo; Binary (ein i386 btw
amd64) Binary in das armhf-Image-Directory kopieren. Sonst wäre es ja nach dem
&ldquo;<code>chroot</code>&rdquo; nicht erreichbar. Es ist, wie der Name schon andeutet, statisch
kompiliert. Es lädt also keinerlei Libraries aus &ldquo;<code>/lib</code>&rdquo; bzw &ldquo;<code>/usr/lib</code>&rdquo;
nach&mldr; denn im &ldquo;<code>chroot</code>&rdquo; wären die ja von der falschen Architektur und könnten
sowieso nicht geladen werden.</p><p>Das besondere an &ldquo;<code>multistrap</code>&rdquo; war, das es alle Debian-Pakete zwar ausgepackt
hat, dann aber die viele Scripte &ldquo;<code>image.base/var/lib/dpkg/info/*.postinst</code>&rdquo;
<strong>nicht</strong> ausgeführt hat. Das hätte ja nicht geschehen können, da &ldquo;<code>multistrap</code>&rdquo;
ja selbst noch unter i386/amd64 lief. Die Scripte aber rufen oft Binaries wie
z.B. &ldquo;<code>addgroup</code>&rdquo; auf. Und in &ldquo;<code>image.base/</code>&rdquo; sind diese halt von der
Architektur &ldquo;<code>armhf</code>&rdquo;.</p><p>Die installierten Pakete sind also sozusagen noch nicht konfiguriert.</p><p>Deswegen wird in Zeile <a href=#org-coderef--f87743-21>21</a> das Konfigurieren nachgeholt: &ldquo;<code>dpkg --configure -a</code>&rdquo; wird mit Hilfe von &ldquo;<code>chroot</code>&rdquo; innerhalb von &ldquo;<code>image.base/</code>&rdquo; aufgerufen.
Dadurch werden alle &ldquo;<code>*.post</code>&rdquo; Scripte aufgerufen. Mittlerweile ist aber
&ldquo;<code>qemu-user-static</code>&rdquo; im Image verfügbar, und die Scripte können nach Herzenslust
&ldquo;armhf&rdquo; Binaries nutzen.</p><h3 id=wie-man--nicht--cross-compiliert>Wie man (nicht) cross-compiliert</h3><p>Will (oder muss) man dann aber doch compilieren, geht auch das sehr einfach.</p><p>Ich kann das Basis-Image von &ldquo;<code>image.base/</code>&rdquo; nach &ldquo;<code>image.dev</code>&rdquo; kopieren und
dann dort alles installieren, was ich so zum Compilieren brauche: gcc, make,
cmake, meson, ninja, diverse *-dev Libraries etc etc.</p><p>Und wenn ich dann mit &ldquo;<code>chroot</code>&rdquo; in dieses &ldquo;<code>image.dev</code>&rdquo; wechsle, kann ich
dort &ldquo;armhf&rdquo; Binaries direkt compilieren &mdash; obwohl mein Host eigentlich
&ldquo;i386&rdquo; oder &ldquo;amd64&rdquo; Architektur hat.</p><p>Das ist ein wenig langsamer als native zu compilieren. Denn der
&ldquo;<code>qemu-user-static</code>&rdquo; emuliert schließlich eine CPU, dadurch wird der komplette
Compilationsprozess ja emuliert.</p><p>Aber es ist immer noch schneller als mit OpenEmbedded, da man ja nicht erst ein
Staging-Directory mir &ldquo;armhf&rdquo;-Libraries bevölkern muss.</p><p>Hier ist ein Beispiel, wie ich &ldquo;<code>x11vnc</code>&rdquo; (nicht) cross-compiliert habe:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>VNC_VER=0.9.14
</span></span><span style=display:flex><span>VNC_TAR=x11vnc-$(VNC_VER)-dev.tar.gz
</span></span><span style=display:flex><span>PACKAGES += downloads/$(VNC_TAR)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>downloads/$(VNC_TAR):
</span></span><span style=display:flex><span>    wget -q -c -P downloads http://x11vnc.sourceforge.net/dev/$(VNC_TAR)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>image.dev/x11vnc-$(VNC_VER)/configure: downloads/$(VNC_TAR)
</span></span><span style=display:flex><span>    cd image.dev; tar xaf ../$&lt;
</span></span><span style=display:flex><span>    ln -sf ../../patches-x11vnc image.dev/x11vnc-$(VNC_VER)/patches
</span></span><span style=display:flex><span>    cd image.dev/x11vnc-$(VNC_VER); quilt push -a
</span></span><span style=display:flex><span>    touch --no-create $@
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>image.dev/x11vnc-$(VNC_VER)/Makefile: image.dev/x11vnc-$(VNC_VER)/configure
</span></span><span style=display:flex><span>    chroot image.dev dash -c &#34;cd x11vnc-$(VNC_VER); ./configure \
</span></span><span style=display:flex><span>        --prefix=/usr \
</span></span><span style=display:flex><span>        --without-ipv6 \
</span></span><span style=display:flex><span>        --without-v4l \
</span></span><span style=display:flex><span>        --without-fbdev \
</span></span><span style=display:flex><span>        --without-uinput \
</span></span><span style=display:flex><span>        --without-macosx-native \
</span></span><span style=display:flex><span>        --without-crypt \
</span></span><span style=display:flex><span>        --without-crypto \
</span></span><span style=display:flex><span>        --without-ssl \
</span></span><span style=display:flex><span>        --without-gnutls \
</span></span><span style=display:flex><span>        --without-client-tls&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>compvnc image.dev/x11vnc-$(VNC_VER)/x11vnc/x11vnc: image.dev/x11vnc-$(VNC_VER)/Makefile
</span></span><span style=display:flex><span>    chroot image.dev make -j4 -C x11vnc-$(VNC_VER)
</span></span><span style=display:flex><span>    chroot image.dev strip x11vnc-$(VNC_VER)/x11vnc/x11vnc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cleanvnc:
</span></span><span style=display:flex><span>    rm -rf image.dev/x11vnc-$(VNC_VER)
</span></span></code></pre></div><p>Mit obigen Makefile-Snippets reicht ein &ldquo;<code>make compvnc</code>&rdquo; aus, um &mldr;</p><ul><li>eine bestimme Version der x11vnc-Sourcen herunter zu laden werden (falls sie noch nicht da sind)</li><li>diesen Source auszupacken</li><li>mit lokalen Patches versehen (die ich also im eigenen GIT habe)</li><li>mit minimalen Konfigurationsoptionen zu konfigurieren</li><li>und dann alles zu compilieren</li></ul><p>Anschließend hat man in &ldquo;<code>image.dev/x11vnc/x11vnc</code>&rdquo; das Binary.</p><p>Ich kann aber in &ldquo;<code>image.dev</code>&rdquo; auch reguläre Debian-Pakete erzeugen, aber das
sprengt diesen Post.</p><h3 id=kunden-images>Kunden-Images</h3><p>Mit dem nur leicht abgewandelten im Post <a href=../../de/mkimage/>Automatische Image-Erstellung </a>wurden
dann im Laufe der Jahre drei Kunden-Images erstellt:</p><ul><li>eines mit Java (der Kunde hatte seine Anwendung in Java geschrieben)</li><li>eines mit Mono (eine andere Anwendung wurde in C# geschrieben)</li><li>eines komplett ohne X11 und GUI (für eine Version des Gerätes ohne Display)</li></ul><p>Je nachdem, welches Image ich (reproduzierbar) erstellt habe, dauerte dies 3 bis
6 Minuten.</p><h2 id=linux-kernel>Linux-Kernel</h2><p>Auch hier wurde ein Linux-Kernel &ldquo;dem Gerät auf den Leib geschneidert&rdquo;, also vom Source compiliert.</p><p>Netterweise hat sowohl Freescale als auch NXP (kaufen Freescale auf) mit der
Kernel-Community mitgearbeitet. Zwar hatten sie ihren eigenen Vendor-Kernel, wie
üblich hoffnungslos veraltet. Aber: sie brachten jeden Treiber &ldquo;upstream&rdquo; in den
offiziellen Linux-Kernel. Und dort haben dann die Subsysten-Maintainer immer ein Auge drauf
geworfen und teils drastische Verbesserungen erreicht.</p><p>Ich entschied mich also, einfach einen Kernel von <a href=https://kernel.org>https://kernel.org</a> zu
verwenden: alle vom Kunden i.mX6 Subsystem wurden von ihm unterstützt.</p><p>Eine Besonderheit gab es aber bei CAN-Bus: hier hatte der Kunde hohe Anforderungen. Und
der CAN-Treiber vom offiziellen Linux-Kernel fiel durch. Der CAN-Treiber des Vendor-Kernels
(der ziemlich anders aussah) &mldr; fiel auch durch. Hier habe ich mich dann in den Treiber
eingefuchst und habe dann einen Patch gemacht, der die sog. &ldquo;Mailboxes&rdquo; verwendet.</p><p>Nachdem der Kunde das getestet und für gut befunden hatte &mldr; hat der
Linux-CAN-Maintainer einen ähnliche Änderung im offiziellen Linux-Kernel
eingebracht. Die haben wir dann übernommen &mdash; was im Upstream-Kernel ist, wird
ja mit jeder Kernel-Version gepflegt. Was man &ldquo;out-of-tree&rdquo; hat, unterliegt
hingegen immer dem &ldquo;Bitrot&rdquo;. Man ist damit nie so zukunftssicher.</p><h2 id=kleinere-tools>Kleinere Tools</h2><ul><li>uccomm (von µC-Communication): sprach mit den Microcontroller auf der
Hauptplatine, um z.B. das Ein/Ausschaltverhalten zu steuern oder die Seriennummer
auszulesen</li><li>Tool zum Einstellen des Hardware-Watchdog</li><li>Tool zur Device-Discovery (eine proprietäre Kundenlösung, kein mDNS oder SSDP)</li><li>ubloxcomm: von u-Blox gibt es tolle Einstellungsprogramme für ihre Chips &mldr;
leider damals nur für Windows. Also habe ich ein Tool geschrieben, welches das
von der Kommandozeile machen konnte, da ich nichts vergleichbares gefunden in
der Open-Source-Community gefunden hatte. Die Besonderheit war, das ich
basierend auf eine Konfigurationsdatei beliebige Kommandos senden konnte &mdash;
auch für diesen Chip <a href=https://wiki.openstreetmap.org/wiki/U-blox_raw_format>undokumentierte</a>, die er aber anstandslos ausführte.
Dieser Auszug aus der Konfigurationsdatei ermöglicht die Kommandos &ldquo;<code>ubloxcomm sbas_on</code>&rdquo;, &ldquo;<code>ubloxcomm sbas_off</code>&rdquo; und &ldquo;<code>ubloxcomm sbas_poll</code>&rdquo;:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># Page 133: SBAS Configuration
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span>#          CFG-SBAS
</span></span><span style=display:flex><span>#          |    mode: bit 0 (mode) no longer supported, use CFG-GNSS. Bit 1 (use testbed) is ok
</span></span><span style=display:flex><span>#          |    |  usage: use SBAS GEOs as ranging source, differential corrections, integrity informat
</span></span><span style=display:flex><span>#          |    |  |  maxSBAS: no longer supported, use field in CFG-GNSS
</span></span><span style=display:flex><span>#          |    |  |  |  scanmode2, scanmode1: if all are zero then search for all SBAS PRNs
</span></span><span style=display:flex><span>sbas_on:   0616 01 07 03 00 00000000
</span></span><span style=display:flex><span>sbas_off:  0616 00 00 03 00 00000000
</span></span><span style=display:flex><span>sbas_poll: 0616
</span></span></code></pre></div><p>Die Zeilen könnten auch mehrfach mit gleichen Keyword auftauchen. Um z.B. den
NMEA-Output via &ldquo;<code>ubloxcomm nmea_off</code>&rdquo; abzustellen, hat die Konfigurationsdatei
dies vorgesehen:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># Page 107: Set Message Rate (for current port)
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span>#              CFG-MSG
</span></span><span style=display:flex><span>#              |    msgClass
</span></span><span style=display:flex><span>#              |    |  msgId
</span></span><span style=display:flex><span>#              |    |  |  rate for serial port
</span></span><span style=display:flex><span>#              |    |  |  |  rate for other ports
</span></span><span style=display:flex><span>nmea_off:      0601 f0 0a 00 00000000  # Datum Reference
</span></span><span style=display:flex><span>nmea_off:      0601 f0 09 00 00000000  # GNSS Satellite Fault Detection
</span></span><span style=display:flex><span>nmea_off:      0601 f0 00 00 00000000  # Global positioning system fix data
</span></span><span style=display:flex><span>nmea_off:      0601 f0 01 00 00000000  # Latitude and longitude
</span></span><span style=display:flex><span>nmea_off:      0601 f0 0d 00 00000000  # GNSS fix data
</span></span><span style=display:flex><span>nmea_off:      0601 f0 06 00 00000000  # GNSS Range Residuals
</span></span><span style=display:flex><span>nmea_off:      0601 f0 02 00 00000000  # Active Satellites
</span></span><span style=display:flex><span>nmea_off:      0601 f0 07 00 00000000  # GNSS Pseudo Range Error Statistics
</span></span><span style=display:flex><span>nmea_off:      0601 f0 03 00 00000000  # Satellites in view
</span></span><span style=display:flex><span>nmea_off:      0601 f0 04 00 00000000  # Recommended Minimum data
</span></span><span style=display:flex><span>nmea_off:      0601 f0 0f 00 00000000  # Dual ground/water distance
</span></span><span style=display:flex><span>nmea_off:      0601 f0 05 00 00000000  # Course over ground and Ground speed
</span></span><span style=display:flex><span>nmea_off:      0601 f0 08 00 00000000  # Time and Date
</span></span><span style=display:flex><span>nmea_off:      0601 f1 00 00 00000000  # Lat/Long Position Data
</span></span><span style=display:flex><span>nmea_off:      0601 f1 03 00 00000000  # Satellite Status
</span></span><span style=display:flex><span>nmea_off:      0601 f1 04 00 00000000  # Time of Day and Clock Information
</span></span></code></pre></div><p>Man kann aus diesen Auszügen auch sehe, das ich normalerweise immer gut
dokumentiere. Im Header der Datei steht exakt der Name und die Version des PDF,
auf die sich die Seitennummern beziehen.</p><h2 id=projekt-tracking>Projekt-Tracking</h2><p>Es gab eine umfangreiche &ldquo;Requirement Spec&rdquo; vom Kunden, die sich allerdings
recht häufig geändert hat. Der Grund war, das dem Kunden Linux neu war. Dinge
wie &ldquo;Priviledge Separation&rdquo; waren ihm beispielsweise unbekannt. Wenn ich eine
neue Spec bekam, habe ich das Word-Dokument immer mit der vorherigen Version
verglichen, die Änderungen festgestellt &mdash; diese Kunde hat die
Revisionshistorie nur unzureichend geführt &mdash;. Und dann habe ich manchmal
gedacht &ldquo;Also, so wie das gewünscht wird ist das nicht Best Practice&rdquo;.</p><p>In den wöchentlichen Telcos, oder manchmal zwischendurch per E-Mail, habe ich dann
Änderungesvorschläge gemacht und die Gründe erläutert. Nahezu immer wurde dies
dann berücksichtigt.</p><p>Um diese sich ändernden Anforderungen zu tracken habe ich das Kunden-Requirement
in eine eigene Emacs <a href=https://orgmode.org/>org-mode</a> Datei überführt.</p><p>Ich habe auch eigene Sub-Punkte mit hineingenommen &mdash; dem Kunden war es
beispielsweise egal, ob i2c im Bootloader geht oder nicht. Aber mir nicht, da
ich schon im Bootloader auf diverse i2c-Geräte zugreifen wollte. Also habe ich
dies dann mit einem eigenen TODO-Punkt versehen.</p><p>Org-mode kann man sich wie den Source eines Wiki vorstellen &mdash; man kann es also,
da es Text ist (im Gegensatz zu einer Word-Datei) mit in &ldquo;<code>git</code>&rdquo; aufnehmen. Im Editor
sieht das dann ungefähr so aus:</p><figure><img src=./org-mode.png></figure><p>(Dies ist übrigens ein Auszug aus den Anforderungen des Bootloaders. Beispielsweise
sollte er beim Booten piepsen, also musste er den &ldquo;Beeper&rdquo; unterstützen).</p><p>Ich habe das dann aber dem Kunden in HTML umgewandelt, dann sah es so aus:</p><figure><img src=./org-mode-html.png></figure><p>Man sieht in beiden Dokumenten, das da Links enthalten sind. Wenn man drauf klickt,
kommt man erklärt, wie man das Testen kann. Das hat der Kunde genutzt, um zu prüfen,
ob seine Anforderungen auch wirklich erfüllt sind:</p><figure><img src=./barebox-beeper.png></figure><p>So nebenbei hat dann der Kunde alles über Linux-Utilities wie &ldquo;<code>ifconfig</code>&rdquo;,
&ldquo;<code>candump</code>&rdquo; etc gelernt :-) Außerdem hat der Kunde den &ldquo;First-Level Support&rdquo;
selbst gemacht, also kaputte Geräte ausgetauscht und schonmal Fehlersuche
gemacht. Da war es natürlich hilfreich, (fast) alle Low-Level-Dinge dokumentiert
zu haben.</p><h2 id=verwandte-projekte>Verwandte Projekte</h2><p>Die folgenden Projekte sind mit diesem Projekt verwandt:</p><ul><li><a href=../../de/mkimage/>Automatische Image-Erstellung</a></li><li><a href=../../de/dynamischer-flashschutz/>Dynamischer Flash-Schutz</a></li></ul><div class=post-meta><div><i class="fa fa-copyright fa-fw"></i>
License: <a href=https://spdx.org/licenses/CC-BY-SA-4.0.html target=_blank>CC-BY-SA 4.0</a></div><div><i class="fa fa-calendar fa-fw"></i>
<time>2024-01-22</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=../../categories/job>job</a>
<a class=rss type=application/rss+xml href=../../categories/job/index.xml><span class="fa fa-rss">RSS</span></a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=../../tags/arm>arm</a>
<a class=rss type=application/rss+xml href=../../tags/arm/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/can>can</a>
<a class=rss type=application/rss+xml href=../../tags/can/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/embedded>embedded</a>
<a class=rss type=application/rss+xml href=../../tags/embedded/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/imx6>imx6</a>
<a class=rss type=application/rss+xml href=../../tags/imx6/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/linux>linux</a>
<a class=rss type=application/rss+xml href=../../tags/linux/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/openembedded>openembedded</a>
<a class=rss type=application/rss+xml href=../../tags/openembedded/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/qemu-user-static>qemu-user-static</a>
<a class=rss type=application/rss+xml href=../../tags/qemu-user-static/index.xml><span class="fa fa-rss">RSS</span></a></div></div></div></div></div><script src=../../js/ui.js></script><script src=../../js/menus.js></script><script src=../../js/math-code.js></script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>