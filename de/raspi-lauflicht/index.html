<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.108.0"><title>Lauflicht mit Raspberry und 74HC595 &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title><link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beiträge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../topics/><i class='fa fa-folder fa-fw'></i>Topics</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div><div><div class=small-print><small></small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div></div></div><div id=main><div class=header><h1>Lauflicht mit Raspberry und 74HC595</h1><h2></h2></div><div class=content><p>Bei dieser Schaltung geht es mir weniger darum, 8 LEDs zu betreiben.
Die kann man nämlich auch direkt am Raspberry Pi anschließen. Sondern
es geht darum, mit den Schieberegister 74HC595 zu experimentieren.</p><p>Dieses steuere ich zunächst durch diverse GPIO Ports an.</p><p>Und danach betreibe ich es am SPI-Port des RasPi. Das funktioniert
wunderbar, obwohl der Text &ldquo;SPI&rdquo; nirgendwo im 74HC595-Datenblatt
auftaucht :-)</p><h2 id=schaltung>Schaltung</h2><p>Die Schaltung ist einfach:</p><ul><li>der 74HC595 bekommt <code>VCC</code> und <code>GND</code>. Da es ein HC-Chip ist, kann er
anders als normale TTL-Bausteine direkt mit 3.3V betrieben
werden. Das ist wichtig, da der Raspberry Pi <strong>nicht</strong> 5V-tolerant
ist.</li><li><code>nOE</code> (negative Output Enable) geht an <code>GND</code>. Der &lsquo;595 halt also
immer ein Output Enable.</li><li><code>nMR</code> (Master Reclear) geht and <code>VCC</code>. Damit wird also der &lsquo;595 nie
zurückgesetzt.</li><li><code>SH_CP</code> (Shift Register Clock Pin) geht an das Signal <code>SPI0_SCLK</code>, also die
Clock des SPI0.</li><li><code>ST_CP</code> (Storage Register Clock Pin) geht <code>SPI0_CE0</code>, also an das Chip Enable 0
Signal des SPI0 Busses.</li><li><code>DS</code> (Data Serial Input) geht an das Signal <code>SPI0_MOSI</code>, also den seriellen
Ausgang von SPI0.</li></ul><p>Das war schon das ganze Interface zwischen &lsquo;595 und Raspberry.</p><p>Nach &ldquo;oben&rdquo; zu den LEDs haben wir 8 Ausgabe, <code>Q0</code> bis <code>Q7</code>. Der
Einfachheit halber habe ich nur zwei LEDs eingezeichnet.</p><p>Auch war ich sparsam: ich habe einfach nur einen passenden,
gemeinsamen Vorwiderstand von 220 Ohm eingebaut. Damit sind die LEDs
unterschiedlich hell wenn man mal mehr als eine LED anschaltet. Da es
mir aber darum ging, den &lsquo;595 und SPI zu verstehen, war mir das egal.
Ansonsten hätte ich eine Konstantstromquelle vorgesehen.</p><h2 id=verdrahtung>Verdrahtung</h2><p>Auch in die Verdrahtung habe ich nur 2 von 8 LEDs eingetragen.</p><h2 id=software-für-gpio>Software für GPIO</h2><p>Zunächst habe ich das ganze via GPIO, also per &ldquo;Big Banging&rdquo; betrieben. Das geht so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys<span style=color:#f92672>,</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SPEED <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.04</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> RPi.GPIO <span style=color:#66d9ef>as</span> GPIO
</span></span><span style=display:flex><span>GPIO<span style=color:#f92672>.</span>setmode(GPIO<span style=color:#f92672>.</span>BCM)
</span></span><span style=display:flex><span>GPIO<span style=color:#f92672>.</span>setwarnings(<span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Nebeneinander liegende GPIOs:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># DATA   = 22 # DS</span>
</span></span><span style=display:flex><span><span style=color:#75715e># LATCH  = 27 # STCP</span>
</span></span><span style=display:flex><span><span style=color:#75715e># CLOCK  = 17 # SHCP</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Die Pins von SPI0 nutzend, aber noch als GPIO benutzt:</span>
</span></span><span style=display:flex><span>DATA    <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span> <span style=color:#75715e># SPI0_MOSI</span>
</span></span><span style=display:flex><span>LATCH   <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>  <span style=color:#75715e># SPI0 CS0</span>
</span></span><span style=display:flex><span>CLOCK   <span style=color:#f92672>=</span> <span style=color:#ae81ff>11</span> <span style=color:#75715e># SPI0 CLK</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>setup</span>():
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>setmode(GPIO<span style=color:#f92672>.</span>BCM)
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>cleanup()
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>setup(DATA,  GPIO<span style=color:#f92672>.</span>OUT)
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>setup(CLOCK, GPIO<span style=color:#f92672>.</span>OUT)
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>setup(LATCH, GPIO<span style=color:#f92672>.</span>OUT)
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>output(DATA,  <span style=color:#66d9ef>False</span>)  <span style=color:#75715e># Databit to be shifted into the register</span>
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>output(LATCH, <span style=color:#66d9ef>False</span>)  <span style=color:#75715e># Latch is used to output the saved data</span>
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>output(CLOCK, <span style=color:#66d9ef>False</span>)  <span style=color:#75715e># Used to shift the value of DATAIN to the register</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>shift</span>(dat):
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>output(DATA,  dat)
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>output(CLOCK, GPIO<span style=color:#f92672>.</span>HIGH)
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>output(CLOCK, GPIO<span style=color:#f92672>.</span>LOW)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>writeout</span>():
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>output(LATCH, GPIO<span style=color:#f92672>.</span>HIGH)
</span></span><span style=display:flex><span>	<span style=color:#75715e># time.sleep(icsleep)</span>
</span></span><span style=display:flex><span>	GPIO<span style=color:#f92672>.</span>output(LATCH, GPIO<span style=color:#f92672>.</span>LOW)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>shiftnum</span>(dat):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>8</span>):
</span></span><span style=display:flex><span>		shift(dat <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x80</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		dat <span style=color:#f92672>&lt;&lt;=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	writeout()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>setup()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_down</span>():
</span></span><span style=display:flex><span>	n <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x01</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> n <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x100</span>:
</span></span><span style=display:flex><span>		shiftnum(n)
</span></span><span style=display:flex><span>		time<span style=color:#f92672>.</span>sleep(SPEED)
</span></span><span style=display:flex><span>		n <span style=color:#f92672>&lt;&lt;=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_up</span>():
</span></span><span style=display:flex><span>	n <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x80</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> n:
</span></span><span style=display:flex><span>		shiftnum(n)
</span></span><span style=display:flex><span>		time<span style=color:#f92672>.</span>sleep(SPEED)
</span></span><span style=display:flex><span>		n <span style=color:#f92672>&gt;&gt;=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_pattern</span>(pattern, speed<span style=color:#f92672>=</span><span style=color:#ae81ff>0.08</span>):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> pattern:
</span></span><span style=display:flex><span>		shiftnum(n)
</span></span><span style=display:flex><span>		time<span style=color:#f92672>.</span>sleep(speed)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>		run_down()
</span></span><span style=display:flex><span>		run_up()
</span></span><span style=display:flex><span>		<span style=color:#75715e># run_pattern((</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 	0x80 | 0x04,</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 	0x40 | 0x08,</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 	0x20 | 0x10,</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 	0x10 | 0x20,</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 	0x08 | 0x40,</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 	0x04 | 0x80,</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 	0x02 | 0x01,</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 	0x01 | 0x02))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span> <span style=color:#a6e22e>KeyboardInterrupt</span>:
</span></span><span style=display:flex><span>	print
</span></span></code></pre></div><h2 id=software-für-spi>Software für SPI</h2><p>Aber am meisten hatte ich mich für SPI interessiert. Dieses Programm
erbrachte dann das gewünschte Ergebnis:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys<span style=color:#f92672>,</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> spidev
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>spi <span style=color:#f92672>=</span> spidev<span style=color:#f92672>.</span>SpiDev()
</span></span><span style=display:flex><span>spi<span style=color:#f92672>.</span>open(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)    <span style=color:#75715e># Port 0, Chip Select 0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>n <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>	spi<span style=color:#f92672>.</span>writebytes([n])
</span></span><span style=display:flex><span>	time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>0.04</span>)
</span></span><span style=display:flex><span>	n <span style=color:#f92672>&lt;&lt;=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x100</span>:
</span></span><span style=display:flex><span>	    n <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Funktionen wie <code>run_down</code>, <code>run_up</code> habe ich mir hier gespart, sie
funktionieren im Prinzip genauso wie beim GPIO-Beispiel.</p><p>Und, wie man sieht: die eigentliche Ausgabe in das Schieberegister ist
wesentlich einfacher.</p><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i>
<time>2016-03-06</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=../../topics/elektronik>Elektronik</a>
<a class=rss type=application/rss+xml href=../../topics/elektronik/index.xml><span class="fa fa-rss">RSS</span></a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=../../tags/raspi>RasPi</a>
<a class=rss type=application/rss+xml href=../../tags/raspi/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/74hc595>74HC595</a>
<a class=rss type=application/rss+xml href=../../tags/74hc595/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/gpio>GPIO</a>
<a class=rss type=application/rss+xml href=../../tags/gpio/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/spi>SPI</a>
<a class=rss type=application/rss+xml href=../../tags/spi/index.xml><span class="fa fa-rss">RSS</span></a></div></div></div></div></div><script src=../../js/ui.js></script>
<script src=../../js/menus.js></script></body></html>