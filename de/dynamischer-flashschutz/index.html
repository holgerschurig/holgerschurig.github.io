<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.121.2"><title>Dynamischer Flash-Schutz &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title>
<link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel=alternate type=application/rss+xml title="Holger Schurig's Computer Calisthenics & Orthodontia" href=../../index.xml><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beiträge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../categories/><i class='fa fa-folder fa-fw'></i>Categories</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div></div><div id=main><div class=header><h1>Dynamischer Flash-Schutz</h1><h2></h2></div><div class=content><p>Hier geht es darum, wie man den Flash-Speicher vor Wear-Out schützen kann,<br>ohne die Usability allzu sehr einzuschränken.<br></p><div class="ox-hugo-toc toc"><div class=heading>Table of Contents</div><ul><li><a href=#projekt-info>Projekt-Info</a></li><li><a href=#warum-muss-flash-gesch%C3%BCtzt-werden>Warum muss Flash geschützt werden?</a></li><li><a href=#l%C3%B6sungsans%C3%A4tze>Lösungsansätze</a><ul><li><a href=#losungsansatz-windows>Losungsansatz Windows</a></li><li><a href=#l%C3%B6sungsansatz-android>Lösungsansatz Android</a></li><li><a href=#l%C3%B6sungsansatz-combined-linux>Lösungsansatz &ldquo;Combined Linux&rdquo;</a></li></ul></li><li><a href=#flash-schutz-am-beispiel>Flash-Schutz am Beispiel</a><ul><li><a href=#lesevorgang>Lesevorgang</a></li><li><a href=#schreibvorgang>Schreibvorgang</a></li><li><a href=#flash-%C3%A4ndern>Flash ändern</a></li><li><a href=#debian-pakete-installieren-chroot>Debian-Pakete installieren / chroot</a></li></ul></li><li><a href=#verwandte-projekte>Verwandte Projekte</a></li></ul></div><div class=job><p>In Beiträgen der Kategorie <a href=../../categories/job/>Job</a> trage ich Projekte zusammen, die ich im Rahmen<br>meiner beruflichen Karriere federführend durchgeführt habe. Ich gehe dabei mit<br>Absicht nicht allzusehr auf Details an: die Interessen meiner Arbeitgeber sollen<br>ja nicht berührt werden.<br></p></div><h2 id=projekt-info>Projekt-Info</h2><p>Idee & Umsetzung: ich<br></p><p>Projektdauer: 2012 bis heute<br></p><p>Effizienzgewinn:<br></p><ul><li>das Filesystem bleibt auf den Kundengeräten über Jahre intakt<br></li><li>hebt die Kundenzufriedenheit deutlich &mdash; nichts ist frustiger als ein Kunde,<br>bei dem die auf Accord arbeitenden Mitarbeiter Zwangspausen haben weil man<br>erst die CFast-Karte wechseln muss<br></li><li>Ausbrechen aus dem Flash-Schutz jederzeit ohne Reboot möglich &mdash; wenn man<br>weiss, wie :-)<br></li></ul><h2 id=warum-muss-flash-geschützt-werden>Warum muss Flash geschützt werden?</h2><p>Flash hat generell eine begrenzte Anzahl von Schreibzyklen. <a href=https://de.wikipedia.org/wiki/Flash-Speicher#Vor-_und_Nachteile>Wikipedia</a><br>beispielsweise schreibt &ldquo;Bei übermäßiger Nichtbenutzung und bei qualitativ<br>minderwertigen Flash-Datenträgern könnte der Verlust elektrischer Ladung in den<br>Transistoren Daten in Sektoren beschädigen.&rdquo;.<br></p><p>Was aber ist eine &ldquo;übermäßige Nutzung&rdquo;? Das kann bereits das Log-File sein, in<br>das z.B. Java-Programmierer geradezu verliebt sind. Jede ausgegebene Zeile<br>erzeugt diese Aktionen auf Filesystem-Ebene:<br></p><ul><li>schreiben eines oder mehrere Datenblocks (wenn die Zeile eine Blockgrenze überschreitet)<br></li><li>Update des Directory-Eintrages (Filelänge, Zeitstempel letzter Zugriff)<br></li><li>u.U. Update des inode-Daten (wenn ein neuer Block alloziert werden muss)<br></li></ul><p>Über 365 Tage mal 8 Stunden Schicht &mldr; passiert da recht viel.<br></p><h2 id=lösungsansätze>Lösungsansätze</h2><h3 id=losungsansatz-windows>Losungsansatz Windows</h3><p>Windows selbst hatte damals keine Lösung.<br></p><p>Aber Windows Embedded hatte einen Modus, in dem man die Partition auf &ldquo;read-only&rdquo; setzen<br>konnte. Das bedeutete aber einen Reboot &mdash; was unter Windows Embedded 7 eine Ewigkeit dauerte.<br>Auch mußte die Applikation damit klarkommen.<br></p><p>Auch Windows EWF bedingte (idealerweise), das die Anwendung sich dessen bewusst ist.<br></p><p>In der Praxis sorgte dies dafür, das man ohne lange Wartezeiten keine Änderungen am Image<br>machen konnte, noch nicht mal die IP-Adresse war zu ändern.<br></p><h3 id=lösungsansatz-android>Lösungsansatz Android</h3><p>Unter Android gibt es viele, viele Partitionen. Oft über 20 oder 30. Einige<br>davon kann man als Systempartitionen ansehen: sie sind komplett read-only. Ein<br>Umschalten in den beschreibbaren Modus ist für Endkunden nicht vorgesehen -> man<br>ist dem Hersteller ausgeliefert.<br></p><p>Netterweise gibt es auch Partitionen, die beschreibbar sind. Dort wird ein Großteil<br>(aber nicht alles!) der Systemkonfiguration wie IP-Adresse abgespeichert.<br></p><p>Insbesondere die Update-Situation ist hier jedoch anzukreiden, eine Kopie dieses<br>Verfahrens wird nicht empfohlen.<br></p><h3 id=lösungsansatz-combined-linux>Lösungsansatz &ldquo;Combined Linux&rdquo;</h3><p>Unter Linux gibt es sog. &ldquo;Union Filesystems&rdquo;. Früher nur <a href=https://aufs.sourceforge.net/>AUFS</a> (Another Union<br>Filesystem), heute auch <a href=https://unionfs.filesystems.org/>UnionFS</a>.<br></p><p>Hierbei hat man zwei Partitionen, die übereinander gelegt werden. In die obere<br>Partition (das Flash) wird nie geschrieben, von dort wird nur gelesen. Darüber<br>gelegt ist eine RAM-Disk. Schreibvorgänge werden dorthin umgeleitet. Wird<br>gelesen, schaut AUFS zunächst in der RAM-Disk nach. Steht dort die Datei,<br>bekommt man sie auch. Steht sie dort noch nicht, wird sie aus dem Flash gelesen.<br>In der RAM-Disk passiert dabei nichts.<br></p><h2 id=flash-schutz-am-beispiel>Flash-Schutz am Beispiel</h2><h3 id=lesevorgang>Lesevorgang</h3><p>Nehmen wir mal ein Programm, welches den Nameserver wissen will &mdash; unter Linux übernimmt<br>das normalerweise die GNU C Library, sie liest &ldquo;<code>/etc/resolv.conf</code>&rdquo;. Was passiert bei einem<br>frisch gebooteten System?<br></p><p>Beim Flash ist ein Default-Nameserver hinterlegt:<br></p><table><thead><tr><th>Ort</th><th>Datei</th><th>Inhalt bei Lesen</th></tr></thead><tbody><tr><td>Flash</td><td>/etc/resolv.conf</td><td>nameserver 4.4.4.4</td></tr><tr><td>RAM-Disk</td><td>&lt;existiert nicht></td><td>nameserver 4.4.4.4</td></tr></tbody></table><p>Wenn nun ein Programm auf &ldquo;<code>/etc/resolv.conf</code>&rdquo; zugreift, bekommt es den<br>4.4.4.4er Nameserver. Denn in der RAM-Disk existiert kein Eintrag.<br></p><h3 id=schreibvorgang>Schreibvorgang</h3><p>Nach dem Boot wird oft ein DHCP-Client gestartet. Er holt sich (u.A.) die<br>IP-Adresse und den Nameserver ab &mdash; in diesem Beispiel eine Adresse aus dem<br>172.16er Netzwerk. Der Nameserver wird dann nach &ldquo;<code>/etc/resolv.conf</code>&rdquo;<br>geschrieben.<br></p><p>Der Zustand ist nun so:<br></p><table><thead><tr><th>Ort</th><th>Datei</th><th>Inhalt bei Lesen</th></tr></thead><tbody><tr><td>Flash</td><td>/etc/resolv.conf</td><td>nameserver 4.4.4.4</td></tr><tr><td>RAM-Disk</td><td>/etc/resolv.conf</td><td>nameserver 172.16.1.1</td></tr></tbody></table><p>Wenn nun ein Programm auf &ldquo;<code>/etc/resolv.conf</code>&rdquo; zugreift, bekommt es den<br>172.16.1.1er Nameserver.<br></p><p>Das Flash wurde <strong>nicht</strong> geändert. Das bedeutet übrigens auch: wenn man nun das<br>Gerät aus- und wieder einschaltet (oder rebootet), dann sind sämtliche<br>Änderungen am Filesystem wieder vergessen.<br></p><h3 id=flash-ändern>Flash ändern</h3><p>Bei dem bisher beschriebenem System könnte man den Nameserver im Flash nie<br>ändern. Das ist ein wenig suboptimal: wenn der Kunde von DHCP auf statische<br>IP-Adressen umstellen wollte, hätter er Pech.<br></p><p>Allerdings habe ich oben ein wenig geschummelt und &mdash; der Didaktik wegen &mdash;<br>ein Detail ausgelassen: das Flash ist direkt per &ldquo;<code>/media/realroot</code>&rdquo; zu erreichen.<br>Eigentlich müsste der Zustand nach dem Booten also so aussehen:<br></p><table><thead><tr><th>Ort</th><th>Datei</th><th>Inhalt bei Lesen</th></tr></thead><tbody><tr><td>Flash</td><td>/media/realroot/etc/resolv.conf</td><td>nameserver 4.4.4.4</td></tr><tr><td>RAM-Disk</td><td>/etc/resolv.conf (existiert aber nicht)</td><td>nameserver 4.4.4.4</td></tr></tbody></table><p>Das Dateisystem-Root &ldquo;<code>/</code>&rdquo; ist Flash(ro)+RAM-Disk(rw).<br></p><p>Das &ldquo;echte Root&rdquo; (des Flash-Speichers) ist read-write erreichbar über &ldquo;<code>/media/realroot</code>&rdquo;.<br></p><p>Wenn wir nun auf statische IP-Adresse umstellen, ändern wir einfach statt<br>&ldquo;<code>/etc/resolv.conf</code>&rdquo; die Datei &ldquo;<code>/media/realroot/etc/resolv.conf</code>&rdquo;:<br></p><table><thead><tr><th>Ort</th><th>Datei</th><th>Inhalt bei Lesen</th></tr></thead><tbody><tr><td>Flash</td><td>/media/realroot/etc/resolv.conf</td><td>nameserver 192.168.1.200</td></tr><tr><td>RAM-Disk</td><td>/etc/resolv.conf (existiert aber nicht)</td><td>nameserver 192.168.1.200</td></tr></tbody></table><p>Dies wurde nun im Flash geändert, nicht in der RAM-Disk. Da dort aber kein<br>eigenes &ldquo;<code>/etc/resolv.conf</code>&rdquo; existiert, wird das vom Flash durchgereicht.<br></p><h3 id=debian-pakete-installieren-chroot>Debian-Pakete installieren / chroot</h3><p>Man kann sogar im &ldquo;echten&rdquo; Root jederzeit Debian-Pakete installieren. Dafür müssen<br>wir einfach nur per &ldquo;<code>chroot</code>&rdquo; dort hineinwechseln:<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>chroot /media/realroot
</span></span></code></pre></div><p>Da aber &ldquo;<code>dpkg</code>&rdquo; bzw. &ldquo;<code>apt-get</code>&rdquo; Zugriff auf Linux-Devicenodes und<br>-Pseudodateien brauchen, führen wir einfach ein Bind-Mount durch:<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mount -o bind /dev     /media/realroot/dev
</span></span><span style=display:flex><span>mount -o bind /dev/pts /media/realroot/dev/pts
</span></span><span style=display:flex><span>mount -o bind /sys     /media/realroot/sys
</span></span><span style=display:flex><span>mount -o bind /proc    /media/realroot/proc
</span></span><span style=display:flex><span>debian_chroot<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;REALROOT&#34;</span> chroot /media/realroot /bin/bash -i
</span></span><span style=display:flex><span>umount /media/realroot/proc
</span></span><span style=display:flex><span>umount /media/realroot/sys
</span></span><span style=display:flex><span>umount /media/realroot/dev/pts
</span></span><span style=display:flex><span>umount /media/realroot/dev
</span></span></code></pre></div><p>Ein Script names &ldquo;<code>in_realroot</code>&rdquo; erledigt das schnell und einfach :-)<br></p><h2 id=verwandte-projekte>Verwandte Projekte</h2><p>Die folgenden Projekte verwenden den Flash-Schutz bzw. gehen auf ihn ein:<br></p><ul><li><a href=../../de/combined-linux/>Combined-Linux: ein Image für viele Geräte</a><br></li><li>TODO(Artikel schreiben) GUI Konfiguration: config + configwriter<br></li><li>TODO(Artikel schreiben) Image-Verteilung mit SSDP-Agent<br></li><li>TODO(Artikel schreiben) Linux-Image auf Basis von i.MX& RISC Prozessor für den Tagebau<br></li><li>TODO(Artikel schreiben) Linux Restore Stick<br></li><li>TODO(Artikel schreiben) Hardware-Teststick für DLT-V83/DLT-V72<br></li><li>TODO(Artikel schreiben) Hardware-Teststick für DLT-V73<br></li><li>TODO(Artikel schreiben) Aufräumen in Fukushima</li></ul><div class=post-meta><div><i class="fa fa-copyright fa-fw"></i>
License: <a href=https://spdx.org/licenses/CC-BY-SA-4.0.html target=_blank>CC-BY-SA 4.0</a></div><div><i class="fa fa-calendar fa-fw"></i>
<time>2024-01-17</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=../../categories/job>job</a>
<a class=rss type=application/rss+xml href=../../categories/job/index.xml><span class="fa fa-rss">RSS</span></a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=../../tags/linux>linux</a>
<a class=rss type=application/rss+xml href=../../tags/linux/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/aufs>aufs</a>
<a class=rss type=application/rss+xml href=../../tags/aufs/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/chroot>chroot</a>
<a class=rss type=application/rss+xml href=../../tags/chroot/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/flash>flash</a>
<a class=rss type=application/rss+xml href=../../tags/flash/index.xml><span class="fa fa-rss">RSS</span></a></div></div></div></div></div><script src=../../js/ui.js></script><script src=../../js/menus.js></script></body></html>