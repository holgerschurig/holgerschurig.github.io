<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.121.2"><title>ATmega328 von Raspberry aus programmieren &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title>
<link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel=alternate type=application/rss+xml title="Holger Schurig's Computer Calisthenics & Orthodontia" href=../../index.xml><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beiträge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../categories/><i class='fa fa-folder fa-fw'></i>Categories</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div></div><div id=main><div class=header><h1>ATmega328 von Raspberry aus programmieren</h1><h2></h2></div><div class=content><p>Viele Leute kennen den ATmega von den Arduino-Projekten. Dort sind die
Prozessoren bereits mit einem sog. &lsquo;Bootloader&rsquo; versehen, man kann sie
also über deren serielle Schnittstelle programmieren.</p><p>Was aber, wenn man einen &ldquo;rohen&rdquo; ATmega hat, frisch vom
Elektronikladen? Und außerdem kein AVR-Programmiergerät? Dann nimmt
man eben des Raspberry zum Programmieren!</p><p>In der Zeitschrift &ldquo;Funkamateur 2/2016&rdquo; ist ein ähnlicher Artikel
enthalten. Aber der dort getriebene Aufwand ist wesentlich höher.
Beispielsweise wird ein Darlington-Array <code>ULN2803</code> gebraucht, und die
Programmierung erfolgt auch nicht (auf Raspberry-Seite) über SPI und
einem Standardprogramm, sondern über GPIOs und einem Python-Programm.</p><h2 id=schaltung>Schaltung</h2><p>Die Grundschaltung eines ATmega328 ist einfach:</p><ul><li><code>VCC</code> (Pin 7) mit 3.3V verbinden. Theoretisch sollte man noch <code>AVCC</code>
(Pin 20) mit 3.3V verbinden, zum Programmieren brauchte ich das aber
nicht.</li><li><code>GND</code> (Pin 8) mit Masse verbinden. Theoretisch sollte man auch noch das
andere <code>GND</code> (Pin 22) mit Masse verbinden. Bei mir war das aber zum
Programmieren nicht nötig.</li><li>ein Kondensator <code>C1</code> mit 100nF als Abblockkondensator nahe an Pins 7
und 8.</li><li>16 MHz-Quarz an Pins 9 und 10</li><li>von jedem Quarz-Pin ein 22pF Kondensator nach Masse führen</li><li><code>nRESET</code> über einen Pull-Up-Widerstand von 10 kOhm nach <code>VCC</code>. Später
merkte ich, das noch nicht mal der Pull-Up-Widerstand wirklich nötig
ist &mldr;</li></ul><p>Obige Grundschaltung findet man immer und immer wieder.</p><p>Nun wollen wir den ATmega jedoch programmieren, also müssen wir einige
Bahnen vom Raspberry zum ATmega ziehen:</p><ul><li>gelb: <code>GPIO25</code> nach <code>nRESET</code></li><li>cyan: <code>GPIO10</code>/<code>SPI0_MOSI</code> nach <code>D11</code>/<code>MOSI</code></li><li>lila: <code>GPIO9</code>/<code>SPI0_MISO</code> nach <code>D12</code>/<code>MISO</code></li><li>grün: <code>GPIO11</code>/<code>SPI_CLK</code> nach <code>D13</code>/<code>SCK</code></li></ul><p>Die erste (gelbe) Leitung ist zum Resetten des ATmega.</p><p>Die anderen drei Leitungen sind SPI-Leitungen, mit denen der Raspberry
den AVR programmieren kann.</p><h2 id=software>Software</h2><h3 id=avrdude-installieren>AVRdude installieren</h3><p>Auf dem Raspberry brauchen wir die Software <code>avrdude</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>pi</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>raspberrypi</span>:<span style=color:#960050;background-color:#1e0010>~</span> <span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#a6e22e>sudo</span> <span style=color:#a6e22e>su</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>root</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>raspberrypi</span>:<span style=color:#f92672>/</span><span style=color:#a6e22e>home</span><span style=color:#f92672>/</span><span style=color:#a6e22e>pi</span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>apt</span><span style=color:#f92672>-</span><span style=color:#a6e22e>get</span> <span style=color:#a6e22e>install</span> <span style=color:#a6e22e>avrdude</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Reading</span> <span style=color:#f92672>package</span> <span style=color:#a6e22e>lists</span><span style=color:#f92672>...</span> <span style=color:#a6e22e>Done</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Building</span> <span style=color:#a6e22e>dependency</span> <span style=color:#a6e22e>tree</span>       
</span></span><span style=display:flex><span><span style=color:#a6e22e>Reading</span> <span style=color:#a6e22e>state</span> <span style=color:#a6e22e>information</span><span style=color:#f92672>...</span> <span style=color:#a6e22e>Done</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>The</span> <span style=color:#a6e22e>following</span> <span style=color:#a6e22e>extra</span> <span style=color:#a6e22e>packages</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>be</span> <span style=color:#a6e22e>installed</span>:
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>libftdi1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Suggested</span> <span style=color:#a6e22e>packages</span>:
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>avrdude</span><span style=color:#f92672>-</span><span style=color:#a6e22e>doc</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>The</span> <span style=color:#a6e22e>following</span> <span style=color:#a6e22e>NEW</span> <span style=color:#a6e22e>packages</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>be</span> <span style=color:#a6e22e>installed</span>:
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>avrdude</span> <span style=color:#a6e22e>libftdi1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#a6e22e>upgraded</span>, <span style=color:#ae81ff>2</span> <span style=color:#a6e22e>newly</span> <span style=color:#a6e22e>installed</span>, <span style=color:#ae81ff>0</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>remove</span> <span style=color:#a6e22e>and</span> <span style=color:#ae81ff>12</span> <span style=color:#a6e22e>not</span> <span style=color:#a6e22e>upgraded</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>Need</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>get</span> <span style=color:#ae81ff>260</span> <span style=color:#a6e22e>kB</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>archives</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>operation</span>, <span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>021</span> <span style=color:#a6e22e>kB</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>additional</span> <span style=color:#a6e22e>disk</span> <span style=color:#a6e22e>space</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>be</span> <span style=color:#a6e22e>used</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>Do</span> <span style=color:#a6e22e>you</span> <span style=color:#a6e22e>want</span> <span style=color:#a6e22e>to</span> <span style=color:#66d9ef>continue</span><span style=color:#960050;background-color:#1e0010>?</span> [<span style=color:#a6e22e>Y</span><span style=color:#f92672>/</span><span style=color:#a6e22e>n</span>] <span style=color:#a6e22e>y</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Get</span>:<span style=color:#ae81ff>1</span> <span style=color:#a6e22e>http</span>:<span style=color:#75715e>//archive.raspberrypi.org/debian/ jessie/main avrdude armhf 6.1-2+rpi1 [244 kB]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>Get</span>:<span style=color:#ae81ff>2</span> <span style=color:#a6e22e>http</span>:<span style=color:#75715e>//mirrordirector.raspbian.org/raspbian/ jessie/main libftdi1 armhf 0.20-2 [16.7 kB]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>Fetched</span> <span style=color:#ae81ff>260</span> <span style=color:#a6e22e>kB</span> <span style=color:#a6e22e>in</span> <span style=color:#ae81ff>1</span><span style=color:#a6e22e>s</span> (<span style=color:#ae81ff>182</span> <span style=color:#a6e22e>kB</span><span style=color:#f92672>/</span><span style=color:#a6e22e>s</span>)                              
</span></span><span style=display:flex><span><span style=color:#a6e22e>Selecting</span> <span style=color:#a6e22e>previously</span> <span style=color:#a6e22e>unselected</span> <span style=color:#f92672>package</span> <span style=color:#a6e22e>libftdi1</span>:<span style=color:#a6e22e>armhf</span>.
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>Reading</span> <span style=color:#a6e22e>database</span> <span style=color:#f92672>...</span> <span style=color:#ae81ff>126952</span> <span style=color:#a6e22e>files</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>directories</span> <span style=color:#a6e22e>currently</span> <span style=color:#a6e22e>installed</span>.)
</span></span><span style=display:flex><span><span style=color:#a6e22e>Preparing</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>unpack</span> <span style=color:#f92672>.../</span><span style=color:#a6e22e>libftdi1_0</span><span style=color:#ae81ff>.20</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2_</span><span style=color:#a6e22e>armhf</span>.<span style=color:#a6e22e>deb</span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Unpacking</span> <span style=color:#a6e22e>libftdi1</span>:<span style=color:#a6e22e>armhf</span> (<span style=color:#ae81ff>0.20</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Selecting</span> <span style=color:#a6e22e>previously</span> <span style=color:#a6e22e>unselected</span> <span style=color:#f92672>package</span> <span style=color:#a6e22e>avrdude</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>Preparing</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>unpack</span> <span style=color:#f92672>.../</span><span style=color:#a6e22e>avrdude_6</span><span style=color:#ae81ff>.1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#f92672>+</span><span style=color:#a6e22e>rpi1_armhf</span>.<span style=color:#a6e22e>deb</span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Unpacking</span> <span style=color:#a6e22e>avrdude</span> (<span style=color:#ae81ff>6.1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#f92672>+</span><span style=color:#a6e22e>rpi1</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Processing</span> <span style=color:#a6e22e>triggers</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>man</span><span style=color:#f92672>-</span><span style=color:#a6e22e>db</span> (<span style=color:#ae81ff>2.7.0.2</span><span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Setting</span> <span style=color:#a6e22e>up</span> <span style=color:#a6e22e>libftdi1</span>:<span style=color:#a6e22e>armhf</span> (<span style=color:#ae81ff>0.20</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Setting</span> <span style=color:#a6e22e>up</span> <span style=color:#a6e22e>avrdude</span> (<span style=color:#ae81ff>6.1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#f92672>+</span><span style=color:#a6e22e>rpi1</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Processing</span> <span style=color:#a6e22e>triggers</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>libc</span><span style=color:#f92672>-</span><span style=color:#a6e22e>bin</span> (<span style=color:#ae81ff>2.19</span><span style=color:#f92672>-</span><span style=color:#ae81ff>18</span><span style=color:#f92672>+</span><span style=color:#a6e22e>deb8u3</span>) <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Ältere Tutorials reden davon, das man den AVRdude selbst compilieren
solle. Das ist aber mittlerweile nicht mehr nötig. Mein Raspberry
läuft Raspian 8.0, also basierend auf Debian Jessie. Und die
avrdude-Version <strong>6.1</strong> funktioniert einwandfrei.</p><h3 id=chip-erkennen>Chip erkennen</h3><p>Hat man alles richtig verdrahtet, sollte der Chip erkannt werden:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>root@raspberrypi:~# avrdude -c linuxspi -p m328p -P /dev/spidev0.0 
</span></span><span style=display:flex><span>avrdude: AVR device initialized and ready to accept instructions
</span></span><span style=display:flex><span>Reading | ################################################## | 100% 0.00s
</span></span><span style=display:flex><span>avrdude: Device signature = 0x1e950f
</span></span><span style=display:flex><span>avrdude: safemode: Fuses OK (E:07, H:D9, L:62)
</span></span><span style=display:flex><span>avrdude done.  Thank you.
</span></span></code></pre></div><p>Die Device-Signatur 0x1e950f steht für den ATmega328<strong>P</strong>, also exakt
für den Chip, den ich mir gekauft hatte.</p><p>Sollte kein <code>/dev/spidev0.0</code> vorhanden sein, muss <code>raspi-config</code>
starten und unter &ldquo;Advanced Options&rdquo; SPI aktivieren.</p><h3 id=takt-senken>Takt senken</h3><p>Bei mir ging es danach aber dennoch noch nicht. Erst als ich den
SPI-Takt von 400 kHz auf 200 kHz gesenkt hatte, lief es. Das ist zwar
deutlich langsamer als vorher, aber immer noch schneller als mit
GPIO-&ldquo;Bitbanging&rdquo;.</p><p>Dazu in <code>/etc/avrdude.conf</code> den Eintrag <code>linuxspi</code> so ändern:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>programmer
</span></span><span style=display:flex><span>  id = &#34;linuxspi&#34;;
</span></span><span style=display:flex><span>  desc = &#34;Use Linux SPI device in /dev/spidev*&#34;;
</span></span><span style=display:flex><span>  type = &#34;linuxspi&#34;;
</span></span><span style=display:flex><span>  reset = 25;
</span></span><span style=display:flex><span>  baudrate=200000;
</span></span><span style=display:flex><span>;
</span></span></code></pre></div><p>Nun hat&rsquo;s funktioniert. Ich vermute, das meine Kabel vom Raspberry zum
Breadboard mit dem ATmega zu lang waren.</p><div class=post-meta><div><i class="fa fa-copyright fa-fw"></i>
License: <a href=https://spdx.org/licenses/CC-BY-SA-4.0.html target=_blank>CC-BY-SA 4.0</a></div><div><i class="fa fa-calendar fa-fw"></i>
<time>2016-03-28</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=../../categories/elektronik>Elektronik</a>
<a class=rss type=application/rss+xml href=../../categories/elektronik/index.xml><span class="fa fa-rss">RSS</span></a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=../../tags/raspi>RasPi</a>
<a class=rss type=application/rss+xml href=../../tags/raspi/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/arduino>Arduino</a>
<a class=rss type=application/rss+xml href=../../tags/arduino/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/atmega>ATmega</a>
<a class=rss type=application/rss+xml href=../../tags/atmega/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/spi>SPI</a>
<a class=rss type=application/rss+xml href=../../tags/spi/index.xml><span class="fa fa-rss">RSS</span></a></div></div></div></div></div><script src=../../js/ui.js></script><script src=../../js/menus.js></script><script src=../../js/math-code.js></script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>