<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.121.2"><title>Automatische Image-Erstellung &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title>
<link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel=alternate type=application/rss+xml title="Holger Schurig's Computer Calisthenics & Orthodontia" href=../../index.xml><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beiträge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../categories/><i class='fa fa-folder fa-fw'></i>Categories</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div></div><div id=main><div class=header><h1>Automatische Image-Erstellung</h1><h2></h2></div><div class=content><p>System um Linux-Images automatisch zu erstellen (einfacher und schneller als
OpenEmbedded, Puppet, Ansible etc).</p><div class="ox-hugo-toc toc"><div class=heading>Table of Contents</div><ul><li><a href=#projekt-info>Projekt-Info</a></li><li><a href=#anforderungen>Anforderungen</a></li><li><a href=#vorgehensweise>Vorgehensweise</a><ul><li><a href=#debootstrap>debootstrap</a><ul><li><a href=#erw%C3%A4hnenswert>Erwähnenswert</a></li><li><a href=#ergebnis>Ergebnis</a></li></ul></li><li><a href=#kernel-erstellung>Kernel-Erstellung</a><ul><li><a href=#kernel-source>Kernel-Source</a></li><li><a href=#kernel-konfiguration>Kernel-Konfiguration</a></li><li><a href=#externe-treiber>externe Treiber</a></li><li><a href=#erw%C3%A4hnenswert>Erwähnenswert</a></li></ul></li><li><a href=#systemd>systemd</a></li><li><a href=#wpasupplicant>wpasupplicant</a></li><li><a href=#pakete-konfigurationsdateien>Pakete, Konfigurationsdateien</a><ul><li><a href=#erw%C3%A4hnenswert>Erwähnenswert</a></li><li><a href=#ergebnis>Ergebnis</a></li></ul></li></ul></li><li><a href=#verwandte-projekte>Verwandte Projekte</a></li></ul></div><div class=job><p>In Beiträgen der Kategorie <a href=../../categories/job/>Job</a> trage ich Projekte zusammen, die ich im Rahmen
meiner beruflichen Karriere federführend durchgeführt habe. Ich gehe dabei mit
Absicht nicht allzusehr auf Details an: die Interessen meiner Arbeitgeber sollen
ja nicht berührt werden.</p></div><h2 id=projekt-info>Projekt-Info</h2><p>Idee & Umsetzung: ich</p><p>Nutzung: 2012 bis heute</p><p>Implementatierung: Make, Bash, Python</p><p>Effizienzgewinn:</p><ul><li>jeder Änderung via &ldquo;git log&rdquo; / &ldquo;git blame&rdquo; verifizierbar</li><li>Directory-basierte Images lassen sich per &ldquo;<code>rsync</code>&rdquo; in Sekundenschnelle auf
Geräte übertragen und testen</li><li>extrem schneller Image build (600 MB Image in 23 Sekunden) bedeutet einen
schnellen Turnaround bedeutet das neue Features schneller getestet werden können</li></ul><h2 id=anforderungen>Anforderungen</h2><ul><li>das Ergebnis sollte <strong>eine Standard-Distribution</strong> sein (hier: Debian), nicht etwas
spezielles wie beispielsweise bei TODO(Artikel schreiben) &ldquo;OpenEmbedded&rdquo;</li><li>die Image-Erstellung sollte ausgesprochen <strong>schnell</strong> gehen</li><li>Images sollten <strong>reproduzierbar</strong> sein</li><li><strong>geringe Komplexität</strong> (also deutlich einfach wie weiland
TODO(Artikel schreiben) &ldquo;OpenEmbedded&rdquo;</li><li><strong>keine Client/Server-Architektur</strong>: das Image soll in einem Verzeichnis gebaut werden</li><li><strong>keine Artefakte im Image</strong> vom eigentlichen Build-Prozesses &mdash; Kunden
mögen es nicht, wenn irgendwelche Daemons offene Ports haben (außer vielleich SSH).</li></ul><h2 id=vorgehensweise>Vorgehensweise</h2><figure><img src=mkimage.png></figure><h3 id=debootstrap>debootstrap<span class=org-target id=org-target--debootstrap></span></h3><p><a href=https://wiki.debian.org/de/Debootstrap>Debootstrap</a> erzeugt ein Debian-Basissystem in einem Unterverzeichnis. Es braucht
keine Installations-CD, sondern lediglich Zugriff auf die Debian-Repositories.</p><p>So ein Basissystem ist selbst nicht bootbar &mdash; man kann es aber schon z.B. in
Docker nutzen. Ich nutze es, um aus diesem minimalen Basis-System dann das
<a href>Combined-Linux </a>zu erstellen.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/d/mkimage$ time make debootstrap
</span></span><span style=display:flex><span>sudo make debootstrap
</span></span><span style=display:flex><span>rm -rf image.debootstrap.bookworm.amd64
</span></span><span style=display:flex><span>mkdir -p downloads/debootstrap.bookworm.amd64
</span></span><span style=display:flex><span>mkdir -p downloads/apt.bookworm.amd64
</span></span><span style=display:flex><span>eatmydata -- debootstrap \
</span></span><span style=display:flex><span>    --arch amd64 \
</span></span><span style=display:flex><span>    --variant=minbase \
</span></span><span style=display:flex><span>    --no-check-gpg \
</span></span><span style=display:flex><span>    --cache-dir=downloads/apt.bookworm.amd64 \
</span></span><span style=display:flex><span>    --exclude [weggelassen]... \
</span></span><span style=display:flex><span>    --include apt-utils,procps,xz-utils \
</span></span><span style=display:flex><span>	bookworm image.debootstrap.bookworm.amd64 https://deb.debian.org/debian/
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>touch --no-create image.debootstrap.bookworm.amd64/etc/debian_version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>real    0m27.615s
</span></span><span style=display:flex><span>user    0m0.034s
</span></span><span style=display:flex><span>sys     0m0.036s
</span></span></code></pre></div><h4 id=erwähnenswert>Erwähnenswert</h4><ul><li><a href=https://www.flamingspork.com/projects/libeatmydata/>eatmydata</a> reduziert das excessive &ldquo;<code>fsync()</code>&rdquo; von &ldquo;<code>dpkg</code>&rdquo;. Das Filesystem
syncen ist gänzlich unnötig, wenn man sich das</li><li>ein Cache-Directory &ldquo;<code>downloads/apt.bookworm.amd64</code>&rdquo; schont die Debian-Server und erhöht die
Geschwindigkeit &mdash; dies ist einer der Bereich, die Docker bis heute nicht gut gelöst hat.</li><li>28 Sekunden ist ein durchaus netter Wert</li></ul><h4 id=ergebnis>Ergebnis</h4><p>Anschließend hat man eine Minimales Debian in einem Directory, welches man für</p><ul><li><a href>Combined-Linux</a></li><li>TODO(Artikel schreiben) Linux Restore Stick</li><li>TODO(Artikel schreiben) Teststick</li><li>TODO(Artikel schreiben) Teststick UEFI</li></ul><p>einsetzen kann.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/d/mkimage$ ls image.debootstrap.bookworm.amd64/
</span></span><span style=display:flex><span>bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
</span></span><span style=display:flex><span>~/d/mkimage$ sudo du -hs image.debootstrap.bookworm.amd64/
</span></span><span style=display:flex><span>182M	image.debootstrap.bookworm.amd64/
</span></span></code></pre></div><h3 id=kernel-erstellung>Kernel-Erstellung</h3><p>Auch die Erstellung des Kernels ist automatisiert. Möchte man diesen Schritt einzeln ausführen,
kann man jederzeit z.B.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/d/mkimage$ make cleankernel
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>~/d/mkimage$ time make -j8 compkernel
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>real	2m58.199s
</span></span><span style=display:flex><span>user	18m18.395s
</span></span><span style=display:flex><span>sys	2m40.577s
</span></span></code></pre></div><p>ausführen. Das ganze dauert also nur 3 Minuten.</p><h4 id=kernel-source>Kernel-Source</h4><p>Auf den Geräten läuft ein selbst-kompilierter Kernel, basierend auf
<a href=https://kernel.org>https://kernel.org</a>. Das liegt daran, das der Standard-Debian-Kernel eher für
Desktop- und Serverumgebungen gemacht ist, weniger für Embedded.</p><p>Also nehme ich jeweils einen aktuellen, stabilen Upstream-Kernel von <a href=https://kernel.org>kernel.org</a>,
füge AUFS für den <a href=../../de/dynamischer-flashschutz/>dynamischen Flash-Schutz </a>hinzu. Anschließend werden noch jede Menge Patches mit Hilfe von <a href=https://git.savannah.nongnu.org/cgit/quilt.git/tree/doc/README.in>quilt</a>
angewandt. Diesen haben oft diese Zwecke:</p><ul><li>Unterdrücken von harmlosen Kernel-Warnungen, die aber den Kunden beim Booten des
Images verunsichern würden</li><li>TODO Optimierungen des Linux mac80211 Layers und diverser WLAN-Treiber (z.B. Atheros)
zum besseren Roaming</li><li>Geschwindigkeitsoptimierungen für ein schnelleres Booten / Filesystem</li></ul><p>Die Kernel-Sourcen werden direkt von <a href=https://kernel.org>kernel.org</a> heruntergeladen und in
&ldquo;<code>downloads/</code>&rdquo; gecacht.</p><h4 id=kernel-konfiguration>Kernel-Konfiguration</h4><p>Neben den Patches gibt es auch noch in &ldquo;<code>*.kconfig</code>&rdquo; Files eine
Kernelkonfiguration. Die wichtigste ist natürlich &ldquo;<code>default.kconfig</code>&rdquo;. Sie macht
nur Dinge an, die wir brauchen. Ein Beispiel: Debian hat &ldquo;Hot CPU Swap&rdquo; an &ndash;
aber das wird bei Industrie-Geräten nie der Fall sein. Man müßte das Gerät
komplett zerlegen, um an die CPU zu kommen.</p><p>Neben der Default-Konfiguration gibt es noch für jedes unterstützte Gerät eine
&ldquo;<code>device-XXXX.kconfig</code>&rdquo; Datei, welches Treiber für dieses spezifische Gerät
aktiviert. Ein Beispiel:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>#00:02.0 VGA compatible controller [0300]: Intel Corporation Atom Processor Z36xxx/Z37xxx Series Graphics &amp; Display [8086:0f31] (rev 11)
</span></span><span style=display:flex><span>CONFIG_DRM_I915=m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#00:14.0 USB controller [0c03]: Intel Corporation Atom Processor Z36xxx/Z37xxx Series USB xHCI [8086:0f35] (rev 11)
</span></span><span style=display:flex><span>CONFIG_USB_XHCI_HCD=y
</span></span></code></pre></div><h4 id=externe-treiber>externe Treiber</h4><p>Es gibt (oder gab) noch diverse externen Kernel-Module, beispielsweise zur Hardware-Erkennung,
BIOS-Updates, Penmount-Treiber, diverse externe USB-Geräte.</p><h4 id=erwähnenswert>Erwähnenswert</h4><ul><li>die schnelle Kompilationszeit kommt daher, das viele Kernel-Subsysteme erst gar nicht
kompiliert werden. Warum sollte ein Image für die Industrie Treiber für Graphics-Tablets
oder DVB-S (Satelittenfernsehen) habe?</li></ul><h3 id=systemd>systemd</h3><p>Wir nutzen nicht den systemd des Debian-Projektes, denn dieser ist eher für
Rechenzentren gedacht. Er enthält viele Dinge, die man auf einem Embedded-Device
eher nicht braucht. Beispiele: quotacheck, importd, timedated, localed &mldr;</p><p>Außerdem werden viel mehr .deb Pakete erzeugt, insgesamt 54. Installiert werden davon
aber nur wenige. Die meisten werden nur vorgehalten, sollte ein Kunde das jemals brauchen.
Beispiele: rfkill, cgls, cgtop, kernelinstall, journal-gatwayd, journal-remote &mldr;</p><h3 id=wpasupplicant>wpasupplicant</h3><p>Wir compilieren auch unseren eigenen WPA-Supplicant, um das Roamingverhalten zu verbessern.
Sie dazu den Artikel</p><ul><li>TODO(Artikel schreiben) Schnelles WLAN-Roaming</li></ul><h3 id=pakete-konfigurationsdateien>Pakete, Konfigurationsdateien</h3><p>Nun ist es Zeit, das eigentliche Image zu erstellen. Dies geschieht mit diesen Komponenten:</p><ul><li>&ldquo;<code>bin/run</code>&rdquo; enthält viele Shell-Funktionen und kann Shell-Scriptlets sourcen</li><li>&ldquo;<code>base/*</code>&rdquo; enthält viele dieser Shell-Scriptlets, beispielsweise &ldquo;<code>base/kernel</code>&rdquo;
oder &ldquo;<code>base/tool-rsync</code>&rdquo; die jeweils eine Sache installieren bzw. konfigurieren</li><li>&ldquo;<code>conf/base-image.conf</code>&rdquo; definiert, welche von den &ldquo;<code>base/*</code>&rdquo; Scripten genutzt werden
sollen</li><li>&ldquo;<code>conf/base-config.imgconf</code>&rdquo; definiert, welches Debian wir verwenden (also beispielsweise
&ldquo;bookworm&rdquo; für die Architektur &ldquo;amd64&rdquo;)</li></ul><p>Lassen wir das doch einfach mal ablaufen:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-9><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-10><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-11><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-12><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-13><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-14><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-15><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-16><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-17><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-18><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-19><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-20><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-21><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-22><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-23><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-24><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-25><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-26><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-27><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-28><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-29><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-30><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-31><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-32><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-33><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-34><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b14937-35><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b14937-35>35</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ time make image
</span></span><span style=display:flex><span>make checkconfig
</span></span><span style=display:flex><span>make[1]: Entering directory &#39;/home/holger/d/mkimage&#39;
</span></span><span style=display:flex><span>make[1]: Leaving directory &#39;/home/holger/d/mkimage&#39;
</span></span><span style=display:flex><span>sudo make image CUST=&#34;&#34; IMAGE=image
</span></span><span style=display:flex><span>umount -f image/proc 2&gt;/dev/null
</span></span><span style=display:flex><span>make: [Makefile.image:36: image] Error 32 (ignored)
</span></span><span style=display:flex><span>umount -f image/sys 2&gt;/dev/null
</span></span><span style=display:flex><span>make: [Makefile.image:37: image] Error 32 (ignored)
</span></span><span style=display:flex><span>umount -f image/dev 2&gt;/dev/null
</span></span><span style=display:flex><span>make: [Makefile.image:38: image] Error 32 (ignored)
</span></span><span style=display:flex><span>rm -rf image
</span></span><span style=display:flex><span>bin/run
</span></span><span style=display:flex><span>Info : using conf/image.imgconf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>running base/image
</span></span><span style=display:flex><span>running base/eatmydata
</span></span><span style=display:flex><span>running base/firmware-radeon
</span></span><span style=display:flex><span>running base/firmware-realtek
</span></span><span style=display:flex><span>running base/kernel
</span></span><span style=display:flex><span>running base/systemd
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>running base/wireless
</span></span><span style=display:flex><span>-&gt; get ftp.de.debian.org/debian/pool/main/libn/libnl3/libnl-genl-3-200_3.7.0-0.2+b1_amd64.deb
</span></span><span style=display:flex><span>-&gt; get ftp.de.debian.org/debian/pool/main/libn/libnl3/libnl-3-200_3.7.0-0.2+b1_amd64.deb
</span></span><span style=display:flex><span>-&gt; get ftp.de.debian.org/debian/pool/main/libn/libnl3/libnl-route-3-200_3.7.0-0.2+b1_amd64.deb
</span></span><span style=display:flex><span>-&gt; get ftp.de.debian.org/debian/pool/main/p/pcsc-lite/libpcsclite1_1.9.9-2_amd64.deb
</span></span><span style=display:flex><span>running base/lib-x11
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>running base/rm
</span></span><span style=display:flex><span>finished !!!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>real    0m23.599s
</span></span><span style=display:flex><span>user    0m0.090s
</span></span><span style=display:flex><span>sys     0m0.019s
</span></span></code></pre></td></tr></table></div></div><ul><li>in Zeile <a href=#org-coderef--b14937-2>2</a> prüfen wir, ob z.B. in den in C++/Qt geschrieben
config-Tool noch Debugausgaben sind</li><li>Zeile <a href=#org-coderef--b14937-5>5</a> erkennt, das wir noch ein normaler User sind. Es wird dann
automatisch nach Root gewechselt.</li><li>Zeile <a href=#org-coderef--b14937-6>6</a> versucht, Mounts zu löschen. Diese können entstehen, wenn man
einen vorherigen &ldquo;<code>make image</code>&rdquo; mit Ctrl-C abbricht &ndash; dies lässt sich in
Makefiles nicht abfangen (die Bash könnte es).</li><li>Zeile <a href=#org-coderef--b14937-12>12</a> bedeutet, das wir mit ein vorheriges &ldquo;<code>image/</code>&rdquo; Directory
löschen. Dorthinein wird unser Image generiert. Das ist ähnlich wie oben bei
Debootstrap, das ein &ldquo;<code>image.debootstrap.bookworm.amd/</code>&rdquo; erstellt hatte.</li><li>Zeile <a href=#org-coderef--b14937-13>13</a> schließlich führt das &ldquo;<code>bin/run</code>&rdquo; Programm aus, welches rekursive
Scriptlets in &ldquo;<code>base/*</code>&rdquo; ausführen kann</li><li>das erste Scriptlet wird in Zeile <a href=#org-coderef--b14937-16>16</a> ausgeführt. Es legt ein frisches
&ldquo;<code>image/</code>&rdquo; Directory an und kopiert erstmal das Debootstrap-Image dort hinein.</li><li>danach werden viele weitere Scriptslets ausgeführt auf die ich nicht weiter
eingehe</li><li>die meisten Schritte hatten schon die nötigen Debian-Pakete im .deb Cache
("<code>downloads/deb.bookworm.amd64/</code>". Aber in Zeile <a href=#org-coderef--b14937-24>24</a> kann man sehen, das
noch fehlende Debian-Pakete automatisch heruntergeladen werden. Das erledigt
ein kleines Python-Script, &ldquo;<code>bin/get_deb.py</code>&rdquo;.</li><li>am Schluss wird es in Zeile <a href=#org-coderef--b14937-30>30</a> wieder etwas besonders: da wir Images für
Embedded Devices erstellen, können wir viele Dinge löschen. Beispiel: es ist sowas
kein &ldquo;<code>man</code>&rdquo; Binary installiert. Also kann man auch einfach alle Manpages löschen.</li></ul><h4 id=erwähnenswert>Erwähnenswert</h4><p>Wer jemals ein Docker-Image auf Debian-Basis erstellt hat, wird sich evtl die
Augen reiben: wie kann man ein Image in gerade mal 23 Sekunden bauen? Allein die
Docker-Zeile &ldquo;apt-get update; apt-get install foo bar baz; apt-get clean&rdquo;
braucht wesentlich länger?</p><p>Der Trick ist hier ist:</p><ul><li>einerseite die Installation von &ldquo;<code>eatmydata</code>&rdquo; ins Image hinein (siehe Zeile
<a href=#org-coderef--b14937-17>17</a> oben. Es wird dann beim Installieren von &ldquo;<code>.deb</code>"-Paketen kein
&ldquo;<code>fsync()</code>&rdquo; or &ldquo;<code>open(...,O_SYNC)</code>&rdquo; ausgeführt.</li><li>manuelles Dependency-Resolving. Hier in Beispiel: um BlueZ (den Linux-Bluetooth-Daemon)
zu installieren, braucht man vorher einige Libraries. Statt &ldquo;<code>apt</code>&rdquo; das herausfinden zu lassen,
finde ich es einmalig heraus und fordere die explizit. Die Datei &ldquo;<code>base/bluez</code>&rdquo; sieht dann z.B.
so aus:</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-9><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-10><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-11><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-12><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-13><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-14><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-15><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-16><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-17><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-18><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-19><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--2afbaf-20><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--2afbaf-20>20</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>need base/user
</span></span><span style=display:flex><span>need base/systemd
</span></span><span style=display:flex><span>need base/lib-glib
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>install_debian_deb bluez
</span></span><span style=display:flex><span>install_debian_deb libbluetooth3
</span></span><span style=display:flex><span>install_debian_deb libdw1
</span></span><span style=display:flex><span>install_debian_deb libasound2
</span></span><span style=display:flex><span>install_debian_deb libasound2-data
</span></span><span style=display:flex><span>install_debian_deb libreadline8
</span></span><span style=display:flex><span>install_debian_deb readline-common
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>do_run()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    mkdir -p ${IMAGE_DIR}/etc/systemd/system/bluetooth.service.d/
</span></span><span style=display:flex><span>    copy_file less-services.conf etc/systemd/system/bluetooth.service.d/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    in_image adduser --quiet dlog bluetooth &gt;/dev/null
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Das bedeutet im einzelnen:</p><ul><li>bevor &ldquo;<code>base/bluez</code>&rdquo; ausgeführt werden kann, muss (Zeile )) ein Standard-User
angelegt werden. Das liegt daran, das wir diesen User mit &ldquo;<code>addgroup</code>&rdquo; in die Gruppe
&ldquo;bluetooth=&rdquo; aufnehmen wollen (Zeile <a href=#org-coderef--2afbaf-19>19</a>).</li><li>dann brauchen wir noch systemd vorher im Image, da wir ein Drop-In Konfigurationsfile
reintun, welches Teile des Debian-BlueZ-Unit überschriebt (Zeile <a href=#org-coderef--2afbaf-16>16</a>).</li><li>BlueZ braucht wie viele andere Programm die glib. Statt also alle .deb unten
anzuführen, die glib installieren, habe ich das in ein eigenes
&ldquo;<code>base/lib-glib</code>&rdquo; ausgelagert (Zeile <a href=#org-coderef--2afbaf-3>3</a>).</li><li>&ldquo;<code>need</code>&rdquo; ist übrigens eine Shell-Funktion, definiert in &ldquo;<code>bin/run</code>&rdquo;. Dasselbe gilt
für &ldquo;<code>install_debian_deb</code>&rdquo; und &ldquo;<code>in_image</code>&rdquo;.</li><li>nun wird BlueZ selbst in Zeile <a href=#org-coderef--2afbaf-5>5</a> und alle benötigten Libraries installiert
(Zeilen <a href=#org-coderef--2afbaf-6>6</a> bis <a href=#org-coderef--2afbaf-11>11</a>).</li><li>Wenn alle Debian-Pakete installiert sind, wird die Funktion &ldquo;<code>do_run</code>&rdquo; in
Zeile <a href=#org-coderef--2afbaf-13>13</a> aufgerufen. Sie kann beliebige Programme aufrufen, einmal
außerhalb des neu erstellten Images, aber auch innerhalb mit Hilfe von
&ldquo;<code>in_image</code>&rdquo;. Außerdem sind diverse Environment-Variablen wie &ldquo;<code>$RUN_HOME</code>&rdquo;,
&ldquo;<code>$IMAGE_DIR</code>&rdquo; und &ldquo;<code>$DATA_DIR</code>&rdquo; definiert.</li></ul><h4 id=ergebnis>Ergebnis</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/d/mkimage$ ls image
</span></span><span style=display:flex><span>bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
</span></span><span style=display:flex><span>~/d/mkimage$ sudo du -hs image
</span></span><span style=display:flex><span>639M	image
</span></span></code></pre></div><p>Diese Image kann nun mit &ldquo;<code>cd image; tar cvzf ../combined-linux.tar.xz .</code>&rdquo; eingepackt werden. Dieses
File würde man dann auf einen TODO(Artikel schreiben) &ldquo;Linux Restore Stick&rdquo; kopieren und damit
Geräte initialisieren.</p><p>Man kann es auch mir &ldquo;<code>rsync</code>&rdquo; direkt per Ethernet oder WLAN auf ein Gerät
syncen &mdash; das ist erheblich schneller: nach wenigen Sekunden ist das neue
erstellte Image testbar.</p><h2 id=verwandte-projekte>Verwandte Projekte</h2><p>Die folgenden Projekte verwenden mkimage direkt oder ähnlich:</p><ul><li><a href=../../de/combined-linux/>Combined-Linux: ein Image für viele Geräte</a></li><li>TODO(Artikel schreiben) Linux-Image auf Basis von i.MX& RISC Prozessor für den Tagebau</li><li>TODO(Artikel schreiben) Linux Restore Stick</li><li><a href=../../de/hwtester/>Hardware-Teststick für DLT-V83/DLT-V72</a></li><li>TODO(Artikel schreiben) Hardware-Teststick für DLT-V73</li></ul><div class=post-meta><div><i class="fa fa-copyright fa-fw"></i>
License: <a href=https://spdx.org/licenses/CC-BY-SA-4.0.html target=_blank>CC-BY-SA 4.0</a></div><div><i class="fa fa-calendar fa-fw"></i>
<time>2024-01-17</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=../../categories/job>job</a>
<a class=rss type=application/rss+xml href=../../categories/job/index.xml><span class="fa fa-rss">RSS</span></a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=../../tags/linux>linux</a>
<a class=rss type=application/rss+xml href=../../tags/linux/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/kernel>kernel</a>
<a class=rss type=application/rss+xml href=../../tags/kernel/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/systemd>systemd</a>
<a class=rss type=application/rss+xml href=../../tags/systemd/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/make>make</a>
<a class=rss type=application/rss+xml href=../../tags/make/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/debian>debian</a>
<a class=rss type=application/rss+xml href=../../tags/debian/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/dpkg>dpkg</a>
<a class=rss type=application/rss+xml href=../../tags/dpkg/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/eatmydata>eatmydata</a>
<a class=rss type=application/rss+xml href=../../tags/eatmydata/index.xml><span class="fa fa-rss">RSS</span></a></div></div></div></div></div><script src=../../js/ui.js></script><script src=../../js/menus.js></script><script src=../../js/math-code.js></script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>