<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.123.7"><title>&#183; Holger Schurig's Computer Calisthenics & Orthodontia</title>
<link rel=stylesheet href=../../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../../css/blackburn.css><link rel=stylesheet href=../../../css/all.min.css><link rel=alternate type=application/rss+xml title="Holger Schurig's Computer Calisthenics & Orthodontia" href=../../../index.xml><link rel="shortcut icon" href=../../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../../de/><i class='fa fa-list fa-fw'></i>Beiträge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../../categories/><i class='fa fa-folder fa-fw'></i>Categories</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div></div><div id=main><div class=header><h1></h1><h2></h2></div><div class=content><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Automatische Image-Erstellung</h2><div id=outline-text-headline-1 class=outline-text-2><p>System um Linux-Images automatisch zu erstellen (einfacher und schneller als
OpenEmbedded, Puppet, Ansible etc).</p><nav><ul><li><a href=#headline-1>Automatische Image-Erstellung</a><ul><li><a href=#headline-2>Projekt-Info</a></li><li><a href=#headline-3>Anforderungen</a></li><li><a href=#headline-4>Vorgehensweise</a><ul><li><a href=#headline-5>debootstrap&lt;&lt;debootstrap>></a></li><li><a href=#headline-8>Kernel-Erstellung</a></li><li><a href=#headline-13>systemd</a></li><li><a href=#headline-14>wpasupplicant</a></li><li><a href=#headline-15>Pakete, Konfigurationsdateien</a></li></ul></li><li><a href=#headline-18>Verwandte Projekte</a></li></ul></li></ul></nav><div class=job-block><p>In Beiträgen der Kategorie <a href=../../../categories/job/>Job</a> trage ich Projekte zusammen, die ich im Rahmen
meiner beruflichen Karriere federführend durchgeführt habe. Ich gehe dabei mit
Absicht nicht allzu sehr auf Details an: die Interessen meiner Arbeitgeber sollen
ja nicht berührt werden.</p></div><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>Projekt-Info</h3><div id=outline-text-headline-2 class=outline-text-3><p>Idee & Umsetzung: ich</p><p>Nutzung: 2012 bis heute</p><p>Implementierung: Make, Bash, Python</p><p>Effizienzgewinn:</p><ul><li>jeder Änderung via "git log" / "git blame" verifizierbar</li><li>Directory-basierte Images lassen sich per "<code class=verbatim>rsync</code>" in Sekundenschnelle auf
Geräte übertragen und testen</li><li>extrem schneller Image build (600 MB Image in 23 Sekunden) bedeutet einen
schnellen Turnaround bedeutet das neue Features schneller getestet werden können</li></ul></div></div><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>Anforderungen</h3><div id=outline-text-headline-3 class=outline-text-3><ul><li>das Ergebnis sollte <strong>eine Standard-Distribution</strong> sein (hier: Debian), nicht etwas
spezielles wie beispielsweise bei TODO(Artikel schreiben) "OpenEmbedded"</li><li>die Image-Erstellung sollte ausgesprochen <strong>schnell</strong> gehen</li><li>Images sollten <strong>reproduzierbar</strong> sein</li><li><strong>geringe Komplexität</strong> (also deutlich einfach wie weiland
TODO(Artikel schreiben) "OpenEmbedded"</li><li><strong>keine Client/Server-Architektur</strong>: das Image soll in einem Verzeichnis gebaut werden</li><li><strong>keine Artefakte im Image</strong> vom eigentlichen Build-Prozesses — Kunden
mögen es nicht, wenn irgendwelche Daemons offene Ports haben (außer vielleicht SSH).</li></ul></div></div><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>Vorgehensweise</h3><div id=outline-text-headline-4 class=outline-text-3><div class="src src-dot"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>digraph G {
</span></span><span style=display:flex><span>        layout<span style=color:#f92672>=</span>fdp;
</span></span><span style=display:flex><span>        debootstrap [
</span></span><span style=display:flex><span>            pos<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.5,3!&#34;</span>
</span></span><span style=display:flex><span>            shape<span style=color:#f92672>=</span>cylinder
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        kernel [
</span></span><span style=display:flex><span>            pos<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;3,3!&#34;</span>
</span></span><span style=display:flex><span>            label<span style=color:#f92672>=&lt;&lt;</span>table border<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span> cellborder<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1&#34;</span> cellspacing<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span> cellpadding<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;4&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;</span>tr<span style=color:#f92672>&gt;&lt;</span>td<span style=color:#f92672>&gt;</span>linux<span style=color:#f92672>-</span><span style=color:#ae81ff>6.</span>x<span style=color:#f92672>.</span>tar<span style=color:#f92672>.</span>xz<span style=color:#f92672>&lt;/</span>td<span style=color:#f92672>&gt;&lt;/</span>tr<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;</span>tr<span style=color:#f92672>&gt;&lt;</span>td<span style=color:#f92672>&gt;</span>patch<span style=color:#f92672>-</span><span style=color:#ae81ff>6.</span>x<span style=color:#f92672>.</span>y<span style=color:#f92672>.</span>xz<span style=color:#f92672>&lt;/</span>td<span style=color:#f92672>&gt;&lt;/</span>tr<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;</span>tr<span style=color:#f92672>&gt;&lt;</span>td<span style=color:#f92672>&gt;*.</span>kconfig<span style=color:#f92672>&lt;/</span>td<span style=color:#f92672>&gt;&lt;/</span>tr<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;</span>tr<span style=color:#f92672>&gt;&lt;</span>td<span style=color:#f92672>&gt;*.</span>patch<span style=color:#f92672>&lt;/</span>td<span style=color:#f92672>&gt;&lt;/</span>tr<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/</span>table<span style=color:#f92672>&gt;&gt;</span>
</span></span><span style=display:flex><span>            shape<span style=color:#f92672>=</span>plain
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        debs [
</span></span><span style=display:flex><span>            pos<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;5.5,3!&#34;</span>
</span></span><span style=display:flex><span>            label<span style=color:#f92672>=&lt;&lt;</span>table border<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span> cellborder<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1&#34;</span> cellspacing<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span> cellpadding<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;4&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;</span>tr<span style=color:#f92672>&gt;&lt;</span>td<span style=color:#f92672>&gt;</span>Debian Pakete<span style=color:#f92672>&lt;/</span>td<span style=color:#f92672>&gt;&lt;/</span>tr<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;</span>tr<span style=color:#f92672>&gt;&lt;</span>td<span style=color:#f92672>&gt;</span>Konfigurationsdateien<span style=color:#f92672>&lt;/</span>td<span style=color:#f92672>&gt;&lt;/</span>tr<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/</span>table<span style=color:#f92672>&gt;&gt;</span>
</span></span><span style=display:flex><span>            shape<span style=color:#f92672>=</span>plain
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        config [
</span></span><span style=display:flex><span>            pos<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;7.5,3!&#34;</span>
</span></span><span style=display:flex><span>            shape<span style=color:#f92672>=</span>box
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        image [
</span></span><span style=display:flex><span>            pos<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;3,1!&#34;</span>
</span></span><span style=display:flex><span>            shape<span style=color:#f92672>=</span>cylinder
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        downloads [
</span></span><span style=display:flex><span>            pos<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;3,4.3!&#34;</span>
</span></span><span style=display:flex><span>            shape<span style=color:#f92672>=</span>ellipse
</span></span><span style=display:flex><span>            color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;#a0a0a0&#34;</span>
</span></span><span style=display:flex><span>            label<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;download Cache&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        cache [
</span></span><span style=display:flex><span>            pos<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;3,6!&#34;</span>
</span></span><span style=display:flex><span>            shape<span style=color:#f92672>=</span>ellipse
</span></span><span style=display:flex><span>            color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;#a0a0a0&#34;</span>
</span></span><span style=display:flex><span>            label<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.deb Cache&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        systemd [
</span></span><span style=display:flex><span>            pos<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;5.5,6!&#34;</span>
</span></span><span style=display:flex><span>            shape<span style=color:#f92672>=</span>box
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        wpa [
</span></span><span style=display:flex><span>            pos<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;5.5,5!&#34;</span>
</span></span><span style=display:flex><span>            shape<span style=color:#f92672>=</span>box
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        debootstrap <span style=color:#f92672>-&gt;</span> image;
</span></span><span style=display:flex><span>        kernel <span style=color:#f92672>-&gt;</span> image;
</span></span><span style=display:flex><span>        debs <span style=color:#f92672>-&gt;</span> image;
</span></span><span style=display:flex><span>        config <span style=color:#f92672>-&gt;</span> image;
</span></span><span style=display:flex><span>        systemd <span style=color:#f92672>-&gt;</span> cache;
</span></span><span style=display:flex><span>        wpa <span style=color:#f92672>-&gt;</span> cache;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        downloads <span style=color:#f92672>-&gt;</span> kernel   [dir<span style=color:#f92672>=</span>both, color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;#a0a0a0&#34;</span>];
</span></span><span style=display:flex><span>        cache <span style=color:#f92672>-&gt;</span> debs         [dir<span style=color:#f92672>=</span>both, color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;#a0a0a0&#34;</span>];
</span></span><span style=display:flex><span>        cache <span style=color:#f92672>-&gt;</span> debootstrap  [dir<span style=color:#f92672>=</span>both, color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;#a0a0a0&#34;</span>];
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p><img src=mkimage.png alt=mkimage.png title=mkimage.png></p><div id=outline-container-headline-5 class=outline-4><h4 id=headline-5>debootstrap&lt;&lt;debootstrap>></h4><div id=outline-text-headline-5 class=outline-text-4><p><a href=https://wiki.debian.org/de/Debootstrap>Debootstrap</a> erzeugt ein Debian-Basissystem in einem Unterverzeichnis. Es braucht
keine Installations-CD, sondern lediglich Zugriff auf die Debian-Repositories.</p><p>So ein Basissystem ist selbst nicht bootbar — man kann es aber schon z.B. in
Docker nutzen. Ich nutze es, um aus diesem minimalen Basis-System dann das
zu erstellen.</p><pre class=example>
~/d/mkimage$ time make debootstrap
sudo make debootstrap
rm -rf image.debootstrap.bookworm.amd64
mkdir -p downloads/debootstrap.bookworm.amd64
mkdir -p downloads/apt.bookworm.amd64
eatmydata -- debootstrap \
    --arch amd64 \
    --variant=minbase \
    --no-check-gpg \
    --cache-dir=downloads/apt.bookworm.amd64 \
    --exclude [weggelassen]... \
    --include apt-utils,procps,xz-utils \
	bookworm image.debootstrap.bookworm.amd64 https://deb.debian.org/debian/
...
touch --no-create image.debootstrap.bookworm.amd64/etc/debian_version

real    0m27.615s
user    0m0.034s
sys     0m0.036s
</pre><div id=outline-container-headline-6 class=outline-5><h5 id=headline-6>Erwähnenswert</h5><div id=outline-text-headline-6 class=outline-text-5><ul><li><a href=https://www.flamingspork.com/projects/libeatmydata/>eatmydata</a> reduziert das exzessive "<code class=verbatim>fsync()</code>" von "<code class=verbatim>dpkg</code>". Das Filesystem
syncen ist gänzlich unnötig, wenn man sich das</li><li>ein Cache-Directory "<code class=verbatim>downloads/apt.bookworm.amd64</code>" schont die Debian-Server und erhöht die
Geschwindigkeit — dies ist einer der Bereich, die Docker bis heute nicht gut gelöst hat.</li><li>28 Sekunden ist ein durchaus netter Wert</li></ul></div></div><div id=outline-container-headline-7 class=outline-5><h5 id=headline-7>Ergebnis</h5><div id=outline-text-headline-7 class=outline-text-5><p>Anschließend hat man eine minimales Debian in einem Directory, welches man für</p><ul><li></li><li>TODO(Artikel schreiben) Linux Restore Stick</li><li></li><li>TODO(Artikel schreiben) Teststick UEFI</li></ul><p>einsetzen kann.</p><pre class=example>
~/d/mkimage$ ls image.debootstrap.bookworm.amd64/
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
~/d/mkimage$ sudo du -hs image.debootstrap.bookworm.amd64/
182M	image.debootstrap.bookworm.amd64/
</pre></div></div></div></div><div id=outline-container-headline-8 class=outline-4><h4 id=headline-8>Kernel-Erstellung</h4><div id=outline-text-headline-8 class=outline-text-4><p>Auch die Erstellung des Kernels ist automatisiert. Möchte man diesen Schritt einzeln ausführen,
kann man jederzeit z.B.</p><pre class=example>
~/d/mkimage$ make cleankernel
...
~/d/mkimage$ time make -j8 compkernel
...
real	2m58.199s
user	18m18.395s
sys	2m40.577s
</pre><p>ausführen. Das ganze dauert also nur 3 Minuten.</p><div id=outline-container-headline-9 class=outline-5><h5 id=headline-9>Kernel-Source</h5><div id=outline-text-headline-9 class=outline-text-5><p>Auf den Geräten läuft ein selbst-kompilierter Kernel, basierend auf
<a href=https://kernel.org>https://kernel.org</a>. Das liegt daran, das der Standard-Debian-Kernel eher für
Desktop- und Serverumgebungen gemacht ist, weniger für Embedded.</p><p>Also nehme ich jeweils einen aktuellen, stabilen Upstream-Kernel von <a href=https://kernel.org>kernel.org</a>,
füge AUFS für den
hinzu. Anschließend werden noch jede Menge Patches mit Hilfe von <a href=https://git.savannah.nongnu.org/cgit/quilt.git/tree/doc/README.in>quilt</a>
angewandt. Diesen haben oft diese Zwecke:</p><ul><li>Unterdrücken von harmlosen Kernel-Warnungen, die aber den Kunden beim Booten des
Images verunsichern würden</li><li>TODO Optimierungen des Linux mac80211 Layers und diverser WLAN-Treiber (z.B. Atheros)
zum besseren Roaming</li><li>Geschwindigkeitsoptimierungen für ein schnelleres Booten / Filesystem</li></ul><p>Die Kernel-Sourcen werden direkt von <a href=https://kernel.org>kernel.org</a> heruntergeladen und in
"<code class=verbatim>downloads/</code>" gecacht.</p></div></div><div id=outline-container-headline-10 class=outline-5><h5 id=headline-10>Kernel-Konfiguration</h5><div id=outline-text-headline-10 class=outline-text-5><p>Neben den Patches gibt es auch noch in "<code class=verbatim>*.kconfig</code>" Files eine
Kernelkonfiguration. Die wichtigste ist natürlich "<code class=verbatim>default.kconfig</code>". Sie macht
nur Dinge an, die wir brauchen. Ein Beispiel: Debian hat "Hot CPU Swap" an –
aber das wird bei Industrie-Geräten nie der Fall sein. Man müßte das Gerät
komplett zerlegen, um an die CPU zu kommen.</p><p>Neben der Default-Konfiguration gibt es noch für jedes unterstützte Gerät eine
"<code class=verbatim>device-XXXX.kconfig</code>" Datei, welches Treiber für dieses spezifische Gerät
aktiviert. Ein Beispiel:</p><pre class=example>
#00:02.0 VGA compatible controller [0300]: Intel Corporation Atom Processor Z36xxx/Z37xxx Series Graphics &amp; Display [8086:0f31] (rev 11)
CONFIG_DRM_I915=m

#00:14.0 USB controller [0c03]: Intel Corporation Atom Processor Z36xxx/Z37xxx Series USB xHCI [8086:0f35] (rev 11)
CONFIG_USB_XHCI_HCD=y
</pre></div></div><div id=outline-container-headline-11 class=outline-5><h5 id=headline-11>externe Treiber</h5><div id=outline-text-headline-11 class=outline-text-5><p>Es gibt (oder gab) noch diverse externen Kernel-Module, beispielsweise zur Hardware-Erkennung,
BIOS-Updates, Penmount-Treiber, diverse externe USB-Geräte.</p></div></div><div id=outline-container-headline-12 class=outline-5><h5 id=headline-12>Erwähnenswert</h5><div id=outline-text-headline-12 class=outline-text-5><ul><li>die schnelle Kompilationszeit kommt daher, das viele Kernel-Subsysteme erst gar nicht
kompiliert werden. Warum sollte ein Image für die Industrie Treiber für Graphics-Tablets
oder DVB-S (Satelittenfernsehen) habe?</li></ul></div></div></div></div><div id=outline-container-headline-13 class=outline-4><h4 id=headline-13>systemd</h4><div id=outline-text-headline-13 class=outline-text-4><p>Wir nutzen nicht den systemd des Debian-Projektes, denn dieser ist eher für
Rechenzentren gedacht. Er enthält viele Dinge, die man auf einem Embedded-Device
eher nicht braucht. Beispiele: quotacheck, importd, timedated, localed …</p><p>Außerdem werden viel mehr .deb Pakete erzeugt, insgesamt 54. Installiert werden davon
aber nur wenige. Die meisten werden nur vorgehalten, sollte ein Kunde das jemals brauchen.
Beispiele: rfkill, cgls, cgtop, kernelinstall, journal-gatwayd, journal-remote …</p></div></div><div id=outline-container-headline-14 class=outline-4><h4 id=headline-14>wpasupplicant</h4><div id=outline-text-headline-14 class=outline-text-4><p>Wir compilieren auch unseren eigenen WPA-Supplicant, um das Roamingverhalten zu verbessern.
Sie dazu den Artikel</p><ul><li>TODO(Artikel schreiben) Schnelles WLAN-Roaming</li></ul></div></div><div id=outline-container-headline-15 class=outline-4><h4 id=headline-15>Pakete, Konfigurationsdateien</h4><div id=outline-text-headline-15 class=outline-text-4><p>Nun ist es Zeit, das eigentliche Image zu erstellen. Dies geschieht mit diesen Komponenten:</p><ul><li>"<code class=verbatim>bin/run</code>" enthält viele Shell-Funktionen und kann Shell-Scriptlets sourcen</li><li>"<code class=verbatim>base/*</code>" enthält viele dieser Shell-Scriptlets, beispielsweise "<code class=verbatim>base/kernel</code>"
oder "<code class=verbatim>base/tool-rsync</code>" die jeweils eine Sache installieren bzw. konfigurieren</li><li>"<code class=verbatim>conf/base-image.conf</code>" definiert, welche von den "<code class=verbatim>base/*</code>" Scripten genutzt werden
sollen</li><li>"<code class=verbatim>conf/base-config.imgconf</code>" definiert, welches Debian wir verwenden (also beispielsweise
"bookworm" für die Architektur "amd64")</li></ul><p>Lassen wir das doch einfach mal ablaufen:</p><pre class=example>
$ time make image
make checkconfig                                           (ref:checkconfig)
make[1]: Entering directory &#39;/home/holger/d/mkimage&#39;
make[1]: Leaving directory &#39;/home/holger/d/mkimage&#39;
sudo make image CUST=&#34;&#34; IMAGE=image                        (ref:sudo)
umount -f image/proc 2&gt;/dev/null                           (ref:umount)
make: [Makefile.image:36: image] Error 32 (ignored)
umount -f image/sys 2&gt;/dev/null
make: [Makefile.image:37: image] Error 32 (ignored)
umount -f image/dev 2&gt;/dev/null
make: [Makefile.image:38: image] Error 32 (ignored)
rm -rf image                                               (ref:rmimage)
bin/run                                                    (ref:run)
Info : using conf/image.imgconf

running base/image                                         (ref:runimage)
running base/eatmydata                                     (ref:eatmydata)
running base/firmware-radeon
running base/firmware-realtek
running base/kernel
running base/systemd
...
running base/wireless
-&gt; get ftp.de.debian.org/debian/pool/main/libn/libnl3/libnl-genl-3-200_3.7.0-0.2+b1_amd64.deb    (ref:deb)
-&gt; get ftp.de.debian.org/debian/pool/main/libn/libnl3/libnl-3-200_3.7.0-0.2+b1_amd64.deb
-&gt; get ftp.de.debian.org/debian/pool/main/libn/libnl3/libnl-route-3-200_3.7.0-0.2+b1_amd64.deb
-&gt; get ftp.de.debian.org/debian/pool/main/p/pcsc-lite/libpcsclite1_1.9.9-2_amd64.deb
running base/lib-x11
...
running base/rm                                           (ref:runrm)
finished !!!

real    0m23.599s
user    0m0.090s
sys     0m0.019s
</pre><ul><li>in Zeile <a href=(checkconfig)>(checkconfig)</a> prüfen wir, ob z.B. in den in C++/Qt geschrieben
config-Tool noch Debugausgaben sind</li><li>Zeile <a href=(sudo)>(sudo)</a> erkennt, das wir noch ein normaler User sind. Es wird dann
automatisch nach Root gewechselt.</li><li>Zeile <a href=(umount)>(umount)</a> versucht, Mounts zu löschen. Diese können entstehen, wenn man
einen vorherigen "<code class=verbatim>make image</code>" mit Ctrl-C abbricht – dies lässt sich in
Makefiles nicht abfangen (die Bash könnte es).</li><li>Zeile <a href=(rmimage)>(rmimage)</a> bedeutet, das wir mit ein vorheriges "<code class=verbatim>image/</code>" Directory
löschen. Dort hinein wird unser Image generiert. Das ist ähnlich wie oben bei
Debootstrap, das ein "<code class=verbatim>image.debootstrap.bookworm.amd/</code>" erstellt hatte.</li><li>Zeile <a href=(run)>(run)</a> schließlich führt das "<code class=verbatim>bin/run</code>" Programm aus, welches rekursive
Scriptlets in "<code class=verbatim>base/*</code>" ausführen kann</li><li>das erste Scriptlet wird in Zeile <a href=(runimage)>(runimage)</a> ausgeführt. Es legt ein frisches
"<code class=verbatim>image/</code>" Directory an und kopiert erst mal das Debootstrap-Image dort hinein.</li><li>danach werden viele weitere Scriptslets ausgeführt auf die ich nicht weiter
eingehe</li><li>die meisten Schritte hatten schon die nötigen Debian-Pakete im .deb Cache
("<code class=verbatim>downloads/deb.bookworm.amd64/</code>". Aber in Zeile <a href=(deb)>(deb)</a> kann man sehen, das
noch fehlende Debian-Pakete automatisch heruntergeladen werden. Das erledigt
ein kleines Python-Script, "<code class=verbatim>bin/get_deb.py</code>".</li><li>am Schluss wird es in Zeile <a href=(runrm)>(runrm)</a> wieder etwas besonders: da wir Images für
Embedded Devices erstellen, können wir viele Dinge löschen. Beispiel: es ist
sowieso kein "<code class=verbatim>man</code>" Binary installiert. Also kann man auch einfach alle
Manpages löschen. Sie könnten ja doch nicht angeschaut werden.</li></ul><div id=outline-container-headline-16 class=outline-5><h5 id=headline-16>Erwähnenswert</h5><div id=outline-text-headline-16 class=outline-text-5><p>Wer jemals ein Docker-Image auf Debian-Basis erstellt hat, wird sich evtl. die
Augen reiben: wie kann man ein Image in gerade mal 23 Sekunden bauen? Allein die
Docker-Zeile "apt-get update; apt-get install foo bar baz; apt-get clean"
braucht wesentlich länger?</p><p>Der Trick ist hier ist:</p><ul><li>einerseits die Installation von "<code class=verbatim>eatmydata</code>" ins Image hinein (siehe Zeile
<a href=(eatmydata)>(eatmydata)</a> oben. Es wird dann beim Installieren von "<code class=verbatim>.deb</code>"-Paketen kein
"<code class=verbatim>fsync()</code>" or "<code class=verbatim>open(...,O_SYNC)</code>" ausgeführt.</li><li>manuelles Dependency-Resolving. Hier in Beispiel: um BlueZ (den Linux-Bluetooth-Daemon)
zu installieren, braucht man vorher einige Libraries. Statt "<code class=verbatim>apt</code>" das herausfinden zu lassen,
finde ich es einmalig heraus und fordere die explizit. Die Datei "<code class=verbatim>base/bluez</code>" sieht dann z.B.
so aus:</li></ul><pre class=example>
need base/user                               (ref:user)
need base/systemd
need base/lib-glib                           (ref:glib)

install_debian_deb bluez                     (ref:bluez)
install_debian_deb libbluetooth3             (ref:lib1)
install_debian_deb libdw1
install_debian_deb libasound2
install_debian_deb libasound2-data
install_debian_deb libreadline8
install_debian_deb readline-common           (ref:lib7)

do_run()                                     (ref:dorun)
{
    mkdir -p ${IMAGE_DIR}/etc/systemd/system/bluetooth.service.d/
    copy_file less-services.conf etc/systemd/system/bluetooth.service.d/  (ref:dropin)

    ...
    in_image adduser --quiet dlog bluetooth &gt;/dev/null    (ref:adduser)
}
</pre><p>Das bedeutet im einzelnen:</p><ul><li>bevor "<code class=verbatim>base/bluez</code>" ausgeführt werden kann, muss (Zeile <a href=(user>(user</a>)) ein Standard-User
angelegt werden. Das liegt daran, das wir diesen User mit "<code class=verbatim>addgroup</code>" in die Gruppe
"bluetooth=" aufnehmen wollen (Zeile <a href=(adduser)>(adduser)</a>).</li><li>dann brauchen wir noch systemd vorher im Image, da wir ein Drop-In Konfigurationsfile
installieren, welches Teile des Debian-BlueZ-Unit überschriebt (Zeile <a href=(dropin)>(dropin)</a>).</li><li>BlueZ braucht wie viele andere Programm die glib. Statt also alle .deb unten
anzuführen, die glib installieren, habe ich das in ein eigenes
"<code class=verbatim>base/lib-glib</code>" ausgelagert (Zeile <a href=(glib)>(glib)</a>).</li><li>"<code class=verbatim>need</code>" ist übrigens eine Shell-Funktion, definiert in "<code class=verbatim>bin/run</code>". Dasselbe gilt
für "<code class=verbatim>install_debian_deb</code>" und "<code class=verbatim>in_image</code>".</li><li>nun wird BlueZ selbst in Zeile <a href=(bluez)>(bluez)</a> und alle benötigten Libraries installiert
(Zeilen <a href=(lib1)>(lib1)</a> bis <a href=(lib7)>(lib7)</a>).</li><li>Wenn alle Debian-Pakete installiert sind, wird die Funktion "<code class=verbatim>do_run</code>" in
Zeile <a href=(dorun)>(dorun)</a> aufgerufen. Sie kann beliebige Programme aufrufen, einmal
außerhalb des neu erstellten Images, aber auch innerhalb mit Hilfe von
"<code class=verbatim>in_image</code>". Außerdem sind diverse Environment-Variablen wie "<code class=verbatim>$RUN_HOME</code>",
"<code class=verbatim>$IMAGE_DIR</code>" und "<code class=verbatim>$DATA_DIR</code>" definiert.</li></ul></div></div><div id=outline-container-headline-17 class=outline-5><h5 id=headline-17>Ergebnis</h5><div id=outline-text-headline-17 class=outline-text-5><pre class=example>
~/d/mkimage$ ls image
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
~/d/mkimage$ sudo du -hs image
639M	image
</pre><p>Diese Image kann nun mit "<code class=verbatim>cd image; tar cvzf ../combined-linux.tar.xz .</code>" eingepackt werden. Dieses
File würde man dann auf einen TODO(Artikel schreiben) "Linux Restore Stick" kopieren und damit
Geräte initialisieren.</p><p>Man kann es auch mir "<code class=verbatim>rsync</code>" direkt per Ethernet oder WLAN auf ein Gerät
syncen — das ist erheblich schneller: nach wenigen Sekunden ist das neue
erstellte Image testbar.</p></div></div></div></div></div></div><div id=outline-container-headline-18 class=outline-3><h3 id=headline-18>Verwandte Projekte</h3><div id=outline-text-headline-18 class=outline-text-3><p>Die folgenden Projekte verwenden mkimage direkt oder ähnlich:</p><ul><li></li><li>TODO(Artikel schreiben) Linux-Image auf Basis von i.MX& RISC Prozessor für den Tagebau</li><li>TODO(Artikel schreiben) Linux Restore Stick</li><li></li><li>TODO(Artikel schreiben) Hardware-Teststick für DLT-V73</li></ul></div></div></div></div><div class=post-meta><div><i class="fa fa-copyright fa-fw"></i>
License: <a href=https://spdx.org/licenses/CC-BY-SA-4.0.html target=_blank>CC-BY-SA 4.0</a></div><div><i class="fa fa-calendar fa-fw"></i>
<time>0001-01-01</time></div></div></div></div></div><script src=../../../js/ui.js></script><script src=../../../js/menus.js></script><script src=../../../js/math-code.js></script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>