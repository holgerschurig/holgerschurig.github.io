<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.139.3"><title>Export patches from Emacs' Notmuch &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title>
<link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel=alternate type=application/rss+xml title="Holger Schurig's Computer Calisthenics & Orthodontia" href=../../index.xml><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beiträge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../categories/><i class='fa fa-folder fa-fw'></i>Categories</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div></div><div id=main><div class=header><h1>Export patches from Emacs' Notmuch</h1><h2></h2></div><div class=content><p>I’m reading several linux-kernel related mailing lists. They are full
of proposed patches. And from time to time a few of them look
interesting. So I wanted to have an easy (and fast) solution of
exporting those patches: with a keystroke, and without the need
of specifying patch names.</p><h1 id=format-of-a-patch-email>Format of a patch email</h1><p>If you ever contributed a patch to <strong>Linux</strong>, you’d know that your patch
must follow some formatting rules, or it might be ignored. Some of those
rules are import for my purpose:</p><ul><li>if a patch isn’t self, consistent, it should have some 1/4 (1 of 4)
marking in the subject</li><li>patches must have a [PATCH …] tag at the start of the subject.</li><li>patches must be directly in the e-mail text, not in an attachment.
This effectively means that I don’t have to deal with MIME parts.</li></ul><p>Here are two examples of such email subjects:</p><pre><code>[PATCH] mmc: host: use pr_err for sdhci_dumpregs
[PATCH 3/9] clocksource/drivers/rockchip_timer: Convert init function to return error
</code></pre><h1 id=implementation>Implementation</h1><p>Let’s define some local variables:</p><pre><code>(defun my-notmuch-export-patch ()
  (interactive)
  (let* ((from (notmuch-show-get-from))
         (date (notmuch-show-get-date))
         (subject (notmuch-show-get-subject))
         (id (notmuch-show-get-message-id))
         (filename subject)
         (patchnum))
</code></pre><p>The first step is to extract the patch number:</p><pre><code>(when (string-match &quot;\\[PATCH.+?0*\\([0-9]+\\)/[0-9]+\\]&quot; filename)
  (setq patchnum (string-to-number (match-string 1 filename))))
</code></pre><p>We now do the following steps with the raw subject:</p><ul><li>remove the optional [PATCH …] prefix</li><li>replace everything that are not letters/digits with a dash</li><li>convert consecutive dashes into one dash</li><li>make sure we don’t have a dash at the start</li><li>make sure we don’t have a dash at the end</li></ul><p>So let’s do this:</p><pre><code>(setq filename (replace-regexp-in-string &quot;\\[PATCH.*\\]&quot; &quot;&quot; filename))
(setq filename (replace-regexp-in-string &quot;\[^a-zA-Z0-9]&quot; &quot;-&quot; filename))
(setq filename (replace-regexp-in-string &quot;\\-+&quot; &quot;-&quot; filename))
(setq filename (replace-regexp-in-string &quot;^-&quot; &quot;&quot; filename))
(setq filename (replace-regexp-in-string &quot;-$&quot; &quot;&quot; filename))
</code></pre><p>Prepend the patchnum to the future filename:</p><pre><code>(when patchnum
  (setq filename (concat (format &quot;%04d&quot; patchnum) &quot;-&quot; filename)))
</code></pre><p>And prepend a directory as well:</p><pre><code>(setq filename (concat &quot;/tmp/&quot; filename &quot;.patch&quot;))
</code></pre><p>And now we need write things out.</p><p>First we create a temporary buffer and insert some of message properties
as a header.</p><p>Then we need to get the actual patch. In a non-MIME-encoded e-mail,
the text is the (sic!) MIME part 1. We call the notmuch binary to give
us back this text and insert it into the buffer as well. Note: the <code>t</code>
as the 3rd argument to <code>(call-process</code> makes the output of the notmuch
command end in the current buffer.</p><p>Finally I write this buffer to a file and kill the buffer.
buffer.</p><pre><code>(save-excursion
  (let ((buf (generate-new-buffer (concat &quot;*notmuch-export-patch-&quot; id &quot;*&quot;))))
    (with-current-buffer buf
      (insert (format &quot;Subject: %s\n&quot; subject))
      (insert (format &quot;From: %s\n&quot; from))
      (insert (format &quot;Date: %s\n&quot; date))
      (insert (format &quot;Message-Id: %s\n\n&quot; (substring id 3)))
      (let ((coding-system-for-read 'no-conversion))
        (call-process notmuch-command nil t nil &quot;show&quot; &quot;--part:1&quot; id))
      (write-file filename))
    (kill-buffer buf)))))
</code></pre><p>Done!</p><h1 id=keybinding>Keybinding</h1><p>And the last step is to bind this to some keys. As the function works
both in tree-view and in message-show mode, I bind it to both places.</p><pre><code>(define-key notmuch-show-mode-map &quot;x&quot; #'my-notmuch-export-patch)
(define-key notmuch-tree-mode-map &quot;x&quot; #'my-notmuch-export-patch)
</code></pre><div class=post-meta><div><i class="fa fa-copyright fa-fw"></i>
License: <a href=https://spdx.org/licenses/CC-BY-SA-4.0.html target=_blank>CC-BY-SA 4.0</a></div><div><i class="fa fa-calendar fa-fw"></i>
<time>2017-01-15</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=../../categories/emacs>Emacs</a>
<a class=rss type=application/rss+xml href=../../categories/emacs/index.xml><span class="fa fa-rss">RSS</span></a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=../../tags/emacs>Emacs</a>
<a class=rss type=application/rss+xml href=../../tags/emacs/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/notmuch>notmuch</a>
<a class=rss type=application/rss+xml href=../../tags/notmuch/index.xml><span class="fa fa-rss">RSS</span></a></div></div></div></div></div><script src=../../js/ui.js></script><script src=../../js/menus.js></script><script src=../../js/math-code.js></script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>