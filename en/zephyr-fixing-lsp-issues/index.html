<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.123.7"><title>Zephyr: fixing LSP issues &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title>
<link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel=alternate type=application/rss+xml title="Holger Schurig's Computer Calisthenics & Orthodontia" href=../../index.xml><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beitr√§ge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../categories/><i class='fa fa-folder fa-fw'></i>Categories</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div></div><div id=main><div class=header><h1>Zephyr: fixing LSP issues</h1><h2></h2></div><div class=content><p>Zephyr uses command-line arguments for GCC that the clangd LSP server doesn&rsquo;t<br>understand. Here I present one approach how to fix this.<br></p><div class="ox-hugo-toc toc"><div class=heading>Table of Contents</div><ul><li><a href=#what-is-lsp>What is LSP?</a></li><li><a href=#enable-lsp>Enable LSP</a></li><li><a href=#use-lsp-in-emacs>Use LSP in Emacs</a></li><li><a href=#observing-the-first-errors>Observing the first errors</a></li><li><a href=#fixing-these-errors>Fixing these errors</a></li></ul></div><h2 id=what-is-lsp>What is LSP?</h2><p><a href=https://en.wikipedia.org/wiki/Language_Server_Protocol>LSP</a> stands for &ldquo;Language Server Protocol&rdquo;, a JSON-based protocol that allows<br>tools to communicate with editors about language-specific information while<br>editing. This provides more precise insight into the code than just parsing, and<br>enables features like completion of variable/function/method/type names,<br>cross-references, and other advanced functionalities. LSP is widely used in<br>modern software development workflows.<br></p><h2 id=enable-lsp>Enable LSP</h2><p>Out of the box, Zephyr doesn&rsquo;t support LSP, but it&rsquo;s easy enough to add. When<br>configuring for a board, you only need to ask CMake to create a compilation<br>database.<br></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--83b8fb-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--83b8fb-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--83b8fb-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--83b8fb-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--83b8fb-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--83b8fb-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--83b8fb-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--83b8fb-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--83b8fb-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--83b8fb-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--83b8fb-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--83b8fb-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--83b8fb-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--83b8fb-7>7</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>west build \
</span></span><span style=display:flex><span>	--pristine \
</span></span><span style=display:flex><span>	-b nucleo_f303re \
</span></span><span style=display:flex><span>	-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>	-- \
</span></span><span style=display:flex><span>	-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>	-DOVERLAY_CONFIG=&#34;nucleo_f303re.conf&#34;
</span></span></code></pre></td></tr></table></div></div><p>In line [BROKEN LINK: ref:cdb], we exactly do that. Once you&rsquo;ve compiled your project<br>normally, you will now have such a compilation database in the &ldquo;build/&rdquo;<br>directory.<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ ls -l build/compile_commands.json
</span></span><span style=display:flex><span>-rw-r--r-- 1 holger holger 145793 Jan  5 08:40 build/compile_commands.json
</span></span></code></pre></div><p>This compilation database contains the exact set of source files that would be<br>compiled, along with the full set of compiler command-line arguments for each<br>file. As a result, an LSP daemon doesn&rsquo;t have to parse e.g., Makefile,<br>meson.build, CMake files, etc. It simply looks at this one formalized database.<br></p><h2 id=use-lsp-in-emacs>Use LSP in Emacs</h2><p>On Linux, a good C/C++ LSP server is <a href=https://clangd.llvm.org/>clangd</a>. I currently use clangd-15, so I<br>tell Emacs / eglot about it:<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (add-to-list <span style=color:#e6db74>&#39;eglot-server-programs</span> <span style=color:#f92672>&#39;</span>(c-mode  <span style=color:#f92672>.</span>  (<span style=color:#e6db74>&#34;clangd-15&#34;</span> <span style=color:#e6db74>&#34;-j=2&#34;</span> <span style=color:#e6db74>&#34;--clang-tidy&#34;</span>)))
</span></span><span style=display:flex><span>  (add-to-list <span style=color:#e6db74>&#39;eglot-server-programs</span> <span style=color:#f92672>&#39;</span>(c++-mode <span style=color:#f92672>.</span> (<span style=color:#e6db74>&#34;clangd-15&#34;</span> <span style=color:#e6db74>&#34;-j=2&#34;</span> <span style=color:#e6db74>&#34;--clang-tidy&#34;</span>)))
</span></span></code></pre></div><h2 id=observing-the-first-errors>Observing the first errors</h2><p>Now all is fine, I can start eglot ("<code>M-x eglot</code>"). All is well!<br></p><p>&mldr; but oh no, even a miniature project already shows an error:<br></p><p><figure><img src=./zephyr-fixing-lsp-issues-error.png></figure><br></p><p>Note the &ldquo;!!&rdquo; in the left fringe.<br></p><p>But what are these errors?<br></p><p><figure><img src=./zephyr-fixing-lsp-issues-warnings.png></figure><br></p><p>It turns out that Zephyr uses some command-line options that the GCC Compiler<br>doesn&rsquo;t understand. The CLANG compiler (when compiling) ignores them. But not<br>the CLANGD language server. That one will bark about the not understood<br>command-line options.<br></p><p>In effect, you&rsquo;ll see errors in any of your source files. However, in reality,<br>there aren&rsquo;t any errors present.<br></p><h2 id=fixing-these-errors>Fixing these errors</h2><p>Now, clangd takes all of the command-line arguments from the compilation<br>database. So after configuring, we simply modify the compilation database<br>directly. Therefore, we define a Makefile target for this:<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.PHONY:: fix_lsp_compilation_database
</span></span><span style=display:flex><span>fix_lsp_compilation_database:
</span></span><span style=display:flex><span>	sed -i &#39;s/--param=min-pagesize=0//g&#39; build/compile_commands.json
</span></span><span style=display:flex><span>	sed -i &#39;s/--specs=picolibc.specs//g&#39; build/compile_commands.json
</span></span><span style=display:flex><span>	sed -i &#39;s/-fno-defer-pop//g&#39; build/compile_commands.json
</span></span><span style=display:flex><span>	sed -i &#39;s/-fno-freestanding//g&#39; build/compile_commands.json
</span></span><span style=display:flex><span>	sed -i &#39;s/-fno-printf-return-value//g&#39; build/compile_commands.json
</span></span><span style=display:flex><span>	sed -i &#39;s/-fno-reorder-functions//g&#39; build/compile_commands.json
</span></span><span style=display:flex><span>	sed -i &#39;s/-mfp16-format=ieee//g&#39; build/compile_commands.json
</span></span></code></pre></div><p>and call it directly after we configured for a specific board:<br></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b77306-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b77306-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b77306-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b77306-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b77306-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b77306-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b77306-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b77306-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b77306-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b77306-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b77306-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b77306-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b77306-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b77306-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b77306-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b77306-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b77306-9><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b77306-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b77306-10><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b77306-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b77306-11><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b77306-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>local: .west/config
</span></span><span style=display:flex><span>	west build \
</span></span><span style=display:flex><span>		--pristine \
</span></span><span style=display:flex><span>		-b local \
</span></span><span style=display:flex><span>		-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>		-- \
</span></span><span style=display:flex><span>		-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>		-DOVERLAY_CONFIG=&#34;boards/arm/local/local_defconfig&#34; \
</span></span><span style=display:flex><span>		-DBOARD_ROOT=.
</span></span><span style=display:flex><span>	$(MAKE) --no-print-directory fix_lsp_compilation_database
</span></span><span style=display:flex><span>	west build
</span></span></code></pre></td></tr></table></div></div><p>like this is done here in line <a href=#org-coderef--b77306-10>10</a>.<br></p><div class=post-meta><div><i class="fa fa-copyright fa-fw"></i>
License: <a href=https://spdx.org/licenses/CC-BY-SA-4.0.html target=_blank>CC-BY-SA 4.0</a></div><div><i class="fa fa-calendar fa-fw"></i>
<time>2024-01-04</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=../../categories/embedded>embedded</a>
<a class=rss type=application/rss+xml href=../../categories/embedded/index.xml><span class="fa fa-rss">RSS</span></a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=../../tags/zephyr>zephyr</a>
<a class=rss type=application/rss+xml href=../../tags/zephyr/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/make>make</a>
<a class=rss type=application/rss+xml href=../../tags/make/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/lsp>lsp</a>
<a class=rss type=application/rss+xml href=../../tags/lsp/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/clangd>clangd</a>
<a class=rss type=application/rss+xml href=../../tags/clangd/index.xml><span class="fa fa-rss">RSS</span></a></div></div></div></div></div><script src=../../js/ui.js></script><script src=../../js/menus.js></script><script src=../../js/math-code.js></script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>