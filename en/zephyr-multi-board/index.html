<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.122.0"><title>Zepyhr: multi-board setup &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title>
<link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel=alternate type=application/rss+xml title="Holger Schurig's Computer Calisthenics & Orthodontia" href=../../index.xml><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beitr√§ge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../categories/><i class='fa fa-folder fa-fw'></i>Categories</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div></div><div id=main><div class=header><h1>Zepyhr: multi-board setup</h1><h2></h2></div><div class=content><p>This blog post shows how to setup a Zephyr project that you can use for several boards.<br></p><div class="ox-hugo-toc toc"><div class=heading>Table of Contents</div><ul><li><a href=#why-multiple-boards-in-one-project>Why multiple boards in one project?</a></li><li><a href=#ab--use-of-makefiles>(Ab)use of Makefiles</a></li><li><a href=#this-blog-post-is-based-on-dot-dot-dot>This blog post is based on &mldr;</a></li><li><a href=#board-related>Board related</a><ul><li><a href=#get-list-of-defined-board>Get list of defined board</a></li><li><a href=#configure-and-compile-for-one-of-the-boards>Configure and compile for one of the boards</a></li><li><a href=#how-this-is-implemented>How this is implemented</a></li><li><a href=#configure-and-compile-for-simulated-hardware>Configure and compile for simulated hardware</a></li><li><a href=#define-a-local-board>Define a local board</a></li><li><a href=#compiling-some-sources-only-for-some-boards>Compiling some sources only for some boards</a></li><li><a href=#configuration>Configuration</a></li></ul></li><li><a href=#get-help-from-make>Get help from make</a></li></ul></div><h2 id=why-multiple-boards-in-one-project>Why multiple boards in one project?</h2><ul><li>You start with a development board (such as STM Nucleo or Disco) while you<br>wait for the actual hardware prototype.<br></li><li>You want to run hardware-independent unit tests, either on your desktop or on<br>a CI/CD server like Jenkins.<br></li><li>You have to develop for many similar devices that only have slight<br>differences, and you don&rsquo;t want to have many almost-identical source trees.<br></li></ul><h2 id=ab--use-of-makefiles>(Ab)use of Makefiles</h2><p>The following is orchestrated mostly by a Makefile.<br></p><p>Even when Zephyr itself uses CMake and Ninja, Makefiles are a nicer way to<br>bundle lots of shell snippets into one Makefile. You can view this Makefile also<br>as a collection of knowledge, or as a way to have things replicable.<br></p><h2 id=this-blog-post-is-based-on-dot-dot-dot>This blog post is based on &mldr;</h2><p>This post depends and improves on <a href=../../en/zephyr-reproducible-project-setup/>Zepyhr: reproducible project setup </a>and uses it&rsquo;s <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/Makefile.zephyr_init>Makefile.zephyr_init</a>.<br></p><h2 id=board-related>Board related</h2><h3 id=get-list-of-defined-board>Get list of defined board</h3><p>If we just enter &ldquo;<code>make</code>&rdquo; to compile our sources, we instead see a list of of boards.<br></p><p>If we have one set of source files but several target boards, we need a way to<br>configure for a specific board. So if there is no &ldquo;<code>build/</code>&rdquo; directory, we are<br>asked to first configure for a specific board:<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>:~/src/multi-board-zephyr$ make
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-----------------------------------------------------------------------------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You must first select with with board you want to work:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>native                configure for native (used for unit-tests)
</span></span><span style=display:flex><span>nucleo                compile for STM32 Nucleo
</span></span><span style=display:flex><span>local                 configure for locally defined board
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-----------------------------------------------------------------------------
</span></span></code></pre></div><h3 id=configure-and-compile-for-one-of-the-boards>Configure and compile for one of the boards</h3><p>We select one of the boards, e.g. the provided STM32 Nucleo one:<br></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-9><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-10><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-11><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--86e8d1-12><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--86e8d1-12>12</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ make nucleo
</span></span><span style=display:flex><span>west build \
</span></span><span style=display:flex><span>	--pristine \
</span></span><span style=display:flex><span>	-b nucleo_f303re \
</span></span><span style=display:flex><span>	-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>	-- \
</span></span><span style=display:flex><span>	-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>	-DOVERLAY_CONFIG=&#34;nucleo_f303re.conf&#34;
</span></span><span style=display:flex><span>-- west build: generating a build system
</span></span><span style=display:flex><span>Loading Zephyr default modules (Zephyr base).
</span></span><span style=display:flex><span>-- Application: /home/holger/src/multi-board-zephyr
</span></span><span style=display:flex><span># ... many more lines ...
</span></span></code></pre></td></tr></table></div></div><p>There are some special things here at work:<br></p><ul><li>In line <a href=#org-coderef--86e8d1-3>3</a>, we order &ldquo;<code>west</code>&rdquo; to use a pristine environment whenever<br>the configuration changes. So you can do &ldquo;<code>make local</code>&rdquo; and then &ldquo;<code>make nucleo</code>&rdquo; and the &ldquo;<code>build/</code>&rdquo; directory will completely switch. There&rsquo;s no need<br>for you to manually remove it with &ldquo;<code>rm -rf build</code>&rdquo;.<br>to.<br></li><li>In line [BROKEN LINK: nucleo/f303re], we actually select the wanted board. This one is<br>provided by Zephyr itself, and you can find it in<br><a href=https://github.com/zephyrproject-rtos/zephyr/tree/main/boards/arm/nucleo/f303re>https://github.com/zephyrproject-rtos/zephyr/tree/main/boards/arm/nucleo/f303re</a>.<br></li><li>Line <a href=#org-coderef--86e8d1-5>5</a> tells Zephyr&rsquo;s CMake to use Ninja, which compiles as if we would<br>ask CMake to generate makefiles.<br></li><li>The two dashes in line <a href=#org-coderef--86e8d1-6>6</a> tell &ldquo;<code>west</code>&rdquo; to pass over all the future<br>command-line options as-is to CMake.<br></li><li>Line <a href=#org-coderef--86e8d1-7>7</a> tells CMake to generate a compilation database. Use this with an<br>LSP daemon like clangd or other tools that depend on it. Many editors like<br>Emacs, Visual Studio, etc., offer special services if LSP is present. See more on<br>LSP in the post <a href=../../en/zephyr-fixing-lsp-issues/>Zepyhr: fixing LSP issues</a><br></li><li>Line <a href=#org-coderef--86e8d1-8>8</a> tells the build system to configure itself according to the<br>specified configuration file. They are in a Linux-style KConfig / &ldquo;.config&rdquo;<br>syntax. Note that only board-specific configurations should be placed there.<br>Anything that should be used project-wide has a better place in &ldquo;prj.conf&rdquo;.<br></li></ul><p>If the configuration step succeed, this will also automatically compile your code.<br></p><p>For subsequent compilations, you just enter &ldquo;<code>make</code>&rdquo; alone. Another &ldquo;<code>make nucleo</code>&rdquo; would also re-configure the &ldquo;<code>build/</code>&rdquo; directory. That would take more<br>time.<br></p><h3 id=how-this-is-implemented>How this is implemented</h3><p>The differentiation between &ldquo;<code>make</code>&rdquo; doing just a re-compile or asking you to<br>select a board is done like this:<br></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-6>6</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>all::
</span></span><span style=display:flex><span>ifeq (&#34;$(wildcard build/build.ninja)&#34;,&#34;&#34;)           (ref:build.ninja)
</span></span><span style=display:flex><span>	@$(call show_boards)
</span></span><span style=display:flex><span>else
</span></span><span style=display:flex><span>	ninja -C build
</span></span><span style=display:flex><span>endif
</span></span></code></pre></td></tr></table></div></div><ul><li>in line [[(build.ninja))] it checks if the build environment inside the<br>&ldquo;<code>build/</code>&rdquo; directory has been created. If not, it calls the Make function<br>&ldquo;show_boards&rdquo;. More on this function in a moment.<br></li><li>but if it exists, we just call in line <a href=#org-coderef--1c9136-5>5</a> &ldquo;<code>ninja</code>&rdquo; with our build<br>directory as working dir<br></li></ul><p>The make function is simple enought: basically only some decoration around &ldquo;<code>make help_boards</code>&rdquo;:<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>define show_boards
</span></span><span style=display:flex><span>	@echo &#34;&#34;
</span></span><span style=display:flex><span>	@echo &#34;-----------------------------------------------------------------------------&#34;
</span></span><span style=display:flex><span>	@echo &#34;&#34;
</span></span><span style=display:flex><span>	@echo &#34;You must first select with with board you want to work:&#34;
</span></span><span style=display:flex><span>	@$(MAKE) --no-print-directory help_boards
</span></span><span style=display:flex><span>	@echo &#34;&#34;
</span></span><span style=display:flex><span>	@echo &#34;-----------------------------------------------------------------------------&#34;
</span></span><span style=display:flex><span>	@echo &#34;&#34;
</span></span><span style=display:flex><span>endef
</span></span></code></pre></div><p>The reason I made this a function is so that it is easy to call from several<br>places. In this Makefile, not only &ldquo;<code>make all</code>&rdquo; calls it eventually, but also<br>maybe &ldquo;<code>make menuconfig</code>&rdquo; or &ldquo;<code>make xconfig</code>&rdquo;.<br></p><p>Finally we have a multitude of &ldquo;help_boards:&rdquo; targets like this:<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>help help_boards::
</span></span><span style=display:flex><span>	@echo &#34;nucleo                configure and compile for STM32 Nucleo&#34;
</span></span></code></pre></div><h3 id=configure-and-compile-for-simulated-hardware>Configure and compile for simulated hardware</h3><p>Zephyr includes a board called <a href=https://docs.zephyrproject.org/latest/boards/posix/native_sim/doc/index.html>native_sim</a>. Basically when you select this<br>&ldquo;board&rdquo;, your sources are compiled for your development compiter (in my case:<br>Linux). So they aren&rsquo;t compiled for ARM or RISV-V, but for x86. The native<br>simulator even allows you to similar some hardware, e.g. an AT24 EEPROM.<br></p><p>However, what is most useful is that you can define unit-tests and run these<br>unit-tests than on your develpment compiter &mdash; or on a CI/CD server, like<br>Jenkins.<br></p><p>Here is how you configure Zephyr for this:<br></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-9><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-10><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-10>10</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.PHONY:: native
</span></span><span style=display:flex><span>native: .west/config
</span></span><span style=display:flex><span>	west build \
</span></span><span style=display:flex><span>		--pristine \
</span></span><span style=display:flex><span>		-b native_sim \
</span></span><span style=display:flex><span>		-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>		-- \
</span></span><span style=display:flex><span>		-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>		-DOVERLAY_CONFIG=&#34;native_sim.conf&#34;
</span></span><span style=display:flex><span>	west build
</span></span></code></pre></td></tr></table></div></div><p>As before, any native-sim-related configuration should be put into<br><code>"native_sim.conf</code>", (line <a href=#org-coderef--50af3b-9>9</a>).<br></p><p>Now, when we configure and compile, we now get a binary that we can run under<br>Linux (or WSL, if you&rsquo;re on Windows):<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ make native
</span></span><span style=display:flex><span>west build \
</span></span><span style=display:flex><span>	--pristine \
</span></span><span style=display:flex><span>	-b native_sim \
</span></span><span style=display:flex><span>	-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>	-- \
</span></span><span style=display:flex><span>	-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>	-DOVERLAY_CONFIG=&#34;native_sim.conf&#34;
</span></span><span style=display:flex><span>-- west build: making build dir /home/holger/src/multi-board-zephyr/build pristine
</span></span><span style=display:flex><span>-- west build: generating a build system
</span></span><span style=display:flex><span>Loading Zephyr default modules (Zephyr base).
</span></span><span style=display:flex><span>-- Application: /home/holger/src/multi-board-zephyr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># ... many lines omitted ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[93/93] cd /home/holger/src/multi-board-zephyr/bui...ger/src/multi-board-zephyr/build/zephyr/zephyr.ex
</span></span></code></pre></div><p>It&rsquo;s even named &ldquo;<code>*.exe</code>&rdquo; :-)<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ file build/zephyr/zephyr.exe
</span></span><span style=display:flex><span>build/zephyr/zephyr.exe: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, BuildID[sha1]=d4b863c9b8d6e9e2265fdef874ec0b9df70efdc9, for GNU/Linux 3.2.0, with debug_info, not stripped
</span></span></code></pre></div><p>And you can call it normally:<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ build/zephyr/zephyr.exe
</span></span><span style=display:flex><span>Running TESTSUITE tests
</span></span><span style=display:flex><span>===================================================================
</span></span><span style=display:flex><span>START - demo_test
</span></span><span style=display:flex><span> PASS - demo_test in 0.000 seconds
</span></span><span style=display:flex><span>===================================================================
</span></span><span style=display:flex><span>TESTSUITE tests succeeded
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------ TESTSUITE SUMMARY START ------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SUITE PASS - 100.00% [tests]: pass = 1, fail = 0, skip = 0, total = 1 duration = 0.000 seconds
</span></span><span style=display:flex><span> - PASS - [tests.demo_test] duration = 0.000 seconds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------ TESTSUITE SUMMARY END ------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>===================================================================
</span></span><span style=display:flex><span>PROJECT EXECUTION SUCCESSFUL
</span></span></code></pre></div><p>I will create another blog soon on how to integrate this into Jenkings: by<br>converting the output into the TAP format.<br></p><h3 id=define-a-local-board>Define a local board</h3><p>So far, we used boards already defined by the Zephyr source code. But perhaps<br>you want to use Zephyr on one of your own boards, where you don&rsquo;t plan to<br>publish it upstream? That&rsquo;s entirely possible, and the board called &ldquo;local&rdquo; in<br>this project is exactly that: a board defined for Zephyr but out-of-tree. The<br>Makefile snippet for it sounds familiar &mldr;<br></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-9><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-10><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-11><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.PHONY:: local
</span></span><span style=display:flex><span>local: .west/config
</span></span><span style=display:flex><span>	west build \
</span></span><span style=display:flex><span>		--pristine \
</span></span><span style=display:flex><span>		-b local \
</span></span><span style=display:flex><span>		-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>		-- \
</span></span><span style=display:flex><span>		-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>		-DOVERLAY_CONFIG=&#34;boards/arm/local/local_defconfig&#34; \
</span></span><span style=display:flex><span>		-DBOARD_ROOT=.
</span></span><span style=display:flex><span>	west build
</span></span></code></pre></td></tr></table></div></div><p>&mldr; but there are some differences:<br></p><ul><li>Line <a href=#org-coderef--6f7b48-9>9</a> gives the full path to the default configuration of the<br>board.<br></li><li>Line <a href=#org-coderef--6f7b48-10>10</a> specifies our project (not Zephyr) as the board root, so<br>Zephyr won&rsquo;t look into &ldquo;=zephyr/boards/&rdquo; but instead into &ldquo;=boards/&rdquo; when<br>looking for boards.<br></li></ul><p>Now we need to have such a &ldquo;<code>boards/arm/local/</code>&rdquo; directory and populate it with some files:<br></p><table><thead><tr><th>File</th><th>Purpose</th></tr></thead><tbody><tr><td>Kconfig.board</td><td>this is where you introduce board-specific Kconfig options</td></tr><tr><td>Kconfig.defconfig</td><td>without setting CONFIG_BOARD to the name of your board, Zephyr wouldn&rsquo;t find the following files</td></tr><tr><td>board.cmake</td><td>can contain CMake definitions, usually used for OpenOCD or JLink settings</td></tr><tr><td>local.dts</td><td>the Device Tree for your board</td></tr><tr><td>local_defconfig</td><td>the default configuaration for your board, only put things there that isn&rsquo;t in &ldquo;<code>prj.conf</code>&rdquo;</td></tr><tr><td>support/openocd.cfg</td><td>if you use OpenOCD, this contains configuration for it</td></tr></tbody></table><h3 id=compiling-some-sources-only-for-some-boards>Compiling some sources only for some boards</h3><p>This can easily be done via &ldquo;<code>CMakeLists.txt</code>&rdquo;:<br></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-7>7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-8>8</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>target_sources(app PRIVATE
</span></span><span style=display:flex><span>  main.c)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>target_sources_ifdef(CONFIG_BOARD_LOCAL app PRIVATE
</span></span><span style=display:flex><span>  board_local.c)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>target_sources_ifdef(CONFIG_BOARD_NATIVE_SIM app PRIVATE
</span></span><span style=display:flex><span>  board_native.c)
</span></span></code></pre></td></tr></table></div></div><ul><li>Any sources that must compile for every board are specified like in line<br>[BROKEN LINK: src/main]. Note that the hanging indent is there as a hint that you can<br>specify multiple source files in one &ldquo;<code>target\/source</code>&rdquo; declaration.<br></li><li>According to line [BROKEN LINK: src\/local], the file &ldquo;<code>board\/local.c</code>&rdquo; will only be<br>compiled if your current board is the board named &ldquo;local&rdquo;.<br></li><li>And you guessed it; line [BROKEN LINK: src\/native] ensures that this source file is only<br>considered when compiling for the &ldquo;native\/sim&rdquo; board. Here, I&rsquo;d put the<br>device-independent unit tests, for example.<br></li></ul><p>You can use the CONFIG_ &mldr; variables also direcly in your C sources:<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>#ifdef CONFIG_BOARD_LOCAL
</span></span><span style=display:flex><span>   LOG_INF(&#34;Running on local&#34;)
</span></span><span style=display:flex><span>endif
</span></span></code></pre></div><h3 id=configuration>Configuration</h3><p>You also learned about the various &ldquo;<code>*.conf</code>&rdquo; files like<br></p><ul><li>board-specific <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/native_sim.conf>native_sim.conf</a><br></li><li>board-specific <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/nucleo_f303re.conf>nucleo_f303re.conf</a><br></li><li>board-specific ones like <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/boards/arm/local/Kconfig.board>boards/arm/local/Kconfig.board</a>,<br><a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/boards/arm/local/Kconfig_defconfig>boards/arm/local/Kconfig_defconfig</a> and <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/boards/arm/local/local_defconfig>boards/arm/local/local_defconfig</a><br></li><li>the project-wide <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/prj.conf>prj.conf</a> file<br></li></ul><p>But how to find out which &ldquo;<code>CONFIG_*</code>&rdquo; settings you can use?<br></p><p>Use either<br></p><ul><li>&ldquo;<code>make menuconfig</code>&rdquo; or<br></li><li>&ldquo;<code>make xconfig</code>&rdquo;<br></li></ul><p>When you make changes and save, you can then just run &ldquo;<code>make</code>&rdquo; to compile your<br>board with these settings. However, to make these changes permanent (and<br>reproducible), you need to update one of the configuration files listed above.<br></p><h2 id=get-help-from-make>Get help from make</h2><p>I already showed &ldquo;<code>make help\/boards</code>&rdquo;. The same method (multiple pseudo<br>makefile targets emitting helpful text) is available to get an idea of what the<br>Makefile can do for you:<br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ make help
</span></span><span style=display:flex><span>init                  do all of these steps:
</span></span><span style=display:flex><span>   debs               only install debian packages
</span></span><span style=display:flex><span>   venv               create and check Python3 virtual environment
</span></span><span style=display:flex><span>   west               install and configure the &#39;west&#39; tool
</span></span><span style=display:flex><span>   zephyr             clone Zephyr
</span></span><span style=display:flex><span>   modules            install Zeyphr modules (e.g. ST and STM32 HAL, CMSIS ...)
</span></span><span style=display:flex><span>     module_stm32     update only STM32 HAL
</span></span><span style=display:flex><span>     module_st        update only ST HAL
</span></span><span style=display:flex><span>     module_cmsis     update only CMSIS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>all                   compile for current board
</span></span><span style=display:flex><span>menuconfig            run menuconfig for current board
</span></span><span style=display:flex><span>xconfig               run xconfig for current board
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>native                configure and compile for native (used for unit-tests)
</span></span><span style=display:flex><span>nucleo                configure and compile for STM32 Nucleo
</span></span><span style=display:flex><span>local                 configure and compile for locally defined board
</span></span></code></pre></div><div class=post-meta><div><i class="fa fa-copyright fa-fw"></i>
License: <a href=https://spdx.org/licenses/CC-BY-SA-4.0.html target=_blank>CC-BY-SA 4.0</a></div><div><i class="fa fa-calendar fa-fw"></i>
<time>2024-01-03</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=../../categories/embedded>embedded</a>
<a class=rss type=application/rss+xml href=../../categories/embedded/index.xml><span class="fa fa-rss">RSS</span></a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=../../tags/zephyr>zephyr</a>
<a class=rss type=application/rss+xml href=../../tags/zephyr/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/make>make</a>
<a class=rss type=application/rss+xml href=../../tags/make/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/west>west</a>
<a class=rss type=application/rss+xml href=../../tags/west/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/openocd>OpenOCD</a>
<a class=rss type=application/rss+xml href=../../tags/openocd/index.xml><span class="fa fa-rss">RSS</span></a></div></div></div></div></div><script src=../../js/ui.js></script><script src=../../js/menus.js></script><script src=../../js/math-code.js></script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>