<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.121.1"><title>Zepyhr: multi-board setup &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title>
<link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel=alternate type=application/rss+xml title="Holger Schurig's Computer Calisthenics & Orthodontia" href=../../index.xml><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beitr√§ge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../categories/><i class='fa fa-folder fa-fw'></i>Categories</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div></div><div id=main><div class=header><h1>Zepyhr: multi-board setup</h1><h2></h2></div><div class=content><p>This blog post shows how to setup a Zephyr project that you can use for several boards.</p><ul><li><a href=#why-multiple-boards-in-one-project>Why multiple boards in one project?</a></li><li><a href=#ab--use-of-makefiles>(Ab)use of Makefiles</a></li><li><a href=#this-blog-post-is-based-on-dot-dot-dot>This blog post is based on &mldr;</a></li><li><a href=#board-related>Board related</a><ul><li><a href=#get-list-of-defined-board>Get list of defined board</a></li><li><a href=#configure-and-compile-for-one-of-the-boards>Configure and compile for one of the boards</a></li><li><a href=#how-this-is-implemented>How this is implemented</a></li><li><a href=#configure-and-compile-for-simulated-hardware>Configure and compile for simulated hardware</a></li><li><a href=#define-a-local-board>Define a local board</a></li><li><a href=#compiling-some-sources-only-for-some-boards>Compiling some sources only for some boards</a></li><li><a href=#configuration>Configuration</a></li></ul></li><li><a href=#get-help-from-make>Get help from make</a></li></ul><h2 id=why-multiple-boards-in-one-project>Why multiple boards in one project?</h2><ul><li>you start with a development board (like STM Nucleo or Disco) while you wait
for the actual hardware prototype</li><li>you want to run (hardware-independent) <a href=https://docs.zephyrproject.org/latest/develop/test/ztest.html>unit-tests</a>, either on your desktop or
on a CI/CD server like Jenkings</li><li>you have to develop for many similar devices that only have slight differences
and don&rsquo;t want to have many almost-identical source trees</li></ul><h2 id=ab--use-of-makefiles>(Ab)use of Makefiles</h2><p>Most of the following is orchestrated mostly by a Makefile.</p><p>Even when Zephyr itself uses CMake and Ninja, Makefiles are a nicer way to
bundle lots of shell snippets into one Makefile. You can view this Makefile also
as a collection of knowledge, or as a way to have things replicatable.</p><h2 id=this-blog-post-is-based-on-dot-dot-dot>This blog post is based on &mldr;</h2><p>This blog post depends on Macro test <a href=../../en/zephyr-reproducible-project-setup/>Zepyhr: reproducible project setup </a>and uses it&rsquo;s <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/Makefile.zephyr_init>Makefile.zephyr_init</a>.</p><h2 id=board-related>Board related</h2><h3 id=get-list-of-defined-board>Get list of defined board</h3><p>Now that you created the Zephyr development environment using <a href=../../en/zephyr-reproducible-project-setup/>Zepyhr: reproducible project setup </a>, added some
sources and a &ldquo;<code>CMakeLists.txt</code>&rdquo; file you enter &ldquo;<code>make</code>&rdquo; to compile your
project.</p><p>But instead of compiling your source, you see a list of available boards:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>:~/src/multi-board-zephyr$ make
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-----------------------------------------------------------------------------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You must first select with with board you want to work:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>native                configure for native (used for unit-tests)
</span></span><span style=display:flex><span>nucleo                compile for STM32 Nucleo
</span></span><span style=display:flex><span>local                 configure for locally defined board
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-----------------------------------------------------------------------------
</span></span></code></pre></div><p>The reason is that we don&rsquo;t yet know for which board you actually want to
compile your sources.</p><p>Basically, if no &ldquo;<code>build/</code>&rdquo; directory exists, you get this help text with all
configured boards inside the Makefile.</p><h3 id=configure-and-compile-for-one-of-the-boards>Configure and compile for one of the boards</h3><p>So instead, select board, and enter &ldquo;<code>make nucleo</code>&rdquo; instead. And now Zephyr
configures itself and compiles:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-9><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-10><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-11><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-12><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-13><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--b0b636-14><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--b0b636-14>14</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ make nucleo
</span></span><span style=display:flex><span>west build \
</span></span><span style=display:flex><span>	--pristine \
</span></span><span style=display:flex><span>	-b nucleo_f303re \
</span></span><span style=display:flex><span>	-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>	-- \
</span></span><span style=display:flex><span>	-Wno-dev \
</span></span><span style=display:flex><span>	-Wno-deprecated \
</span></span><span style=display:flex><span>	-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>	-DOVERLAY_CONFIG=&#34;nucleo_f303re.conf&#34;
</span></span><span style=display:flex><span>-- west build: generating a build system
</span></span><span style=display:flex><span>Loading Zephyr default modules (Zephyr base).
</span></span><span style=display:flex><span>-- Application: /home/holger/src/multi-board-zephyr
</span></span><span style=display:flex><span># ... many more lines ...
</span></span></code></pre></td></tr></table></div></div><p>There are some special things here at work:</p><ul><li>in line <a href=#org-coderef--b0b636-3>3</a> we order &ldquo;<code>west</code>&rdquo; to use a pristine environment whenever
the configuration changes. So you can do &ldquo;<code>make local</code>&rdquo; and then &ldquo;<code>make nucleo</code>&rdquo; and the &ldquo;<code>build/</code>&rdquo; directory will completely switch. While you can do
&ldquo;<code>rm -rf build</code>&rdquo; you don&rsquo;t need to, due to this &ldquo;<code>--pristine</code>&rdquo; command line
switch</li><li>in line <a href=#org-coderef--b0b636-4>4</a> we actually select the wanted boards. This one is
provided by Zephyr itself, you can find it in
<a href=https://github.com/zephyrproject-rtos/zephyr/tree/main/boards/arm/nucleo_f303re>https://github.com/zephyrproject-rtos/zephyr/tree/main/boards/arm/nucleo_f303re</a></li><li>line <a href=#org-coderef--b0b636-5>5</a> tells Zephyr&rsquo;s CMake to use Ninja, which is faster compiling
compared to let CMake generate Makefiles.</li><li>the two dashes in line <a href=#org-coderef--b0b636-6>6</a> tells &ldquo;<code>west</code>&rdquo; to pass over all the future command
line-options as-is to CMake.</li><li>line <a href=#org-coderef--b0b636-9>9</a> tells CMake to generate a compilation database. Use this with an
LSP daemon like clangd or other tools that depend it. Many editors like Emacs,
Visual Studio etc offer special services if LSP is present.</li><li>line <a href=#org-coderef--b0b636-10>10</a> tell the build system to configure itself according to this
config files (which has Linux KConfig / &ldquo;<code>.config</code>&rdquo; syntax. Note that only
board-specific configuration should be placed there. Anything that should be
used project-wide has a better place in &ldquo;<code>prj.conf</code>&rdquo;.</li></ul><p>If the configuration step succeed, this will also automatically compile your code.</p><p>Here are the last few lines of the compilation process:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Memory region         Used Size  Region Size  %age Used
</span></span><span style=display:flex><span>           FLASH:       39782 B       512 KB      7.59%
</span></span><span style=display:flex><span>             RAM:        9792 B        64 KB     14.94%
</span></span><span style=display:flex><span>             CCM:          0 GB        16 KB      0.00%
</span></span><span style=display:flex><span>        IDT_LIST:          0 GB         2 KB      0.00%
</span></span><span style=display:flex><span>Generating files from /home/holger/src/multi-board-zephyr/build/zephyr/zephyr.elf for board: nucleo_f303re
</span></span><span style=display:flex><span>[147/147] cd /home/holger/src/multi-board-zephyr/b...ger/src/multi-board-zephyr/build/zephyr/zephyr.el
</span></span><span style=display:flex><span>(.venv) holger@holger:~/src/multi-board-zephyr$ file build/zephyr/zephyr.bin
</span></span><span style=display:flex><span>build/zephyr/zephyr.bin: ARM Cortex-M firmware, initial SP at 0x20001fc0, reset at 0x08002f30, NMI at 0x08002bec, HardFault at 0x08002f1c, SVCall at 0x08003054, PendSV at 0x08002fec
</span></span></code></pre></div><h3 id=how-this-is-implemented>How this is implemented</h3><p>The above &ldquo;<code>make nucleo</code>&rdquo; is implemented by this Makefile part:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.PHONY:: nucleo
</span></span><span style=display:flex><span>nucleo: .west/config
</span></span><span style=display:flex><span>	west build \
</span></span><span style=display:flex><span>		--pristine \
</span></span><span style=display:flex><span>		-b nucleo_f303re \
</span></span><span style=display:flex><span>		-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>		-- \
</span></span><span style=display:flex><span>		-Wno-dev \
</span></span><span style=display:flex><span>		-Wno-deprecated \
</span></span><span style=display:flex><span>		-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>		-DOVERLAY_CONFIG=&#34;nucleo_f303re.conf&#34;
</span></span><span style=display:flex><span>	west build
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>help help_boards::
</span></span><span style=display:flex><span>	@echo &#34;nucleo                compile for STM32 Nucleo&#34;
</span></span></code></pre></div><p>Note the last two lines: we have a Makefile pseudo-target &ldquo;<code>help_boards</code>&rdquo; which
can exist several times in the Makefile (because it uses &ldquo;::&rdquo; and not &ldquo;:&rdquo;). Each of our board
configuration snippets contains such an entry.</p><p>Now, if you simply run &ldquo;<code>make</code>&rdquo;, then the pseudo-target &ldquo;all&rdquo; will be executed.
And it looks like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--1c9136-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--1c9136-6>6</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>all::
</span></span><span style=display:flex><span>ifeq (&#34;$(wildcard build/build.ninja)&#34;,&#34;&#34;)           (ref:build.ninja)
</span></span><span style=display:flex><span>	@$(call show_boards)
</span></span><span style=display:flex><span>else
</span></span><span style=display:flex><span>	ninja -C build
</span></span><span style=display:flex><span>endif
</span></span></code></pre></td></tr></table></div></div><ul><li>in line [[(build.ninja))] it checks if the build environment inside the
&ldquo;<code>build/</code>&rdquo; directory has been created. If not, it calls the Make function
&ldquo;show_boards&rdquo;. More on this function in a moment.</li><li>but if it exists, we just call in line <a href=#org-coderef--1c9136-5>5</a> &ldquo;<code>ninja</code>&rdquo; with our build
directory as working dir</li></ul><p>The make function is simple enought: basically only some decoration around &ldquo;<code>make help_boards</code>&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>define show_boards
</span></span><span style=display:flex><span>	@echo &#34;&#34;
</span></span><span style=display:flex><span>	@echo &#34;-----------------------------------------------------------------------------&#34;
</span></span><span style=display:flex><span>	@echo &#34;&#34;
</span></span><span style=display:flex><span>	@echo &#34;You must first select with with board you want to work:&#34;
</span></span><span style=display:flex><span>	@$(MAKE) --no-print-directory help_boards
</span></span><span style=display:flex><span>	@echo &#34;&#34;
</span></span><span style=display:flex><span>	@echo &#34;-----------------------------------------------------------------------------&#34;
</span></span><span style=display:flex><span>	@echo &#34;&#34;
</span></span><span style=display:flex><span>endef
</span></span></code></pre></div><p>The reason I made this a function is so that it is easy to call from several
places. In this Makefile, not only &ldquo;<code>make all</code>&rdquo; calls it eventually, but also
maybe &ldquo;<code>make menuconfig</code>&rdquo; or &ldquo;<code>make xconfig</code>&rdquo;.</p><h3 id=configure-and-compile-for-simulated-hardware>Configure and compile for simulated hardware</h3><p>Zephyr includes a &ldquo;board&rdquo; called <a href=https://docs.zephyrproject.org/latest/boards/posix/native_sim/doc/index.html>native_sim</a>. Basically your sources are compiled
for this target, but they run on your development computer (e.g. compiled to
x86, not for ARM). The native simulator even allows you to similar some
hardware, e.g. an AT24 EEPROM.</p><p>However, what is most useful is that you can define unit-tests and run these unit-tests
than on your develpment compiter &mdash; or on a CI/CD server, like Jenkins.</p><p>Here is how you configure Zephyr for this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-9><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--50af3b-10><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--50af3b-10>10</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.PHONY:: native
</span></span><span style=display:flex><span>native: .west/config
</span></span><span style=display:flex><span>	west build \
</span></span><span style=display:flex><span>		--pristine \
</span></span><span style=display:flex><span>		-b native_sim \
</span></span><span style=display:flex><span>		-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>		-- \
</span></span><span style=display:flex><span>		-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>		-DOVERLAY_CONFIG=&#34;native_sim.conf&#34;
</span></span><span style=display:flex><span>	west build
</span></span></code></pre></td></tr></table></div></div><p>As before, any native-sim-related configuration should be put into
<code>"native_sim.conf</code>", (line <a href=#org-coderef--50af3b-9>9</a>).</p><p>Now, when we configure and compile, we now get a binary that we can run under
Linux (or WSL, if you&rsquo;re on Windows):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ make native
</span></span><span style=display:flex><span>west build \
</span></span><span style=display:flex><span>	--pristine \
</span></span><span style=display:flex><span>	-b native_sim \
</span></span><span style=display:flex><span>	-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>	-- \
</span></span><span style=display:flex><span>	-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>	-DOVERLAY_CONFIG=&#34;native_sim.conf&#34;
</span></span><span style=display:flex><span>-- west build: making build dir /home/holger/src/multi-board-zephyr/build pristine
</span></span><span style=display:flex><span>-- west build: generating a build system
</span></span><span style=display:flex><span>Loading Zephyr default modules (Zephyr base).
</span></span><span style=display:flex><span>-- Application: /home/holger/src/multi-board-zephyr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># ... many lines omitted ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[93/93] cd /home/holger/src/multi-board-zephyr/bui...ger/src/multi-board-zephyr/build/zephyr/zephyr.ex
</span></span></code></pre></div><p>It&rsquo;s even named &ldquo;<code>*.exe</code>&rdquo; :-)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ file build/zephyr/zephyr.exe
</span></span><span style=display:flex><span>build/zephyr/zephyr.exe: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, BuildID[sha1]=d4b863c9b8d6e9e2265fdef874ec0b9df70efdc9, for GNU/Linux 3.2.0, with debug_info, not stripped
</span></span></code></pre></div><p>And you can call it normally:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ build/zephyr/zephyr.exe
</span></span><span style=display:flex><span>Running TESTSUITE tests
</span></span><span style=display:flex><span>===================================================================
</span></span><span style=display:flex><span>START - demo_test
</span></span><span style=display:flex><span> PASS - demo_test in 0.000 seconds
</span></span><span style=display:flex><span>===================================================================
</span></span><span style=display:flex><span>TESTSUITE tests succeeded
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------ TESTSUITE SUMMARY START ------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SUITE PASS - 100.00% [tests]: pass = 1, fail = 0, skip = 0, total = 1 duration = 0.000 seconds
</span></span><span style=display:flex><span> - PASS - [tests.demo_test] duration = 0.000 seconds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------ TESTSUITE SUMMARY END ------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>===================================================================
</span></span><span style=display:flex><span>PROJECT EXECUTION SUCCESSFUL
</span></span></code></pre></div><p>I will create another blog soon on how to integrate this into Jenkings: by
converting the output into the TAP format.</p><h3 id=define-a-local-board>Define a local board</h3><p>So far, we used boards already defined by the Zephyr source code. But perhaps
you want to use Zephyr on one of your own boards, where you don&rsquo;t plan to
publish it upstream? That&rsquo;s entirely possible, and the board called &ldquo;local&rdquo; of this project is exactly that: a board defined for Zephyr, but out-of-tree.</p><p>The Makefile snippet for it sounds familiar &mldr;</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-9><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-10><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--6f7b48-11><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--6f7b48-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.PHONY:: local
</span></span><span style=display:flex><span>local: .west/config
</span></span><span style=display:flex><span>	west build \
</span></span><span style=display:flex><span>		--pristine \
</span></span><span style=display:flex><span>		-b local \
</span></span><span style=display:flex><span>		-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>		-- \
</span></span><span style=display:flex><span>		-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>		-DOVERLAY_CONFIG=&#34;boards/arm/local/local_defconfig&#34; \
</span></span><span style=display:flex><span>		-DBOARD_ROOT=.
</span></span><span style=display:flex><span>	west build
</span></span></code></pre></td></tr></table></div></div><p>&mldr; but there is some differences:</p><ul><li>line <a href=#org-coderef--6f7b48-9>9</a> gives a full path to the default config of the board</li><li>line <a href=#org-coderef--6f7b48-10>10</a> specifies OUR project (not Zephyr) as the board root. So
Zephyr won&rsquo;t look into &ldquo;<code>zephyr/boards/...</code>&rdquo; but instead into &ldquo;<code>boards/...</code>&rdquo;
when looking for boards.</li></ul><p>Now we need to have such a &ldquo;<code>boards/arm/local/</code>&rdquo; directory and populate it with some files:</p><table><thead><tr><th>File</th><th>Purpose</th></tr></thead><tbody><tr><td>Kconfig.board</td><td>this is where you introduce board-specific Kconfig options</td></tr><tr><td>Kconfig.defconfig</td><td>without setting CONFIG_BOARD to the name of your board, Zephyr wouldn&rsquo;t find the following files</td></tr><tr><td>board.cmake</td><td>can contain CMake definitions, usually used for OpenOCD or JLink settings</td></tr><tr><td>local.dts</td><td>the Device Tree for your board</td></tr><tr><td>local_defconfig</td><td>the default configuaration for your board, only put things there that isn&rsquo;t in &ldquo;<code>prj.conf</code>&rdquo;</td></tr><tr><td>support/openocd.cfg</td><td>if you use OpenOCD, this contains configuration for it</td></tr></tbody></table><h3 id=compiling-some-sources-only-for-some-boards>Compiling some sources only for some boards</h3><p>This can easily be done via &ldquo;<code>CMakeLists.txt</code>&rdquo;:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-7>7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--a1ada1-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--a1ada1-8>8</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>target_sources(app PRIVATE
</span></span><span style=display:flex><span>  main.c)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>target_sources_ifdef(CONFIG_BOARD_LOCAL app PRIVATE
</span></span><span style=display:flex><span>  board_local.c)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>target_sources_ifdef(CONFIG_BOARD_NATIVE_SIM app PRIVATE
</span></span><span style=display:flex><span>  board_native.c)
</span></span></code></pre></td></tr></table></div></div><ul><li>any sources that must compile for every board is specified like in line
<a href=#org-coderef--a1ada1-2>2</a>. Note that the hanging indent is there as a hint that you can
specify multiple source files in one &ldquo;<code>target_source</code>&rdquo; declaration.</li><li>according to line <a href=#org-coderef--a1ada1-4>4</a> the file &ldquo;<code>board_local.c</code>&rdquo; will only be compiled
if your current board is the board named &ldquo;local&rdquo;.</li><li>and you guessed it, line <a href=#org-coderef--a1ada1-7>7</a> makes sure that this source file is only
considered when compiling for the &ldquo;native_sim&rdquo; board. Here I&rsquo;d put the
device-independent unit-tests, for example.</li></ul><p>You can use the CONFIG_ &mldr; variables also direcly in the sources:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>#ifdef CONFIG_BOARD_LOCAL
</span></span><span style=display:flex><span>   LOG_INF(&#34;Running on local&#34;)
</span></span><span style=display:flex><span>endif
</span></span></code></pre></div><h3 id=configuration>Configuration</h3><p>You also learned about the various &ldquo;<code>*.conf</code>&rdquo; files like</p><ul><li>board-specific <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/native_sim.conf>native_sim.conf</a></li><li>board-specific <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/nucleo_f303re.conf>nucleo_f303re.conf</a></li><li>board-specific ones like <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/boards/arm/local/Kconfig.board>boards/arm/local/Kconfig.board</a>, <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/boards/arm/local/Kconfig_defconfig>boards/arm/local/Kconfig_defconfig</a> and <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/boards/arm/local/local_defconfig>boards/arm/local/local_defconfig</a></li><li>the project-wide <a href=https://github.com/holgerschurig/zephyr-multi-board/blob/main/prj.conf>prj.conf</a> file</li></ul><p>But how to find out which &ldquo;<code>CONFIG_*</code>&rdquo; settings you can use?</p><p>Use either</p><ul><li>&ldquo;<code>make menuconfig</code>&rdquo; or</li><li>&ldquo;<code>make xconfig</code>&rdquo;</li></ul><p>When you make changes there and save, you can then just run &ldquo;<code>make</code>&rdquo; to compile
your board with these settings. However, to make these changes permanent (and
thus reproducible), you need to update on of the configuration files I listed
above.</p><h2 id=get-help-from-make>Get help from make</h2><p>I already showed &ldquo;<code>make help_boards</code>&rdquo;. The same method (multiple pseudo makefile
targets emitting helpful text) is available to get an idea of what the Makefile can do for you:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ make help
</span></span><span style=display:flex><span>init                  do all of these steps:
</span></span><span style=display:flex><span>   debs               only install debian packages
</span></span><span style=display:flex><span>   venv               create and check Python3 virtual environment
</span></span><span style=display:flex><span>   west               install and configure the &#39;west&#39; tool
</span></span><span style=display:flex><span>   zephyr             clone Zephyr
</span></span><span style=display:flex><span>   modules            install Zeyphr modules (e.g. ST and STM32 HAL, CMSIS ...)
</span></span><span style=display:flex><span>     module_stm32     update only STM32 HAL
</span></span><span style=display:flex><span>     module_st        update only ST HAL
</span></span><span style=display:flex><span>     module_cmsis     update only CMSIS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>all                   compile for current board
</span></span><span style=display:flex><span>menuconfig            run menuconfig for current board
</span></span><span style=display:flex><span>xconfig               run xconfig for current board
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>native                configure and compile for native (used for unit-tests)
</span></span><span style=display:flex><span>nucleo                configure and compile for STM32 Nucleo
</span></span><span style=display:flex><span>local                 configure and compile for locally defined board
</span></span></code></pre></div><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i>
<time>2024-01-03</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=../../categories/embedded>embedded</a>
<a class=rss type=application/rss+xml href=../../categories/embedded/index.xml><span class="fa fa-rss">RSS</span></a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=../../tags/zephyr>zephyr</a>
<a class=rss type=application/rss+xml href=../../tags/zephyr/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/make>make</a>
<a class=rss type=application/rss+xml href=../../tags/make/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/west>west</a>
<a class=rss type=application/rss+xml href=../../tags/west/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/openocd>OpenOCD</a>
<a class=rss type=application/rss+xml href=../../tags/openocd/index.xml><span class="fa fa-rss">RSS</span></a></div></div></div></div></div><script src=../../js/ui.js></script><script src=../../js/menus.js></script><script src=../../js/math-code.js></script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>