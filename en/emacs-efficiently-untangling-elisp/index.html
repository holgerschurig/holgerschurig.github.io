<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.121.1"><title>Efficiently untangling Elisp from .org files &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title>
<link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel=alternate type=application/rss+xml title="Holger Schurig's Computer Calisthenics & Orthodontia" href=../../index.xml><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beiträge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../topics/><i class='fa fa-folder fa-fw'></i>Topics</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div></div><div id=main><div class=header><h1>Efficiently untangling Elisp from .org files</h1><h2></h2></div><div class=content><p>Many people keep their Emacs config in and org-mode file because it’s
easier to manage.</p><p>However, we need to extract the Elisp parts out of the org file and
evaluate them somehow. org-mode has a built-in command for this:
<code>(org-babel-load-file "config.org")</code>. However, this is an org-mode
command, and org-mode is huge. So your init.el needs to load a good
amount of org-mode just to get the elisp out of it.
But to be able to do this you’d
need to load a good amount of the org-mode file.</p><p>I wanted to have something better. Something that is flexible and
gives me a quicker startup time.</p><p>My method is to do the following:</p><ol><li>If the <code>config.org</code> is newer than <code>config.el</code>, then <strong>efficiently</strong>
extract all <strong>eligible</strong> Elisp source code blocks from the <code>.org</code>
file and write them into the <code>.el</code> file. Even when done efficiently,
this is relatively slow. But it almost never happens.</li><li>then load the <code>config.el</code> file. This is quite fast.</li></ol><p>I wrote two words in bold:</p><ul><li><strong>efficiently:</strong> to un-tangle the source-code blocks I could have
used <code>(org-babel-tangle nil "config.el")</code>. But it opens and
closes the target file for every single source code blocks. You
can hear the churn if you still use spinning rust (a hard disk).
My code fixes this.</li><li><strong>eligible:</strong> we all know than org-tangle honors “<code>:tangle no</code>”. But
it doesn’t care for the todo-state of a section. I wrote my code
so that it will skip over items marked as “CANCELED”. It’s just
nicer to mark one section with “CANCELED” — compared to change
everyone of it’s five source-code blocks with <code>:tangle no</code>.</li></ul><h1 id=the-tangling>The tangling</h1><p>First I define a function that — when the point is at some source-code block —
goes back to the section header and checks if there entry has been canceled:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span><span style=color:#75715e>;; This is GPLv2. If you still don&#39;t know the details, read</span>
</span></span><span style=display:flex><span><span style=color:#75715e>;; http://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(defun my-tangle-section-canceled ()
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;Return t if the current section header was CANCELED, else nil.&#34;</span>
</span></span><span style=display:flex><span>  (save-excursion
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>if</span> (re-search-backward <span style=color:#e6db74>&#34;^\\*+\\s-+\\(.*?\\)?\\s-*$&#34;</span> <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>t</span>)
</span></span><span style=display:flex><span>        (string-prefix-p <span style=color:#e6db74>&#34;CANCELED&#34;</span> (match-string <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>nil</span>)))
</span></span></code></pre></div><p>With that done, we can untangle source-code blocks like this:</p><ul><li>disabled garbage collection</li><li>defines the regexp (stolen from org-mode) to parse org-mode source blocks</li><li>uses a while-loop to search every source-block</li><li>checks that the source block is neither untangleable nor in a CANCELED section</li><li>appends the body of the source block to <code>body-list</code></li><li>finally, it uses a temporary file and insert all the collected bodies into it</li><li>and writes the result out into a <code>.el</code>-file</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span><span style=color:#75715e>;; This uses partially derived code from ob-core.el. So this snippet</span>
</span></span><span style=display:flex><span><span style=color:#75715e>;; is GPLv3 or later. If you still don&#39;t know the details, read</span>
</span></span><span style=display:flex><span><span style=color:#75715e>;; http://www.gnu.org/licenses/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(defun my-tangle-config-org (orgfile elfile)
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;This function will write all source blocks from =config.org= into
</span></span></span><span style=display:flex><span><span style=color:#e6db74>=config.el= that are ...
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- not marked as :tangle no
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- have a source-code of =emacs-lisp=
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- doesn&#39;t have the todo-marker CANCELED&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let*</span> ((body-list ())
</span></span><span style=display:flex><span>         (gc-cons-threshold most-positive-fixnum)
</span></span><span style=display:flex><span>         (org-babel-src-block-regexp   (concat
</span></span><span style=display:flex><span>                                        <span style=color:#75715e>;; (1) indentation                 (2) lang</span>
</span></span><span style=display:flex><span>                                        <span style=color:#e6db74>&#34;^\\([ \t]*\\)#\\+begin_src[ \t]+\\([^ \f\t\n\r\v]+\\)[ \t]*&#34;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#75715e>;; (3) switches</span>
</span></span><span style=display:flex><span>                                        <span style=color:#e6db74>&#34;\\([^\&#34;:\n]*\&#34;[^\&#34;\n*]*\&#34;[^\&#34;:\n]*\\|[^\&#34;:\n]*\\)&#34;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#75715e>;; (4) header arguments</span>
</span></span><span style=display:flex><span>                                        <span style=color:#e6db74>&#34;\\([^\n]*\\)\n&#34;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#75715e>;; (5) body</span>
</span></span><span style=display:flex><span>                                        <span style=color:#e6db74>&#34;\\([^\000]*?\n\\)??[ \t]*#\\+end_src&#34;</span>)))
</span></span><span style=display:flex><span>    (with-temp-buffer
</span></span><span style=display:flex><span>      (insert-file-contents orgfile)
</span></span><span style=display:flex><span>      (goto-char (point-min))
</span></span><span style=display:flex><span>      (while (re-search-forward org-babel-src-block-regexp <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>t</span>)
</span></span><span style=display:flex><span>        (<span style=color:#66d9ef>let</span> ((lang (match-string <span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span>              (args (match-string <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>              (body (match-string <span style=color:#ae81ff>5</span>))
</span></span><span style=display:flex><span>              (canc (my-tangle-section-canceled)))
</span></span><span style=display:flex><span>          (when (and (<span style=color:#a6e22e>string=</span> lang <span style=color:#e6db74>&#34;emacs-lisp&#34;</span>)
</span></span><span style=display:flex><span>                     (<span style=color:#a6e22e>not</span> (string-match-p <span style=color:#e6db74>&#34;:tangle\\s-+no&#34;</span> args))
</span></span><span style=display:flex><span>                     (<span style=color:#a6e22e>not</span> canc))
</span></span><span style=display:flex><span>              (add-to-list <span style=color:#e6db74>&#39;body-list</span> body)))))
</span></span><span style=display:flex><span>    (with-temp-file elfile
</span></span><span style=display:flex><span>      (insert (<span style=color:#a6e22e>format</span> <span style=color:#e6db74>&#34;;; Don&#39;t edit this file, edit %s instead ...\n\n&#34;</span> orgfile))
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>apply</span> <span style=color:#e6db74>&#39;insert</span> (<span style=color:#a6e22e>reverse</span> body-list)))
</span></span><span style=display:flex><span>    (message <span style=color:#e6db74>&#34;Wrote %s ...&#34;</span> elfile)))
</span></span></code></pre></div><h1 id=the-usage>The Usage</h1><p>Now I can use this function. If either the <code>.el</code> file doesn’t exist or
the <code>.org</code> file is newer, I’ll re-create the <code>.el</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span><span style=color:#75715e>;; This is GPLv2. If you still don&#39;t know the details, read</span>
</span></span><span style=display:flex><span><span style=color:#75715e>;; http://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>let</span> ((orgfile (concat user-emacs-directory <span style=color:#e6db74>&#34;config.org&#34;</span>))
</span></span><span style=display:flex><span>      (elfile (concat user-emacs-directory <span style=color:#e6db74>&#34;config.el&#34;</span>)))
</span></span><span style=display:flex><span>  (when (or (<span style=color:#a6e22e>not</span> (file-exists-p elfile))
</span></span><span style=display:flex><span>            (file-newer-than-file-p orgfile elfile))
</span></span><span style=display:flex><span>    (my-tangle-config-org orgfile elfile))
</span></span><span style=display:flex><span>  (load-file elfile))
</span></span></code></pre></div><p>This code is mostly active when I update my emacs configuration with
<code>git pull</code>, e.g. when switching from desktop to laptop or vica versa.</p><h1 id=also-tangle-on-save>Also tangle on save</h1><p>But normally I’d like to avoid even this. I wrote a function that is
called whenever I save a file. It checks if the file is indeed the
.org file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span><span style=color:#75715e>;; This is GPLv2. If you still don&#39;t know the details, read</span>
</span></span><span style=display:flex><span><span style=color:#75715e>;; http://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(defun my-tangle-config-org-hook-func ()
</span></span><span style=display:flex><span>  (when (<span style=color:#a6e22e>string=</span> <span style=color:#e6db74>&#34;config.org&#34;</span> (buffer-name))
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>let</span> ((orgfile (concat user-emacs-directory <span style=color:#e6db74>&#34;config.org&#34;</span>))
</span></span><span style=display:flex><span>          (elfile (concat user-emacs-directory <span style=color:#e6db74>&#34;config.el&#34;</span>)))
</span></span><span style=display:flex><span>      (my-tangle-config-org orgfile elfile))))
</span></span><span style=display:flex><span>(add-hook <span style=color:#e6db74>&#39;after-save-hook</span> <span style=color:#a6e22e>#&#39;</span>my-tangle-config-org-hook-func)
</span></span></code></pre></div><h1 id=some-benchmark-results>Some benchmark results</h1><p>You’ll see that …</p><ul><li>my approach is 0.32 seconds faster than using <code>org-babel-load-file</code>.
But I have the added benefit that I can mark sections as CANCELED
:-)</li><li>after a fresh “git pull”, I pay a very low price of 0.09 seconds</li><li>byte-compilation doesn’t bring much for this file …</li></ul><p>All measurements were done on my laptop. My desktop is about double as fast.</p><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i>
<time>2016-05-12</time></div><div><i class="fa fa-folder fa-fw"></i>
<a class=post-taxonomy-topic href=../../topics/emacs>Emacs</a>
<a class=rss type=application/rss+xml href=../../topics/emacs/index.xml><span class="fa fa-rss">RSS</span></a></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=../../tags/emacs>Emacs</a>
<a class=rss type=application/rss+xml href=../../tags/emacs/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/org-mode>org-mode</a>
<a class=rss type=application/rss+xml href=../../tags/org-mode/index.xml><span class="fa fa-rss">RSS</span></a></div></div></div></div></div><script src=../../js/ui.js></script><script src=../../js/menus.js></script><script src=../../js/math-code.js></script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>