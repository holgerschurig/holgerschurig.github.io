<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.121.1"><title>Multi-Board setup for Zephyr &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title>
<link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel=alternate type=application/rss+xml title="Holger Schurig's Computer Calisthenics & Orthodontia" href=../../index.xml><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beitr√§ge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../topics/><i class='fa fa-folder fa-fw'></i>Topics</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div></div><div id=main><div class=header><h1>Multi-Board setup for Zephyr</h1><h2></h2></div><div class=content><h2 id=why>Why?</h2><p>Here I document how to compile one Zephyr RTOS source-code base against
different targets. Why can this be helpful?</p><ul><li>your EE collegues are cool &mldr; but still you need to wait longer than expected
for the prototype board. In the meantime, you want to start development on
some development board, like Nucleo or Disco</li><li>some of your logic can be checked via unit-tests &mdash; and luckily Zephyr has a
<a href=https://docs.zephyrproject.org/latest/develop/test/ztest.html>test framework</a> built it. It would however be swell if you CI/CD pipeline could
automatically run these tests, e.g. with the help of <a href=https://docs.zephyrproject.org/latest/boards/posix/native_sim/doc/index.html>native_sim</a></li><li>you develop very similar firmware for different devices and you only want one
source code base for all of them. Differences between the device you want to
abstract in board-specific files.</li></ul><h2 id=get-list-of-defined-board>Get list of defined board</h2><p>Basically by setting up a project like at <a href=http://github.com/holgerschurig/multi-board-zepyhr>http://github.com/holgerschurig/multi-board-zepyhr</a></p><p>You start there by reading the main <a href=http://github.com/holgerschurig/multi-board-zepyhr/Makefile>Makefile</a> (for now, we ignore the boilerplate
Makefile.zephyr_init, that might be a future post).</p><p>You can think of this Makefile as &mdash; mostly &mdash; a list of small shell scripts,
combined into one Makefile, and accessible thus not via &ldquo;<code>bin/foo.sh</code>&rdquo; but via
&ldquo;<code>make foo</code>&rdquo;. While some think that the syntax of Makefiles are arcane, it&rsquo;s
still nice enough to have them collect all kind of knowledge tidbits. And also,
occassionally, to use Make&rsquo;s ability of doing dependencies.</p><h2 id=define-boards-in-the-makefile>Define boards in the Makefile</h2><p>So, if you want to compile the source, you simply run &mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ make
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-----------------------------------------------------------------------------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You must first select with with board you want to work:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>native                configure for native (used for unit-tests)
</span></span><span style=display:flex><span>nucleo                compile for STM32 Nucleo
</span></span><span style=display:flex><span>local                 configure for locally defined board
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-----------------------------------------------------------------------------
</span></span></code></pre></div><p>Oh, that didn&rsquo;t run too well. Basically the Makefile detected with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>all::
</span></span><span style=display:flex><span>ifeq (&#34;$(wildcard build/build.ninja)&#34;,&#34;&#34;)
</span></span><span style=display:flex><span>	@$(call show_boards)
</span></span><span style=display:flex><span>else
</span></span><span style=display:flex><span>	ninja -C build
</span></span><span style=display:flex><span>endif
</span></span></code></pre></div><p>The &ldquo;<code>wildcard</code>&rdquo; Makefile function determines if the <code>build/build.ninja</code>" already exists. If not, you&rsquo;ll see a list of all defined boards &mdash; that is, if they are in your Makefile and have a section like this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>help help_boards::
</span></span><span style=display:flex><span>	@echo &#34;nucleo                compile for STM32 Nucleo&#34;
</span></span></code></pre></div><p>to make them emit info about itself.</p><h2 id=configure-source-for-native-simulation>Configure source for native simulation</h2><p>So now that we know that we first need to configure for one board, we select one board and run e.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ make native
</span></span><span style=display:flex><span>west build \
</span></span><span style=display:flex><span>	--pristine \
</span></span><span style=display:flex><span>	-b native_sim \
</span></span><span style=display:flex><span>	-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>	-- \
</span></span><span style=display:flex><span>	-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>	-DOVERLAY_CONFIG=&#34;native_sim.conf&#34;
</span></span><span style=display:flex><span>-- west build: making build dir /home/holger/src/multi-board-zephyr/build pristine
</span></span><span style=display:flex><span>-- west build: generating a build system
</span></span><span style=display:flex><span>Loading Zephyr default modules (Zephyr base).
</span></span><span style=display:flex><span>-- Application: /home/holger/src/multi-board-zephyr
</span></span><span style=display:flex><span>-- CMake version: 3.28.1
</span></span><span style=display:flex><span>-- Found Python3: /home/holger/src/multi-board-zephyr/.venv/bin/python3 (found suitable version &#34;3.11.7&#34;, minimum required is &#34;3.8&#34;) found components: Interpreter
</span></span><span style=display:flex><span>-- Cache files will be written to: /home/holger/.cache/zephyr
</span></span><span style=display:flex><span>-- Zephyr version: 3.5.99 (/home/holger/src/multi-board-zephyr/zephyr)
</span></span><span style=display:flex><span>-- Found west (found suitable version &#34;1.2.0&#34;, minimum required is &#34;0.14.0&#34;)
</span></span><span style=display:flex><span>-- Board: native_sim
</span></span><span style=display:flex><span>-- Found host-tools: zephyr 0.16.4 (/home/holger/d/v73/.west/zephyr-sdk-0.16.4)
</span></span><span style=display:flex><span>-- Found toolchain: host (gcc/ld)
</span></span><span style=display:flex><span>-- Found Dtc: /home/holger/d/v73/.west/zephyr-sdk-0.16.4/sysroots/x86_64-pokysdk-linux/usr/bin/dtc (found suitable version &#34;1.6.0&#34;, minimum required is &#34;1.4.6&#34;)
</span></span><span style=display:flex><span>-- Found BOARD.dts: /home/holger/src/multi-board-zephyr/zephyr/boards/posix/native_sim/native_sim.dts
</span></span><span style=display:flex><span>-- Generated zephyr.dts: /home/holger/src/multi-board-zephyr/build/zephyr/zephyr.dts
</span></span><span style=display:flex><span>-- Generated devicetree_generated.h: /home/holger/src/multi-board-zephyr/build/zephyr/include/generated/devicetree_generated.h
</span></span><span style=display:flex><span>-- Including generated dts.cmake file: /home/holger/src/multi-board-zephyr/build/zephyr/dts.cmake
</span></span><span style=display:flex><span>Parsing /home/holger/src/multi-board-zephyr/zephyr/Kconfig
</span></span><span style=display:flex><span>Loaded configuration &#39;/home/holger/src/multi-board-zephyr/zephyr/boards/posix/native_sim/native_sim_defconfig&#39;
</span></span><span style=display:flex><span>Merged configuration &#39;/home/holger/src/multi-board-zephyr/prj.conf&#39;
</span></span><span style=display:flex><span>Merged configuration &#39;/home/holger/src/multi-board-zephyr/native_sim.conf&#39;
</span></span><span style=display:flex><span>Configuration saved to &#39;/home/holger/src/multi-board-zephyr/build/zephyr/.config&#39;
</span></span><span style=display:flex><span>Kconfig header saved to &#39;/home/holger/src/multi-board-zephyr/build/zephyr/include/generated/autoconf.h&#39;
</span></span><span style=display:flex><span>-- Found GnuLd: /usr/bin/ld.bfd (found version &#34;2.41.50&#34;)
</span></span><span style=display:flex><span>-- The C compiler identification is GNU 13.2.0
</span></span><span style=display:flex><span>-- The CXX compiler identification is GNU 13.2.0
</span></span><span style=display:flex><span>-- The ASM compiler identification is GNU
</span></span><span style=display:flex><span>-- Found assembler: /usr/bin/gcc
</span></span><span style=display:flex><span>-- Configuring done (9.4s)
</span></span><span style=display:flex><span>-- Generating done (0.0s)
</span></span><span style=display:flex><span>-- Build files have been written to: /home/holger/src/multi-board-zephyr/build
</span></span><span style=display:flex><span>-- west build: building application
</span></span><span style=display:flex><span>ninja: no work to do.
</span></span><span style=display:flex><span>west build
</span></span><span style=display:flex><span>[1/93] Preparing syscall dependency handling
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[3/93] Generating include/generated/version.h
</span></span><span style=display:flex><span>-- Zephyr version: 3.5.99 (/home/holger/src/multi-board-zephyr/zephyr), build: zephyr-v3.5.0-3543-g89982b711bbd
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>make[1]: Leaving directory &#39;/home/holger/src/multi-board-zephyr/build/zephyr&#39;
</span></span><span style=display:flex><span>[93/93] cd /home/holger/src/multi-board-zephyr/bui...ger/src/multi-board-zephyr/build/zephyr/zephyr.ex
</span></span><span style=display:flex><span>(.venv) holger@holger:~/src/multi-board-zephyr$
</span></span></code></pre></div><p>And now we can run our source compiled against the (Zephyr included) native_sim board:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ build/zephyr/zephyr.exe
</span></span><span style=display:flex><span>Running TESTSUITE tests
</span></span><span style=display:flex><span>===================================================================
</span></span><span style=display:flex><span>START - demo_test
</span></span><span style=display:flex><span> PASS - demo_test in 0.000 seconds
</span></span><span style=display:flex><span>===================================================================
</span></span><span style=display:flex><span>TESTSUITE tests succeeded
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------ TESTSUITE SUMMARY START ------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SUITE PASS - 100.00% [tests]: pass = 1, fail = 0, skip = 0, total = 1 duration = 0.000 seconds
</span></span><span style=display:flex><span> - PASS - [tests.demo_test] duration = 0.000 seconds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------ TESTSUITE SUMMARY END ------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>===================================================================
</span></span><span style=display:flex><span>PROJECT EXECUTION SUCCESSFUL
</span></span></code></pre></div><p>As you can see, this runs the unit-tests.</p><h2 id=change-configuration-interactively>Change configuration interactively</h2><p>After you configured for any board (e.g. you have a <code>build/</code> directory), you can look or modify
Zephyr&rsquo;s configuration, use one of these:</p><ul><li><code>make xconfig</code></li><li><code>make menuconfig</code></li></ul><p>You can then compile. But should you ever re-configure your project, your
changes will be gone. Instead, modify some of the configuration files:</p><h2 id=change-configuration-by>Change configuration by</h2><p>However, any change you do there will be forgotten if you re-configure your
source. To keep them permanent, modify one of the <code>*.conf</code> files. Since we&rsquo;re
still working with the native_sim board, we would therefore change
&ldquo;<code>native_sim.conf</code>&rdquo;.</p><p>Use the following config files:</p><table><thead><tr><th>Config file</th><th>Purpose</th></tr></thead><tbody><tr><td>native_sim.conf</td><td>for the Zephyr-built-in native_sim board</td></tr><tr><td>nucleo_f303re.conf</td><td>for the Zephyr-built-in nucleo_f303re board</td></tr><tr><td>boards/*/*/*_defconfig</td><td>for a locally defined board</td></tr><tr><td>prj.conf</td><td>for any configuration that is applicable to all of your boards</td></tr></tbody></table><h2 id=compile-for-a-real-board>Compile for a &ldquo;real&rdquo; board</h2><p>Now we decide to compile our source against a &ldquo;real&rdquo; board, e.g. against the (Zephyr include) STM32 Nucleo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/src/multi-board-zephyr$ make nucleo
</span></span><span style=display:flex><span>west build \
</span></span><span style=display:flex><span>	--pristine \
</span></span><span style=display:flex><span>	-b nucleo_f303re \
</span></span><span style=display:flex><span>	-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>	-- \
</span></span><span style=display:flex><span>	-Wno-dev \
</span></span><span style=display:flex><span>	-Wno-deprecated \
</span></span><span style=display:flex><span>	-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>	-DOVERLAY_CONFIG=&#34;nucleo_f303re.conf&#34;
</span></span><span style=display:flex><span>-- west build: making build dir /home/holger/src/multi-board-zephyr/build pristine
</span></span><span style=display:flex><span>-- west build: generating a build system
</span></span><span style=display:flex><span>Loading Zephyr default modules (Zephyr base).
</span></span><span style=display:flex><span>-- Application: /home/holger/src/multi-board-zephyr
</span></span><span style=display:flex><span>-- CMake version: 3.28.1
</span></span><span style=display:flex><span>-- Found Python3: /home/holger/src/multi-board-zephyr/.venv/bin/python3 (found suitable version &#34;3.11.7&#34;, minimum required is &#34;3.8&#34;) found components: Interpreter
</span></span><span style=display:flex><span>-- Cache files will be written to: /home/holger/.cache/zephyr
</span></span><span style=display:flex><span>-- Zephyr version: 3.5.99 (/home/holger/src/multi-board-zephyr/zephyr)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>[146/147] Linking C executable zephyr/zephyr.elf
</span></span><span style=display:flex><span>Memory region         Used Size  Region Size  %age Used
</span></span><span style=display:flex><span>           FLASH:       39782 B       512 KB      7.59%
</span></span><span style=display:flex><span>             RAM:        9792 B        64 KB     14.94%
</span></span><span style=display:flex><span>             CCM:          0 GB        16 KB      0.00%
</span></span><span style=display:flex><span>        IDT_LIST:          0 GB         2 KB      0.00%
</span></span><span style=display:flex><span>Generating files from /home/holger/src/multi-board-zephyr/build/zephyr/zephyr.elf for board: nucleo_f303re
</span></span><span style=display:flex><span>[147/147] cd /home/holger/src/multi-board-zephyr/b...ger/src/multi-board-zephyr/build/zephyr/zephyr.el
</span></span></code></pre></div><p>This time, we get not an <code>"zephyr.exe</code>" file, but instead an ARM blob:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>:~/src/multi-board-zephyr$ file build/zephyr/zephyr.bin
</span></span><span style=display:flex><span>build/zephyr/zephyr.bin: ARM Cortex-M firmware, initial SP at 0x20001fc0, reset at 0x08002f30, NMI at 0x08002bec, HardFault at 0x08002f1c, SVCall at 0x08003054, PendSV at 0x08002fec
</span></span></code></pre></div><h2 id=compile-for-an-out-of-tree-board>Compile for an out-of-tree board</h2><p>So far, we only used boards that are brought to us via the Zephyr source code itself.</p><p>You can however also define your own board, outside of Zephyr, and compile against this board. In this
project, I named the board &ldquo;<code>local</code>&rdquo;.</p><p>For this, you need to create a structure inside the <code>boards/</code> directory, e.g. like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>boards/arm/local/Kconfig.board
</span></span><span style=display:flex><span>boards/arm/local/Kconfig.defconfig
</span></span><span style=display:flex><span>boards/arm/local/board.cmake
</span></span><span style=display:flex><span>boards/arm/local/local.dts
</span></span><span style=display:flex><span>boards/arm/local/local.yaml
</span></span><span style=display:flex><span>boards/arm/local/local_defconfig
</span></span><span style=display:flex><span>boards/arm/local/support/openocd.cfg
</span></span></code></pre></div><p>The file &ldquo;<code>local_defconfig</code>&rdquo; is the equivalent of the &ldquo;<code>*.conf</code>&rdquo; files in the main directory.</p><p>Once you have this, you can reconfigure and build your source against this local target:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>:~/src/multi-board-zephyr$ make local
</span></span><span style=display:flex><span>west build \
</span></span><span style=display:flex><span>	--pristine \
</span></span><span style=display:flex><span>	-b local \
</span></span><span style=display:flex><span>	-o &#34;build.ninja&#34; \
</span></span><span style=display:flex><span>	-- \
</span></span><span style=display:flex><span>	-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
</span></span><span style=display:flex><span>	-DOVERLAY_CONFIG=&#34;boards/arm/local/local_defconfig&#34; \
</span></span><span style=display:flex><span>	-DBOARD_ROOT=.
</span></span><span style=display:flex><span>-- west build: generating a build system
</span></span><span style=display:flex><span>Loading Zephyr default modules (Zephyr base).
</span></span><span style=display:flex><span>-- Application: /home/holger/src/multi-board-zephyr
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>[146/147] Linking C executable zephyr/zephyr.elf
</span></span><span style=display:flex><span>Memory region         Used Size  Region Size  %age Used
</span></span><span style=display:flex><span>           FLASH:       39544 B       512 KB      7.54%
</span></span><span style=display:flex><span>             RAM:        9792 B        64 KB     14.94%
</span></span><span style=display:flex><span>             CCM:          0 GB        16 KB      0.00%
</span></span><span style=display:flex><span>        IDT_LIST:          0 GB         2 KB      0.00%
</span></span><span style=display:flex><span>Generating files from /home/holger/src/multi-board-zephyr/build/zephyr/zephyr.elf for board: local
</span></span><span style=display:flex><span>[147/147] cd /home/holger/src/multi-board-zephyr/b...ger/src/multi-board-zephyr/build/zephyr/zephyr.el
</span></span></code></pre></div><p>Note that the command line parameters to West are slightly different: the &ldquo;<code>-DOVERLAY_CONFIG=boards/arm/local/local_defconfig</code>&rdquo; argument points to our board file</p><h2 id=compile-only-some-files-for-some-boards>Compile only some files for some boards</h2><p>In the main &ldquo;<code>CMakeLists.txt</code>&rdquo; you can specify that some files are only compiled
for some board. For example, one of your boards has GNSS; but other not. Then
you would do something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>target_sources_ifdef(CONFIG_BOARD_LOCAL app PRIVATE
</span></span><span style=display:flex><span>  local.c)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>target_sources_ifdef(CONFIG_BOARD_LOCAL_GNSS app PRIVATE
</span></span><span style=display:flex><span>  local.c
</span></span><span style=display:flex><span>  gnss.c)
</span></span></code></pre></div><p>That is, the &ldquo;<code>local.c</code>&rdquo; source code will be compiled for both the boards
&ldquo;local&rdquo; and &ldquo;local_gnss&rdquo;. But the latter, &ldquo;=local_gnss.c&rdquo; will also be compiled.</p><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i>
<time>2024-01-02</time></div><div><i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=../../tags/zephyr>zephyr</a>
<a class=rss type=application/rss+xml href=../../tags/zephyr/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/make>make</a>
<a class=rss type=application/rss+xml href=../../tags/make/index.xml><span class="fa fa-rss">RSS</span></a>
&nbsp;/
<a class=post-taxonomy-tag href=../../tags/west>west</a>
<a class=rss type=application/rss+xml href=../../tags/west/index.xml><span class="fa fa-rss">RSS</span></a></div></div></div></div></div><script src=../../js/ui.js></script><script src=../../js/menus.js></script><script src=../../js/math-code.js></script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>