<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.108.0"><title>notmuch: polling mail with mbsync &#183; Holger Schurig's Computer Calisthenics & Orthodontia</title><link rel=stylesheet href=../../css/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=../../css/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=../../css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=../../css/side-menu.css><!--<![endif]--><link rel=stylesheet href=../../css/blackburn.css><link rel=stylesheet href=../../css/all.min.css><link rel="shortcut icon" href=../../img/favicon.ico type=image/x-icon></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=../../><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../en/><i class='fa fa-list fa-fw'></i>Articles</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../de/><i class='fa fa-list fa-fw'></i>Beitr√§ge</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../topics/><i class='fa fa-folder fa-fw'></i>Topics</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../tags/><i class='fa fa-tags fa-fw'></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=../../impressum/><i class='fa fa-phone fa-fw'></i>Impressum</a></li></ul></div><div><div class=small-print><small></small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div></div></div><div id=main><div class=header><h1>notmuch: polling mail with mbsync</h1><h2></h2></div><div class=content><p>In this blog post I describe how I configured <code>mbsync</code> 1.3.0 and
<code>notmuch</code> 0.22 so that they get my mail out of GMail&rsquo;s IMAP service.</p><h2 id=systemd-units>Systemd units</h2><p>I want to have systemd poll mail for me every our. As I disabled
per-user systemd services, I wrote the following two unit files for
the system systemd:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># /etc/systemd/system/mbsync.timer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Unit]
</span></span><span style=display:flex><span>Description=Mailbox synchronization timer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Timer]
</span></span><span style=display:flex><span>OnCalendar=*-*-* 00/1:00:00
</span></span><span style=display:flex><span>Persistent=true
</span></span><span style=display:flex><span>Unit=mbsync.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Install]
</span></span><span style=display:flex><span>WantedBy=timers.target
</span></span></code></pre></div><p>and</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># /etc/systemd/system/mbsync.service 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Unit]
</span></span><span style=display:flex><span>Description=Mailbox synchronization service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Service]
</span></span><span style=display:flex><span>Type=oneshot
</span></span><span style=display:flex><span>ExecStart=/home/schurig/bin/pollmail.sh
</span></span><span style=display:flex><span>User=schurig
</span></span></code></pre></div><h2 id=propagate-mail-deletions>Propagate mail deletions</h2><p>My Emacs notmuch client tags mails to be deleted with <code>+deleted</code>. And
this here deletes them for real. This is based on the
<a href=https://notmuchmail.org/excluding/>Excluding</a> entry of the notmuch
wiki:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>propagate_deletions<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	local COUNT<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>notmuch count tag:deleted<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>	test <span style=color:#e6db74>&#34;</span>$COUNT<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	echo <span style=color:#e6db74>&#34;- deleting </span>$COUNT<span style=color:#e6db74> messages ...&#34;</span>
</span></span><span style=display:flex><span>	notmuch search --format<span style=color:#f92672>=</span>text0 --output<span style=color:#f92672>=</span>files tag:deleted | xargs -0 --no-run-if-empty rm
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=get-new-mail>Get new mail</h2><p>I used <code>offlineimap</code> for some time, but now I switched to <code>mbsync</code>
1.3.0 for it. I like it slighly better.</p><p>Because I don&rsquo;t want to only get new mails, but also &ldquo;mangle&rdquo; the mail
in defined ways, I wrote a <code>~/bin/pollmail.sh</code> helper script.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sync_mail<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	local CHANNELS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$*<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		CHANNELS<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>awk <span style=color:#e6db74>&#39;/^Channel/ { print $2; }&#39;</span> .mbsyncrc<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>		CHANNELS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$*<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> i in $CHANNELS; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>		echo <span style=color:#e6db74>&#34;- syncing mail in </span>$i<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>		mbsync $i
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>There&rsquo;s a reason why I use the <code>mbsync &lt;channel></code> calling variant over
<code>mbsync &lt;group></code>. When mbsync takes a long time for syncing, I
wouldn&rsquo;t (in the group-version) not see where it uses up it&rsquo;s time.
But when iterating over the channels like above there is an echo for
each processed channel in the systemd journal.</p><h2 id=ignoring-uninteresting-mail>Ignoring uninteresting mail</h2><p>I&rsquo;ve written an extra blog entry about <a href=../../en/notmuch-mark-uninteresting>this</a>.</p><h2 id=binding-it-all-together>Binding it all together</h2><p>The final part is the <code>getops</code>-based mini-logic of the script. It behaves like this:</p><ul><li>when I run it without any command line arguments it does all: delete mail, get
new mail, import mail into notmuch, mark uninteresting</li><li>calling it with <code>-d</code> only delete mails and then stops</li><li>callit it with <code>-u</code> only marks uninteresing mail and then stops. I use this
when I add new uninteresting terms.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>DO_STOP<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> getopts <span style=color:#e6db74>&#34;sud&#34;</span> opt; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> $opt in
</span></span><span style=display:flex><span>		d<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>			DO_STOP<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>			propagate_deletions
</span></span><span style=display:flex><span>			;;
</span></span><span style=display:flex><span>		u<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>			DO_STOP<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>			mark_uninteresting
</span></span><span style=display:flex><span>			;;
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>\?</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>			echo <span style=color:#e6db74>&#34;Invalid option: -</span>$OPTARG<span style=color:#e6db74>&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>			;;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>esac</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>test <span style=color:#e6db74>&#34;</span>$DO_STOP<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> true <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>shift <span style=color:#66d9ef>$((</span>OPTIND-1<span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>propagate_deletions
</span></span><span style=display:flex><span>sync_mail <span style=color:#e6db74>&#34;</span>$*<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;- loading new mails into notmuch&#34;</span>
</span></span><span style=display:flex><span>notmuch new
</span></span><span style=display:flex><span>mark_uninteresting
</span></span></code></pre></div><h2 id=mbsyncrc>.mbsyncrc</h2><p>This all works together with the following <code>~/.mbsyncrc</code> file:</p><h2 id=storing-state>Storing state</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># snippet from ~/.mbsyncrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SyncState *
</span></span></code></pre></div><p>This makes <code>mbsync</code> store it&rsquo;s metadata in <code>.mail/*/.mbsyncstate</code>. We can in turn make notmuch
ignore this by adding this to <code>~/.notmuch-config</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># snippet from ~/.notmuch-config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[new]
</span></span><span style=display:flex><span>ignore=.uidvalidity;.mbsyncstate
</span></span></code></pre></div><p>Storing state in the subdirectory is nice because you can then simply
run <code>rm -rf ~/.mail/powertop</code> to get rid of the powertop mails
including their state.</p><h2 id=speed-not-reliability>Speed, not reliability</h2><p>As GMail is nice to save all of my e-mails in their data-centers, I don&rsquo;t need
ultra reliability here. I always can re-create the mails if in need.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># snippet from ~/.mbsyncrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Fsync no
</span></span></code></pre></div><h2 id=default-settings-for-all-channels>Default settings for all channels</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># snippet from ~/.mbsyncrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CopyArrivalDate yes
</span></span><span style=display:flex><span>Create Slave
</span></span><span style=display:flex><span>Sync All
</span></span><span style=display:flex><span>Expunge Both
</span></span></code></pre></div><ul><li><code>CopyArrivalDate</code> is an attempt to keep the time-stamp based sorting intact</li><li><code>Create</code> makes sure that mbsync will automatically create
<code>~/.mail/$channelname</code> if not already present</li><li><code>Sync</code> makes sure that all IMAP attributes will be synchronized</li><li><code>Expunge</code> makes sure that removed local files in the Maildir folder
will be removed from IMAP as well &mldr; and vica verca</li></ul><h2 id=imap-account>IMAP account</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># snippet from ~/.mbsyncrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IMAPAccount gmail
</span></span><span style=display:flex><span>	Host imap.gmail.com
</span></span><span style=display:flex><span>	User holgerschurig@gmail.com
</span></span><span style=display:flex><span>	PassCmd &#34;awk -F &#39;\&#34;&#39; &#39;/imap/ { print $2 }&#39; ~/.authinfo&#34;
</span></span><span style=display:flex><span>	SSLType IMAPS
</span></span><span style=display:flex><span>	CertificateFile /etc/ssl/certs/ca-certificates.crt
</span></span></code></pre></div><p>The above line works because I have an <code>~/.authinfo</code> file that roughly looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># ~/.authinfo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>machine imap.gmail.com login holgerschurig@gmail.com password &#34;secret&#34; port imaps
</span></span><span style=display:flex><span>machine smtp.gmail.com login holgerschurig@gmail.com password &#34;secret&#34; port 587
</span></span></code></pre></div><p>That&rsquo;s a remnant from the times where I used GNUS for e-mail. But as it&rsquo;s still there,
let&rsquo;s re-use it.</p><h2 id=mail-stores>Mail stores</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># snippet from ~/.mbsyncrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MaildirStore local
</span></span><span style=display:flex><span>	Subfolders Verbatim
</span></span><span style=display:flex><span>	Path /home/schurig/.mail/
</span></span><span style=display:flex><span>	Inbox /home/schurig/.mail/INBOX
</span></span><span style=display:flex><span>	Trash /home/schurig/.mail/trash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IMAPStore remote
</span></span><span style=display:flex><span>	Account gmail
</span></span></code></pre></div><h2 id=channels>Channels</h2><p>One channel, &ldquo;trash&rdquo;, needs special treatment. Because this because Google Mail
exposes localized names into their IMAP folder names. I need to rename this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># snippet from ~/.mbsyncrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Channel trash
</span></span><span style=display:flex><span>	Master :remote:&#34;[Google Mail]/Papierkorb&#34;
</span></span><span style=display:flex><span>	Slave  :local:trash
</span></span></code></pre></div><p>All the other channels are straightforward:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># snippet from ~/.mbsyncrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Channel inbox
</span></span><span style=display:flex><span>	Master :remote:INBOX
</span></span><span style=display:flex><span>	Slave  :local:INBOX
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Channel ath9k-devel
</span></span><span style=display:flex><span>	Master :remote:ath9k-devel
</span></span><span style=display:flex><span>	Slave  :local:ath9k-devel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Channel barebox
</span></span><span style=display:flex><span>	Master :remote:barebox
</span></span><span style=display:flex><span>	Slave  :local:barebox
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Channel darc-sdr
</span></span><span style=display:flex><span>	Master :remote:darc-sdr
</span></span><span style=display:flex><span>	Slave  :local:darc-sdr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Channel elecraft
</span></span><span style=display:flex><span>	Master :remote:elecraft
</span></span><span style=display:flex><span>	Slave  :local:elecraft
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Channel linux-can
</span></span><span style=display:flex><span>	Master :remote:linux-can
</span></span><span style=display:flex><span>	Slave  :local:linux-can
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Channel linux-arm-kernel
</span></span><span style=display:flex><span>	Master :remote:linux-arm-kernel
</span></span><span style=display:flex><span>	Slave  :local:linux-arm-kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Channel linux-mmc
</span></span><span style=display:flex><span>	Master :remote:linux-mmc
</span></span><span style=display:flex><span>	Slave  :local:linux-mmc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Channel powertop
</span></span><span style=display:flex><span>	Master :remote:powertop
</span></span><span style=display:flex><span>	Slave  :local:powertop
</span></span></code></pre></div><h2 id=group-section>Group section</h2><p>Note that we don&rsquo;t need any <code>Group gmail</code> section. We could have, but
as <code>~/bin/pollmail.sh</code> iterates over the Channels anyway, there&rsquo;s no
need for one.</p></div></div></div><script src=../../js/ui.js></script>
<script src=../../js/menus.js></script>
<script src=../../js/math-code.js></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>